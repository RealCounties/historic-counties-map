<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Historic Counties Interactive Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Leaflet + Libraries -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/polylabel@1.0.3/polylabel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

<style>
/* === LIGHT MODE (default) === */
:root {
  --bg: #faf4e6;
  --card-bg: #f3e9da;
  --text: #333;
  --border: #ccc;
  --shadow: rgba(0,0,0,0.2);
  --accent: #9B2C2C;
  --tooltip-bg: rgba(255,255,255,0.9);
}
/* === DARK MODE === */
.dark-mode {
  --bg: #1a1a1a;
  --card-bg: #2d2d2d;
  --text: #e0e0e0;
  --border: #444;
  --shadow: rgba(0,0,0,0.4);
  --accent: #d32f2f;
  --tooltip-bg: rgba(30,30,30,0.9);
}
.dark-mode #sidebar { background: var(--bg); color: var(--text); }
.dark-mode .county-card { background: var(--card-bg); box-shadow: 0 2px 6px var(--shadow); }
.dark-mode .leaflet-tooltip { background: var(--tooltip-bg); border-color: #666; color: #fff; }

/* === BASE STYLES === */
html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
#container { display:flex; height:100%; }
#logo-container { text-align:center; margin-bottom:10px; }
#sidebar-logo {
  max-width:100%; height:auto; display:block; margin:0 auto;
  opacity:0; transform:scale(0.9);
  animation:logoLoad 1.4s ease-out forwards;
}
@keyframes logoLoad {
  0%   { opacity:0; transform:scale(0.9) translateY(10px); }
  60%  { opacity:1; transform:scale(1.02); }
  100% { opacity:1; transform:scale(1); }
}
#logo-link { display:block; transition:opacity .25s ease; }
#logo-link:hover { opacity:.85; }

/* Sidebar */
#sidebar {
  width:340px; background:var(--bg); padding:15px; overflow-y:auto;
  border-right:1px solid var(--border); transition:all .3s ease; position:relative;
  color:var(--text);
}

/* Search */
#search-bar { margin-top:15px; display:flex; gap:6px; align-items:center; justify-content:center; }
#search-bar input {
  flex:1; min-width:140px; padding:10px 12px; border:1px solid var(--border);
  border-radius:4px; font-size:.9rem; color:var(--text); background:#fff;
  box-shadow:0 2px 4px var(--shadow); transition:all .25s;
}
#search-bar input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(155,44,44,.2); }
#search-bar button {
  padding:10px 18px; background:var(--accent); color:#FAF4E6; border:none; border-radius:4px;
  font-weight:500; box-shadow:0 3px 6px var(--shadow); cursor:pointer;
  transition:all .25s cubic-bezier(.4,0,.2,1);
}
#search-bar button:hover { background:#7a2222; transform:translateY(-2px) scale(1.05); box-shadow:0 6px 14px var(--shadow); }

/* Map */
#map { flex:1; }

/* County Card */
.county-card {
  background:var(--card-bg); padding:14px; border-radius:10px;
  box-shadow:0 2px 6px var(--shadow); transition:all .3s ease; cursor:pointer;
  position:relative;
}
.county-card:hover { transform:translateY(-6px); box-shadow:0 8px 18px var(--shadow); }
.county-card h3 { margin:0 0 10px; font-size:1.15rem; color:var(--text); }
.county-card p { margin:6px 0; }
.county-card a { color:#0066cc; text-decoration:none; }
.county-card a:hover { text-decoration:underline; }

/* Weather Badge */
.weather-badge {
  position:absolute; top:8px; right:8px; font-size:0.8rem; background:rgba(0,0,0,0.1);
  padding:4px 8px; border-radius:12px; font-weight:500;
}

/* Tooltip */
.leaflet-tooltip.county-tooltip {
  background:var(--tooltip-bg); border:1px solid var(--accent); color:var(--text);
  font-weight:bold; padding:2px 6px; border-radius:4px;
}

/* Close Button */
#closeSidebar {
  display:none; position:absolute; top:10px; right:12px; width:32px; height:32px;
  font-size:20px; color:#666; background:rgba(255,255,255,0.9); border:none;
  border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;
}
#closeSidebar:hover { background:#fff; }

/* Dark Mode Toggle */
#darkModeToggle {
  background:var(--accent); color:white; border:none; width:36px; height:36px;
  border-radius:50%; cursor:pointer; font-size:18px; z-index:1001;
}

/* === RESPONSIVE: Bottom-Left Panel === */
@media (max-width:1024px) {
  #container { flex-direction:column; }
  #sidebar {
    position:fixed; bottom:16px; left:16px; width:45vw; max-width:380px;
    max-height:50vh; background:var(--bg); border-radius:14px;
    box-shadow:0 6px 20px var(--shadow); padding:14px; overflow-y:auto;
    transform:translateY(120%); transition:transform .32s cubic-bezier(.4,0,.2,1);
    z-index:1000; display:block !important; font-size:.94rem;
  }
  #sidebar.visible { transform:translateY(0); }
  #map { height:100vh !important; }
  #sidebar-logo { max-width:65%; }
}
@media (max-width:480px) {
  #sidebar { width:90vw; left:5vw; max-width:none; }
  #sidebar-logo { max-width:55%; }
}
#sidebar h2 { text-align:center; margin:5px 0 10px; color:var(--accent); }
</style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <button id="closeSidebar">x</button>
    <div id="logo-container">
      <a href="https://realcounties.com" target="_blank" rel="noopener" id="logo-link">
        <img src="https://realcounties.wordpress.com/wp-content/uploads/2025/06/logo-full-trans-16-6-25.png"
             alt="Campaign for Historic Counties Logo"
             id="sidebar-logo">
      </a>
    </div>
    <h2>Interactive Map</h2>
    <p>Select a county to view details.</p>
    <div id="info"><em>Loading counties...</em></div>
    <div id="search-bar">
      <input type="text" id="placeSearch" placeholder="Search for a place...">
      <button id="searchBtn">Search</button>
    </div>
    <div id="searchDropdown" style="
      position: absolute; background: white; border: 1px solid #ccc;
      max-height: 200px; overflow-y: auto; width: calc(100% - 60px);
      display: none; z-index: 1001; margin-top: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    "></div>
  </div>
  <div id="map"></div>
</div>

<script>
window.onload = function() {
  const sidebar = document.getElementById('sidebar');
  const closeBtn = document.getElementById('closeSidebar');
  const infoDiv = document.getElementById('info');
  const searchInput = document.getElementById('placeSearch');
  const searchDropdown = document.getElementById('searchDropdown');

  // -----------------------------
  // Initialize map
  // -----------------------------
  const map = L.map('map', { center: [54.5, -3], zoom: 6, minZoom: 5 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> contributors | <a href="https://county-borders.co.uk" target="_blank">Historic County Borders Project</a>',
    maxZoom: 19
  }).addTo(map);
  const ukBounds = L.latLngBounds([49.5, -8.5], [60.9, 2.0]);
  map.setMaxBounds(ukBounds);
  map.fitBounds(ukBounds);

  // -----------------------------
  // Toggle button (mobile)
  // -----------------------------
  const toggleButton = L.control({ position: 'topright' });
  toggleButton.onAdd = function() {
    const btn = L.DomUtil.create('button', 'leaflet-bar');
    btn.innerHTML = 'Info';
    btn.title = 'Show county info';
    btn.style.cssText = 'background:white; border:1px solid #999; width:34px; height:34px; font-size:18px; cursor:pointer; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,0.3);';
    btn.onclick = () => sidebar.classList.toggle('visible');
    return btn;
  };
  toggleButton.addTo(map);
  closeBtn.onclick = () => sidebar.classList.remove('visible');

  // === 1. WEATHER ===
  const WEATHER_API_KEY = 'YOUR_API_KEY_HERE'; // ← REPLACE!
  async function fetchWeather(countyName) {
    try {
      const res = await axios.get(`https://api.openweathermap.org/data/2.5/weather`, {
        params: { q: countyName + ',UK', appid: WEATHER_API_KEY, units: 'metric' }
      });
      const temp = Math.round(res.data.main.temp);
      const desc = res.data.weather[0].description;
      return { temp, desc };
    } catch (e) { return null; }
  }

  // === 2. UPDATE COUNTY CARD (with weather, zoom, highlight, photo) ===
  let currentLayer = null;
  let photoTimeout;
  function updateCountyCard(englishName, layer) {
    const details = countyData[englishName] || {};
    const native = nativeNames[englishName] || null;
    const events = details.events || [];
    const landmarks = details.landmarks || [];

    fetchWeather(englishName).then(weather => {
      const weatherHtml = weather
        ? `<div class="weather-badge">${weather.temp}°C • ${weather.desc}</div>`
        : '';

      infoDiv.innerHTML = `
        <div class="county-card">
          ${weatherHtml}
          <button id="closeSidebar">x</button>
          <h3>${englishName}</h3>
          ${native ? `<p><strong>Native:</strong> ${native}</p>` : ''}
          <p><strong>Area:</strong> ${details.area || 'Unknown'}</p>
          <p><strong>Population:</strong> ${details.population || 'Unknown'}</p>
          ${events.length ? `<h4>Events</h4><ul>${events.map(e=>`<li>${e}</li>`).join('')}</ul>` : ''}
          ${landmarks.length ? `<h4>Landmarks</h4><ul>${landmarks.map(l=>`<li onmouseover="showPhoto('${l}', event)" onmouseout="hidePhoto()">${l}</li>`).join('')}</ul>` : ''}
        </div>`;

      document.getElementById('closeSidebar')?.addEventListener('click', () => sidebar.classList.remove('visible'));
    });

    if (currentLayer) currentLayer.setStyle({ weight: 1, fillOpacity: 0.35 });
    layer.setStyle({ weight: 3, fillOpacity: 0.6 });
    currentLayer = layer;
  }

  // === 3. PHOTO PREVIEW ===
  function showPhoto(landmark, e) {
    clearTimeout(photoTimeout);
    const img = document.createElement('img');
    img.src = `https://source.unsplash.com/400x300/?${encodeURIComponent(landmark + ' UK')}`;
    img.style.cssText = 'position:absolute; top:'+(e.clientY+10)+'px; left:'+(e.clientX+10)+'px; width:200px; height:auto; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:10000;';
    img.onload = () => document.body.appendChild(img);
    window.photoImg = img;
  }
  function hidePhoto() {
    photoTimeout = setTimeout(() => {
      if (window.photoImg) { document.body.removeChild(window.photoImg); delete window.photoImg; }
    }, 300);
  }

  // === 4. DARK MODE TOGGLE ===
  const darkToggle = L.control({position: 'topright'});
  darkToggle.onAdd = () => {
    const btn = L.DomUtil.create('button', 'leaflet-bar');
    btn.id = 'darkModeToggle';
    btn.innerHTML = 'Dark Mode';
    btn.title = 'Toggle dark mode';
    btn.onclick = () => document.body.classList.toggle('dark-mode');
    return btn;
  };
  darkToggle.addTo(map);
// -----------------------------
// County data (with events + landmarks)
// -----------------------------
const countyData = {
  "Aberdeenshire": { 
    area: "1,950 sq mi", population: "380,495", 
    events: ["Battle of Harlaw (1411): Clan battle that halted Highland expansion into Lowlands.", "Gordon Riots (1689): Jacobite uprising against William III.", "Founding of Aberdeen University (1495) by Bishop Elphinstone."],
    landmarks: ["Slains Castle", "Balmoral Castle (Royal residence)", "Dunnottar Castle"]
  },
  "Anglesey": { 
    area: "277 sq mi", population: "69,751", 
    events: ["Roman invasion repelled by druids (60 AD) at Mona.", "Owain Gwynedd's victory over Normans (1138).", "Llyn Peninsula Druid uprising crushed (78 AD)."],
    landmarks: ["Beaumaris Castle", "South Stack Lighthouse", "Menai Suspension Bridge"]
  },
  "Angus": { 
    area: "899 sq mi", population: "264,044", 
    events: ["Battle of Dunnichen (685 AD): Picts defeat Northumbrians.", "Forfar Witch Trials (1597): Mass executions during witch hunts.", "Dunnottar Castle siege (1651) during Civil War."],
    landmarks: ["Glamis Castle", "Arbroath Abbey", "Bell Rock Lighthouse"]
  },
  "Antrim": { 
    area: "1,175 sq mi", population: "615,701", 
    events: ["Battle of Antrim (1798): United Irishmen rebellion against British.", "Plantation of Ulster begins (1609) with Scottish settlers.", "Giants Causeway mythologized in Irish folklore (pre-1700s)."],
    landmarks: ["Giant's Causeway (UNESCO)", "Carrickfergus Castle", "Dunluce Castle"]
  },
  "Argyllshire": { 
    area: "3,110 sq mi", population: "64,819", 
    events: ["Battle of Red Ford (1150): Somerled defeats Scots, founding Clan Donald.", "Massacre of Glencoe (1692): Campbell betrayal of MacDonalds.", "Iona Abbey founded (563 AD) by St. Columba."],
    landmarks: ["Iona Abbey", "Inveraray Castle", "Oban Distillery"]
  },
  "Armagh": { 
    area: "512 sq mi", population: "178,598", 
    events: ["St. Patrick's Cathedral founded (445 AD).", "Battle of the Yellow Ford (1598): Hugh O'Neill defeats English.", "Armagh Observatory established (1790)."],
    landmarks: ["Armagh Cathedral (St. Patrick’s)", "Navan Fort (Emain Macha)", "Armagh Planetarium"]
  },
  "Ayrshire": { 
    area: "1,129 sq mi", population: "367,676", 
    events: ["Battle of Largs (1263): Scots defeat Vikings, ending Norse rule.", "Burns' Alloway cottage (1759): Robert Burns birthplace.", "Covenanter resistance at Drumclog (1679)."],
    landmarks: ["Culzean Castle", "Burns Cottage", "Ailsa Craig"]
  },
  "Banffshire": { 
    area: "641 sq mi", population: "46,537", 
    events: ["Cullen House built (1543) as Renaissance seat.", "Whisky distilleries boom (1820s) in Speyside region.", "Jacobite rising support (1745)."],
    landmarks: ["Glenfiddich Distillery", "Duff House", "Balvenie Castle"]
  },
  "Bedfordshire": { 
    area: "468 sq mi", population: "602,847", 
    events: ["Bunyan imprisoned in Bedford (1660), writes Pilgrim's Progress.", "Battle of Cardigan (1645) in Civil War.", "Woburn Abbey founded (1145)."],
    landmarks: ["Woburn Abbey & Safari Park", "Bedford Castle Mound", "Whipsnade Zoo"]
  },
  "Berkshire": { 
    area: "722 sq mi", population: "842,804", 
    events: ["Battle of Reading (871): Alfred the Great defeats Vikings.", "Windsor Castle construction begins (1070).", "Ascot Racecourse founded (1711)."],
    landmarks: ["Windsor Castle", "Ascot Racecourse", "Legoland Windsor"]
  },
  "Berwickshire": { 
    area: "457 sq mi", population: "26,458", 
    events: ["Flodden Field aftermath (1513): Borders ravaged post-battle.", "Coldingham Priory sacked by Vikings (870).", "Union of Crowns (1603) impacts border raids."],
    landmarks: ["Paxton House", "Duns Castle", "St Abb’s Head"]
  },
  "Brecknockshire": { 
    area: "742 sq mi", population: "67,598", 
    events: ["Norman conquest of Brycheiniog (1093).", "Owain Glyndŵr's rebellion spreads here (1400).", "Brecon Cathedral founded (1093)."],
    landmarks: ["Brecon Beacons Waterfalls", "Brecon Cathedral", "Llangorse Lake"]
  },
  "Buckinghamshire": { 
    area: "746 sq mi", population: "916,903", 
    events: ["Battle of Stony Stratford (1460) in Wars of Roses.", "Milton writes Paradise Lost at Chalfont (1667).", "Bletchley Park codebreaking (WWII, 1939-45)."],
    landmarks: ["Bletchley Park (WWII Codebreaking)", "Stowe House", "Eton College"]
  },
  "Buteshire": { 
    area: "225 sq mi", population: "12,534", 
    events: ["Rothesay Castle siege (1401) by Robert III.", "James II assassination plot uncovered (1451).", "Bute Highland Games origins (1800s)."],
    landmarks: ["Rothesay Castle", "Mount Stuart House", "Bute Museum"]
  },
  "Caernarfonshire": { 
    area: "563 sq mi", population: "139,065", 
    events: ["Edward I's castle built (1283).", "Owain Glyndŵr proclaimed Prince (1404).", "Investiture of Prince Charles (1969)."],
    landmarks: ["Caernarfon Castle (UNESCO)", "Snowdon (Yr Wyddfa)", "Llanberis Slate Museum"]
  },
  "Caithness": { 
    area: "618 sq mi", population: "26,486", 
    events: ["Norse earldom established (871).", "Battle of Altimarlach (1680): Clan Campbell vs. Sinclair.", "John o' Groats legend (c.1500)."],
    landmarks: ["Castle of Mey", "John o’ Groats Signpost", "Dounreay Nuclear Site"]
  },
  "Cambridgeshire": { 
    area: "858 sq mi", population: "460,448", 
    events: ["University founded (1209) after Oxford expulsion.", "Oliver Cromwell's farm in Huntingdon (1599 birth).", "Battle of Fornham (1173)."],
    landmarks: ["King’s College Chapel", "Ely Cathedral", "The Backs"]
  },
  "Cardiganshire": { 
    area: "693 sq mi", population: "75,784", 
    events: ["Aberystwyth Castle built (1277) by Edward I.", "Welsh literary revival at Lampeter (1810s).", "Owain Glyndŵr support (1400)."],
    landmarks: ["Aberystwyth Castle", "Devil’s Bridge", "Strata Florida Abbey"]
  },
  "Carmarthenshire": { 
    area: "937 sq mi", population: "184,232", 
    events: ["Kidwelly Castle siege by Glyndŵr (1403).", "Rebecca Riots against tolls (1839-43).", "Carreg Cennen Castle falls (1277)."],
    landmarks: ["Carreg Cennen Castle", "Laugharne Castle", "National Botanic Garden of Wales"]
  },
  "Cheshire": { 
    area: "1,035 sq mi", population: "1,668,894", 
    events: ["Civil War sieges at Chester (1642-46).", "Salt mines boom (medieval).", "Beeston Castle built (1220)."],
    landmarks: ["Chester Cathedral", "Beeston Castle", "Jodrell Bank Observatory"]
  },
  "Clackmannanshire": { 
    area: "48 sq mi", population: "50,957", 
    events: ["Alloa Tower built (14th c.) as Stewart seat.", "Battle of Sauchieburn (1488) aftermath.", "Forth & Clyde Canal opens (1790)."],
    landmarks: ["Alloa Tower", "Gartmorn Dam", "Dollar Glen"]
  },
  "Cornwall": { 
    area: "1,365 sq mi", population: "533,594", 
    events: ["Prayer Book Rebellion (1549).", "Tin mining peaks (18th c.).", "Eden Project roots in mining history (2000s)."],
    landmarks: ["St Michael’s Mount", "Eden Project", "Tintagel Castle"]
  },
  "Cromartyshire": { 
    area: "370 sq mi", population: "7,074", 
    events: ["Hugh Miller's fossil discoveries (1820s).", "Jacobite support at Cromarty (1745).", "Forfeited estates auctioned (1690)."],
    landmarks: ["Cromarty Courthouse", "Hugh Miller’s Cottage", "Invergordon Naval Base"]
  },
  "Cumberland": { 
    area: "1,525 sq mi", population: "306,241", 
    events: ["Border Reivers raids (16th c.).", "Wordsworth's Lake District poems (1790s).", "Carlisle Castle sieges (Civil War)."],
    landmarks: ["Carlisle Castle", "Hadrian’s Wall (UNESCO)", "Scafell Pike"]
  },
  "Denbighshire": { 
    area: "668 sq mi", population: "227,680", 
    events: ["Owain Glyndŵr's parliament at Harlech (1404, nearby).", "Denbigh Castle falls to Parliamentarians (1646).", "Llangollen Eisteddfod founded (1946)."],
    landmarks: ["Denbigh Castle", "Pontcysyllte Aqueduct (UNESCO)", "Llangollen Railway"]
  },
  "Derbyshire": { 
    area: "1,017 sq mi", population: "1,148,373", 
    events: ["Peak District lead mining (Roman era).", "Chatsworth House built (1553).", "Cromford Mill (1769): Industrial Revolution start."],
    landmarks: ["Chatsworth House", "Cromford Mill (UNESCO)", "Peak District Caves"]
  },
  "Devon": { 
    area: "2,621 sq mi", population: "1,133,463", 
    events: ["Spanish Armada wrecks (1588).", "Drake's circumnavigation from Plymouth (1577).", "Exeter Civil War siege (1646)."],
    landmarks: ["Dartmoor National Park", "Plymouth Hoe", "Exeter Cathedral"]
  },
  "Dorset": { 
    area: "1,005 sq mi", population: "543,296", 
    events: ["Cerne Abbas Giant carved (pre-1000).", "Portland Stone quarried for St. Paul's (17th c.).", "Hardy's Wessex novels set here (late 1800s)."],
    landmarks: ["Durdlestone Head", "Cerne Abbas Giant", "Lulworth Cove"]
  },
  "Down": { 
    area: "950 sq mi", population: "528,983", 
    events: ["St. Patrick lands at Saul (432 AD).", "Battle of the Boyne (1690) nearby.", "Downpatrick Cathedral founded (12th c.)."],
    landmarks: ["Mourne Mountains", "Downpatrick Cathedral", "Scrabo Tower"]
  },
  "Dumfriesshire": { 
    area: "1,063 sq mi", population: "77,160", 
    events: ["Burns' 'Auld Lang Syne' written (1788).", "Solway Moss Battle (1542): English capture James V.", "Devorgilla Bridge built (1270)."],
    landmarks: ["Caerlaverock Castle", "Devorgilla Bridge", "Sweetheart Abbey"]
  },
  "Dunbartonshire": { 
    area: "241 sq mi", population: "262,419", 
    events: ["Dumbarton Castle siege by Vikings (870).", "Battle of Langside (1568): Mary Queen of Scots defeat.", "Vale of Leven textiles boom (1800s)."],
    landmarks: ["Dumbarton Castle", "Loch Lomond", "Hill House (Mackintosh)"]
  },
  "Durham": { 
    area: "1,022 sq mi", population: "1,467,037", 
    events: ["Prince Bishops' palatinate (11th c.).", "Battle of Neville's Cross (1346).", "Durham Cathedral built (1093)."],
    landmarks: ["Durham Cathedral (UNESCO)", "Beamish Museum", "Castle Eden Dene"]
  },
  "East Lothian": { 
    area: "267 sq mi", population: "74,882", 
    events: ["Battle of Dunbar (1650): Cromwell defeats Scots.", "Prestonpans Battle (1745): Jacobite victory.", "Traprain Law treasure hoard (5th c.)."],
    landmarks: ["Tantallon Castle", "Dirleton Castle", "Bass Rock"]
  },
  "Essex": { 
    area: "1,591 sq mi", population: "2,999,248", 
    events: ["Battle of Maldon (991): Viking defeat.", "Witch trials at Chelmsford (16th c.).", "Tilbury Speech by Elizabeth I (1588)."],
    landmarks: ["Colchester Castle", "Audley End House", "Southend Pier"]
  },
  "Fermanagh": { 
    area: "715 sq mi", population: "61,170", 
    events: ["Enniskillen Castle founded (1611).", "Williamite War sieges (1689).", "Lough Erne monastic sites (6th c.)."],
    landmarks: ["Enniskillen Castle", "Devenish Island", "Marble Arch Caves"]
  },
  "Fife": { 
    area: "504 sq mi", population: "365,493", 
    events: ["Dunfermline Abbey: Robert the Bruce buried (1329).", "St. Andrews founded (1413).", "Culross Palace built (1590s)."],
    landmarks: ["St Andrews Cathedral", "Falkland Palace", "Culross Palace"]
  },
  "Flintshire": { 
    area: "260 sq mi", population: "215,390", 
    events: ["Flint Castle built by Edward I (1277).", "Mostyn Colliery disaster (1812).", "Holywell St. Winifred's Well (7th c.)."],
    landmarks: ["Flint Castle", "St Winifred’s Well", "Greenfield Valley"]
  },
  "Glamorgan": { 
    area: "827 sq mi", population: "1,321,460", 
    events: ["Norman castles built (1080s).", "Chartist uprising at Newport (1839, nearby).", "Cardiff Castle rebuilt (1860s)."],
    landmarks: ["Cardiff Castle", "Castell Coch", "National Museum Cardiff"]
  },
  "Gloucestershire": { 
    area: "1,293 sq mi", population: "1,147,106", 
    events: ["Battle of Tewkesbury (1471): Wars of Roses.", "Cotswold wool trade boom (15th c.).", "Berkeley Castle: Edward II murdered (1327)."],
    landmarks: ["Gloucester Cathedral", "Berkeley Castle", "Cotswold Way"]
  },
  "Hampshire": { 
    area: "1,656 sq mi", population: "2,099,640", 
    events: ["Battle of Hastings prep (1066).", "Jane Austen novels set here (early 1800s).", "Portsmouth Naval Base founded (1494)."],
    landmarks: ["Portsmouth Historic Dockyard", "Winchester Cathedral", "New Forest"]
  },
  "Herefordshire": { 
    area: "837 sq mi", population: "183,631", 
    events: ["Offa's Dyke built (8th c.).", "Mortimer's Cross Battle (1461).", "Ledbury Charter granted (1230)."],
    landmarks: ["Hereford Cathedral (Mappa Mundi)", "Goodrich Castle", "Black and White Villages"]
  },
  "Hertfordshire": { 
    area: "633 sq mi", population: "1,157,166", 
    events: ["Battle of St Albans (1455): Wars of Roses.", "Knebworth Festival origins (1974).", "Royston Cave discovered (1740)."],
    landmarks: ["Hatfield House", "St Albans Cathedral", "Warner Bros. Studio Tour"]
  },
  "Huntingdonshire": { 
    area: "366 sq mi", population: "211,776", 
    events: ["Cromwell's birthplace (1599).", "Battle of Naseby (1645) nearby.", "Ouse Valley fens drained (17th c.)."],
    landmarks: ["Hinchingbrooke House", "Huntingdon Cromwell Museum", "Grafham Water"]
  },
  "Inverness-shire": { 
    area: "4,211 sq mi", population: "118,077", 
    events: ["Culloden Battle (1746): Jacobite defeat.", "Fort William built (1690).", "Loch Ness Monster sightings (6th c. folklore)."],
    landmarks: ["Loch Ness", "Urquhart Castle", "Eilean Donan Castle"]
  },
  "Kent": { 
    area: "1,611 sq mi", population: "2,747,715", 
    events: ["Battle of Hastings (1066).", "Canterbury Cathedral sacked (1011).", "Cinque Ports formed (11th c.)."],
    landmarks: ["Canterbury Cathedral (UNESCO)", "Leeds Castle", "White Cliffs of Dover"]
  },
  "Kincardineshire": { 
    area: "380 sq mi", population: "77,670", 
    events: ["Dunnottar Castle defense (1652).", "Stonehaven Tolbooth built (1600).", "Arbuthnott Pursuivant heraldry (1867)."],
    landmarks: ["Dunnottar Castle", "Stonehaven Harbour", "Fetteresso Castle"]
  },
  "Kinross-shire": { 
    area: "73 sq mi", population: "11,223", 
    events: ["Loch Leven Castle: Mary Queen escape (1568).", "Kinross House built (1680s).", "Portmoak Airfield WWII use."],
    landmarks: ["Loch Leven Castle", "Kinross House", "Loch Leven"]
  },
  "Kirkcudbrightshire": { 
    area: "899 sq mi", population: "47,546", 
    events: ["Sweetheart Abbey founded (1273).", "Covenanter martyrdoms (1660s).", "Galloway cattle trade (18th c.)."],
    landmarks: ["Threave Castle", "Sweetheart Abbey", "Broughton House"]
  },
  "Lanarkshire": { 
    area: "879 sq mi", population: "1,008,014", 
    events: ["Battle of Bothwell Bridge (1679): Covenanters defeated.", "Glasgow founded (1450).", "New Lanark mills (1800): Utopian experiment."],
    landmarks: ["New Lanark (UNESCO)", "Chatelherault Country Park", "Bothwell Castle"]
  },
  "Lancashire": { 
    area: "1,909 sq mi", population: "4,942,364", 
    events: ["Pendle Witch Trials (1612).", "Peterloo Massacre (1819).", "Liverpool slave trade peak (18th c.)."],
    landmarks: ["Blackpool Tower", "Liverpool Docks (UNESCO)", "Lancaster Castle"]
  },
  "Leicestershire": { 
    area: "836 sq mi", population: "975,403", 
    events: ["Battle of Bosworth (1485): Richard III killed.", "Lady Jane Grey executed (1554).", "Rutland Water created (1975)."],
    landmarks: ["Bosworth Battlefield", "Belvoir Castle", "National Space Centre"]
  },
  "Lincolnshire": { 
    area: "2,687 sq mi", population: "1,038,510", 
    events: ["Battle of Stamford Bridge (1066) prep.", "Lincoln Cathedral built (1075).", "Danelaw borders established (9th c.)."],
    landmarks: ["Lincoln Cathedral", "Tattershall Castle", "The Wash"]
  },
  "Londonderry": { 
    area: "816 sq mi", population: "247,971", 
    events: ["Siege of Derry (1689): Apprentice Boys resist.", "City walls built (1613).", "Bloody Sunday (1972)."],
    landmarks: ["Derry City Walls", "Guildhall", "Peace Bridge"]
  },
  "Merionethshire": { 
    area: "676 sq mi", population: "37,874", 
    events: ["Harlech Castle siege (1294).", "Glyndŵr's parliament (1404).", "Bala Lake railway (1865)."],
    landmarks: ["Harlech Castle (UNESCO)", "Portmeirion Village", "Cader Idris"]
  },
  "Middlesex": { 
    area: "285 sq mi", population: "4,000,927", 
    events: ["Hampton Court Conference (1604).", "Tyburn gallows executions (1196-1783).", "Heathrow Airport opens (1946)."],
    landmarks: ["Hampton Court Palace", "Kew Gardens (UNESCO)", "Wembley Stadium"]
  },
  "Midlothian": { 
    area: "362 sq mi", population: "621,610", 
    events: ["Battle of Roslin (1303).", "Edinburgh founded as burgh (1125).", "Holyrood Palace built (1529)."],
    landmarks: ["Edinburgh Castle", "Scottish Parliament", "Rosslyn Chapel"]
  },
  "Monmouthshire": { 
    area: "542 sq mi", population: "514,723", 
    events: ["Chartist March (1839): 20,000 protest for rights.", "Tintern Abbey founded (1131).", "Owain Glyndŵr uprising (1400)."],
    landmarks: ["Tintern Abbey", "Raglan Castle", "Big Pit Mining Museum"]
  },
  "Montgomeryshire": { 
    area: "796 sq mi", population: "61,956", 
    events: ["Battle of Montgomery (1644): Civil War.", "Powys Castle origins (11th c.).", "Offa's Dyke section (8th c.)."],
    landmarks: ["Powis Castle", "Montgomery Castle", "Lake Vyrnwy"]
  },
  "Morayshire": { 
    area: "476 sq mi", population: "67,654", 
    events: ["Spynie Palace seat of bishops (12th c.).", "Battle of Urquhart (1544).", "Elgin Cathedral burned (1390)."],
    landmarks: ["Elgin Cathedral", "Pluscarden Abbey", "Duffus Castle"]
  },
  "Nairnshire": { 
    area: "200 sq mi", population: "13,894", 
    events: ["Cawdor Castle witches' folklore (Shakespeare, 1606).", "Nairn viaduct built (1860).", "Culloden impacts (1746)."],
    landmarks: ["Cawdor Castle", "Nairn Museum", "Nairn Viaduct"]
  },
  "Norfolk": { 
    area: "2,057 sq mi", population: "807,721", 
    events: ["Battle of Forncett (1075).", "Norwich Castle built (1067).", "Kett's Rebellion (1549)."],
    landmarks: ["Norwich Cathedral", "Sandringham Estate", "Holkham Hall"]
  },
  "Northamptonshire": { 
    area: "998 sq mi", population: "838,786", 
    events: ["Battle of Northampton (1460): Wars of Roses.", "Althorp House (1508).", "Naseby Battle nearby (1645)."],
    landmarks: ["Althorp (Diana’s Grave)", "Rockingham Castle", "Silverstone Circuit"]
  },
  "Northumberland": { 
    area: "2,019 sq mi", population: "797,006", 
    events: ["Flodden Field (1513): Scots defeated.", "Hadrian's Wall built (122 AD).", "Border Reivers era (13th-17th c.)."],
    landmarks: ["Hadrian’s Wall (UNESCO)", "Alnwick Castle", "Lindisfarne"]
  },
  "Nottinghamshire": { 
    area: "843 sq mi", population: "1,096,617", 
    events: ["Robin Hood legends (12th c.).", "Sherwood Forest outlaws.", "Luddite riots (1811)."],
    landmarks: ["Sherwood Forest", "Nottingham Castle", "Wollaton Hall"]
  },
  "Orkney": { 
    area: "376 sq mi", population: "21,349", 
    events: ["Norse earldom (875).", "St. Magnus Cathedral founded (1137).", "Scapa Flow scuttling (1919)."],
    landmarks: ["Skara Brae (UNESCO)", "St Magnus Cathedral", "Ring of Brodgar"]
  },
  "Oxfordshire": { 
    area: "754 sq mi", population: "512,345", 
    events: ["University riots (1209).", "Civil War siege (1646).", "Bladon Churchill grave (1965)."],
    landmarks: ["Oxford University", "Blenheim Palace (UNESCO)", "Christ Church Cathedral"]
  },
  "Peeblesshire": { 
    area: "548 sq mi", population: "19,074", 
    events: ["Traquair House oldest house (1100).", "Neidpath Castle Jacobite (1715).", "Tweeddale wool trade."],
    landmarks: ["Traquair House", "Neidpath Castle", "Stobo Castle"]
  },
  "Pembrokeshire": { 
    area: "625 sq mi", population: "122,122", 
    events: ["Norman invasion (1093).", "Carew Castle founded (1270).", "Preseli Hills: Stonehenge bluestones (2500 BC)."],
    landmarks: ["St Davids Cathedral", "Pembroke Castle", "Pembrokeshire Coast Path"]
  },
  "Perthshire": { 
    area: "2,493 sq mi", population: "156,371", 
    events: ["Battle of Killiecrankie (1689).", "Scone Palace: Stone of Destiny (1296).", "Tay Rail Bridge collapse (1879)."],
    landmarks: ["Scone Palace", "Blair Castle", "Loch Tay"]
  },
  "Radnorshire": { 
    area: "470 sq mi", population: "25,821", 
    events: ["Offa's Dyke (8th c.).", "Radnor Forest drovers' paths.", "Llywelyn's resistance (1282)."],
    landmarks: ["Offa’s Dyke Path", "Radnor Forest", "Llandrindod Wells"]
  },
  "Renfrewshire": { 
    area: "245 sq mi", population: "508,064", 
    events: ["Paisley Abbey founded (1163).", "Thread mills boom (1800s).", "Battle of Renfrew (1164)."],
    landmarks: ["Paisley Abbey", "Coats Observatory", "Weaver’s Cottage"]
  },
  "Ross-shire": { 
    area: "3,089 sq mi", population: "69,503", 
    events: ["Battle of Harpsdale (1429).", "Culloden Moor (1746).", "Eilean Donan Castle rebuilt (1911)."],
    landmarks: ["Eilean Donan Castle", "Beinn Eighe", "Inverewe Garden"]
  },
  "Roxburghshire": { 
    area: "666 sq mi", population: "50,800", 
    events: ["Flodden Field (1513).", "Kelso Abbey founded (1128).", "Reivers' borders (16th c.)."],
    landmarks: ["Floors Castle", "Kelso Abbey", "Jedburgh Abbey"]
  },
  "Rutland": { 
    area: "152 sq mi", population: "37,677", 
    events: ["Oakham Castle founded (12th c.).", "Burley on the Hill hunt (1600s).", "Smallest county status (pre-1974)."],
    landmarks: ["Rutland Water", "Oakham Castle", "Barnsdale Gardens"]
  },
  "Selkirkshire": { 
    area: "267 sq mi", population: "16,010", 
    events: ["Ettrick Shepherd tales (1800s).", "Yarrow Water folklore.", "Commonwealth Games origins (1930s)."],
    landmarks: ["Bowhill House", "Philiphaugh Battlefield", "Loch of the Lowes"]
  },
  "Shetland": { 
    area: "551 sq mi", population: "23,167", 
    events: ["Norse takeover (800 AD).", "Up Helly Aa fire festival (1880).", "Fair Isle knitting (16th c.)."],
    landmarks: ["Jarlshof (UNESCO)", "Shetland Museum", "Mousa Broch"]
  },
  "Shropshire": { 
    area: "1,342 sq mi", population: "472,027", 
    events: ["Buildwas Abbey founded (1160).", "Shrewsbury Castle (1067).", "Clun Castle Marcher lord (12th c.)."],
    landmarks: ["Ironbridge Gorge (UNESCO)", "Shrewsbury Castle", "Ludlow Castle"]
  },
  "Somerset": { 
    area: "1,633 sq mi", population: "1,053,504", 
    events: ["Battle of Sedgemoor (1685): Monmouth Rebellion.", "Glastonbury Abbey legend (Arthurian).", "Sedgemoor drainage (18th c.)."],
    landmarks: ["Glastonbury Tor", "Wells Cathedral", "Cheddar Gorge"]
  },
  "Staffordshire": { 
    area: "1,176 sq mi", population: "2,159,392", 
    events: ["Wedgwood pottery founded (1759).", "Battle of Hopton Heath (1643).", "Trent and Mersey Canal (1770)."],
    landmarks: ["Alton Towers", "Lichfield Cathedral", "Trentham Estate"]
  },
  "Stirlingshire": { 
    area: "447 sq mi", population: "244,092", 
    events: ["Battle of Stirling Bridge (1297): Wallace victory.", "Bannockburn (1314): Bruce defeats English.", "Wallace Monument (1869)."],
    landmarks: ["Stirling Castle", "Bannockburn Battlefield", "Wallace Monument"]
  },
  "Suffolk": { 
    area: "1,505 sq mi", population: "775,099", 
    events: ["Wool trade boom (12th c.).", "Orford Ness WWII testing.", "Sutton Hoo ship burial (625 AD)."],
    landmarks: ["Sutton Hoo (UNESCO)", "Framlingham Castle", "Southwold Pier"]
  },
  "Surrey": { 
    area: "759 sq mi", population: "2,975,836", 
    events: ["Runnymede Magna Carta (1215).", "Box Hill literary picnics (1800s).", "Woking Veloodrome (2020)."],
    landmarks: ["Runnymede (Magna Carta)", "Hampton Court Palace", "Brooklands Museum"]
  },
  "Sussex": { 
    area: "1,466 sq mi", population: "1,612,454", 
    events: ["Battle of Hastings (1066).", "Arundel Castle founded (1067).", "Battle of Beachy Head (1690)."],
    landmarks: ["Battle Abbey", "Arundel Castle", "Brighton Pavilion"]
  },
  "Sutherland": { 
    area: "2,028 sq mi", population: "12,803", 
    events: ["Highland Clearances peak (1810s).", "Strathnaver evictions (1814).", "Dunrobin Castle Viking roots."],
    landmarks: ["Dunrobin Castle", "Cape Wrath", "Smoo Cave"]
  },
  "Tyrone": { 
    area: "1,260 sq mi", population: "178,440", 
    events: ["Battle of the Yellow Ford (1598).", "O'Neill's rebellion (1595).", "Ulster Plantation (1609)."],
    landmarks: ["Ulster American Folk Park", "Sperrin Mountains", "Beaghmore Stone Circles"]
  },
  "Warwickshire": { 
    area: "918 sq mi", population: "1,632,885", 
    events: ["Battle of Edgehill (1642).", "Shakespeare born Stratford (1564).", "Kenilworth Castle siege (1266)."],
    landmarks: ["Stratford-upon-Avon", "Warwick Castle", "Kenilworth Castle"]
  },
  "West Lothian": { 
    area: "120 sq mi", population: "154,830", 
    events: ["Battle of Philiphaugh (1645).", "Linlithgow Palace: Mary Queen born (1542).", "Shale oil boom (1850s)."],
    landmarks: ["Linlithgow Palace", "Blackness Castle", "Almond Valley"]
  },
  "Westmorland": { 
    area: "785 sq mi", population: "87,466", 
    events: ["Border Reivers (16th c.).", "Appleby Horse Fair origins (1100s).", "Kendal mint founded (12th c.)."],
    landmarks: ["Kendal Castle", "Levens Hall", "Rydal Mount (Wordsworth)"]
  },
  "Wigtownshire": { 
    area: "487 sq mi", population: "26,618", 
    events: ["Martyrs of Wigtown (1685).", "Bladnoch Distillery (1817).", "Galloway Forest dark skies (2010s)."],
    landmarks: ["Logan Botanic Garden", "Mull of Galloway", "Wigtown Book Town"]
  },
  "Wiltshire": { 
    area: "1,374 sq mi", population: "682,380", 
    events: ["Stonehenge built (3000 BC).", "Battle of Barbury Castle (552 AD).", "Salisbury Cathedral spire (1320)."],
    landmarks: ["Stonehenge (UNESCO)", "Avebury Stone Circle", "Salisbury Cathedral"]
  },
  "Worcestershire": { 
    area: "709 sq mi", population: "1,125,037", 
    events: ["Battle of Worcester (1651): Cromwell victory.", "Evesham Abbey founded (701).", "Malvern Hills folklore."],
    landmarks: ["Worcester Cathedral", "Malvern Hills", "Broadway Tower"]
  },
  "Yorkshire": { 
    area: "6,081 sq mi", population: "5,218,838", 
    events: ["Battle of Stamford Bridge (1066).", "Industrial Revolution in mills (1760s).", "York Minster fire (1984)."],
    landmarks: ["York Minster", "Castle Howard", "Whitby Abbey"]
  }
};
  // -----------------------------
  // NEW: Native language names (Welsh/Gaelic/Irish)
  // -----------------------------
  const nativeNames = {
    // Wales (Historic counties)
    "Anglesey": "Sir Fôn",
    "Brecknockshire": "Sir Frycheiniog",
    "Caernarfonshire": "Sir Gaernarfon",
    "Cardiganshire": "Sir Aberteifi/Ceredigion",
    "Carmarthenshire": "Sir Gaerfyrddin",
    "Denbighshire": "Sir Ddinbych",
    "Flintshire": "Sir y Fflint",
    "Glamorgan": "Morgannwg",
    "Merionethshire": "Meirionnydd",
    "Monmouthshire": "Sir Fynwy",
    "Montgomeryshire": "Sir Drefaldwyn",
    "Pembrokeshire": "Sir Benfro",
    "Radnorshire": "Sir Faesyfed",
    // Scotland (Historic counties, Scottish Gaelic)
    "Aberdeenshire": "Siorrachd Obar Dheathain",
    "Angus": "Aonghas",
    "Argyllshire": "Siorrachd Earra-Ghàidheal",
    "Ayrshire": "Siorrachd Inbhir Àir",
    "Banffshire": "Siorrachd Bhanbh",
    "Berwickshire": "Siorrachd Bhearaig",
    "Buteshire": "Siorrachd Bhùth",
    "Caithness": "Gallaibh",
    "Clackmannanshire": "Siorrachd Chlach Mhanainn",
    "Cromartyshire": "Siorrachd Chròmbaidh",
    "Dumfriesshire": "Siorrachd Dhùn Phris",
    "Dunbartonshire": "Siorrachd Dhùn Bhreatainn",
    "East Lothian": "Siorrachd an Ear Leothain",
    "Fife": "Fìobha",
    "Inverness-shire": "Siorrachd Inbhir Nis",
    "Kincardineshire": "Siorrachd Chinn Chàrdainn",
    "Kinross-shire": "Siorrachd Cheann Rois",
    "Kirkcudbrightshire": "Siorrachd Chille Chuithbeirt",
    "Lanarkshire": "Siorrachd Lanraig",
    "Midlothian": "Meadhan Labhdaidh",
    "Morayshire": "Moireibh",
    "Nairnshire": "Siorrachd Inbhir Narann",
    "Orkney": "Arcaibh",
    "Peeblesshire": "Siorrachd nam Pùballan",
    "Perthshire": "Siorrachd Pheairt",
    "Renfrewshire": "Siorrachd Rinn Friù",
    "Ross-shire": "Siorrachd Rois",
    "Roxburghshire": "Siorrachd Rosbroig",
    "Selkirkshire": "Siorrachd Shailcirc",
    "Shetland": "Sealtainn / Zetland",
    "Stirlingshire": "Siorrachd Shruighlea",
    "Sutherland": "Cataibh",
    "West Lothian": "Lothian an Iar",
    "Wigtownshire": "Siorrachd Bhaile na h-Ùige",
    // Northern Ireland (Historic counties, Irish Gaelic)
    "Antrim": "Aontroim",
    "Armagh": "Árd Mhacha",
    "Down": "An Dún",
    "Fermanagh": "Fhear Manach",
    "Londonderry": "Doire",
    "Tyrone": "Chontae Thír Eoghain"
  };
// -----------------------------
  // GeoJSON Load
  // -----------------------------
  fetch('./counties_simplified8.json')
    .then(res => { if (!res.ok) throw new Error(`Failed: ${res.status}`); return res.json(); })
    .then(data => {
      const pastelColors = ["#ffdede","#dedefd","#deffde","#fff0de","#fdefff","#dfffee","#ffe7de","#f0deff","#defff5","#fdeeee","#e6f7ff","#f9ffe6","#fff6e6","#e6e6ff","#ffe6f2"];
      data.features.forEach((f, i) => f.properties.color = pastelColors[i % pastelColors.length]);

      L.geoJSON(data, {
        style: f => ({
          color: "#333", weight: 1, fillColor: f.properties.color, fillOpacity: 0.35
        }),
        onEachFeature: (feature, layer) => {
          const englishName = feature.properties.NAME;
          const details = countyData[englishName] || {};
          const native = nativeNames[englishName] || null;

          // Tooltip
          layer.on('add', () => {
            const text = native ? `${englishName} (${native})` : englishName;
            layer.bindTooltip(text, { direction: 'center', className: 'county-tooltip' });
          });

          // Click
          layer.on('click', () => {
            updateCountyCard(englishName, layer);
            if (window.innerWidth <= 1024) sidebar.classList.add('visible');
            try { map.fitBounds(layer.getBounds()); } catch(e) {}
          });

          // Hover
          layer.on('mouseover', () => layer.setStyle({ weight: 2 }));
          layer.on('mouseout', () => layer.setStyle({ weight: 1 }));
        }
      }).addTo(map);

      map.invalidateSize();
      infoDiv.innerHTML = '<em>No county selected.</em>';
    })
    .catch(err => {
      console.error(err);
      infoDiv.innerHTML = '<em style="color:red;">Failed to load map data.</em>';
    });

  // -----------------------------
  // Geocoder + Search
  // -----------------------------
  L.Control.geocoder({ defaultMarkGeocode: true, placeholder: 'Search town, village, postcode…' }).addTo(map);

  window.places = []; let fuse = null; let searchMarker = null;
  function parseCSVLine(line) {
    const cols = []; const regex = /(?:\"([^\"]*)\"|([^,]+))/g; let m;
    while ((m = regex.exec(line)) !== null) cols.push(m[1] || m[2] || '');
    return cols;
  }
  function initFuse() { if (window.places.length) fuse = new Fuse(window.places, { keys: ['name', 'county'], threshold: 0.3 }); }
  function showDropdown(results) {
    searchDropdown.innerHTML = '';
    if (!results.length) { searchDropdown.style.display = 'none'; return; }
    results.slice(0, 10).forEach(r => {
      const div = document.createElement('div');
      div.style.cssText = 'padding:8px 12px; cursor:pointer; border-bottom:1px solid #eee; font-size:0.9rem;';
      div.textContent = `${r.item.name}, ${r.item.county || ''}`;
      div.onmouseover = () => div.style.backgroundColor = '#f5f5f5';
      div.onmouseout = () => div.style.backgroundColor = '';
      div.onclick = () => selectPlace(r.item);
      searchDropdown.appendChild(div);
    });
    searchDropdown.style.display = 'block';
  }
  function selectPlace(place) {
    if (searchMarker) map.removeLayer(searchMarker);
    searchMarker = L.marker([place.lat, place.lon]).addTo(map)
      .bindPopup(`<b>${place.name}</b><br>${place.county}`).openPopup();
    map.setView([place.lat, place.lon], 11);
    searchDropdown.style.display = 'none';
    searchInput.value = place.name;
    setTimeout(() => showCountyFromPoint(place.lat, place.lon), 500);
  }

  function showCountyFromPoint(lat, lon) {
    const point = turf.point([lon, lat]);
    let found = null;
    map.eachLayer(l => {
      if (l instanceof L.GeoJSON) {
        l.eachLayer(cl => {
          if (cl.getBounds && cl.getBounds().contains([lat, lon]) && turf.booleanPointInPolygon(point, cl.feature)) {
            found = cl;
          }
        });
      }
    });
    if (found) found.fire('click');
    else infoDiv.innerHTML = '<em>County not found.</em>';
  }

  fetch('places_clean.csv')
    .then(r => r.text())
    .then(text => {
      const lines = text.trim().split('\n'); lines.shift();
      lines.forEach(line => {
        const c = parseCSVLine(line);
        const name = c[0], desc = c[2], county = c[3], lat = parseFloat(c[6]), lon = parseFloat(c[7]);
        if ((desc === 'LOC' || desc === 'PAR') && name && !isNaN(lat) && !isNaN(lon)) {
          window.places.push({ name, county, lat, lon });
        }
      });
      initFuse();
    });

  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim();
    if (!q || !fuse) { searchDropdown.style.display = 'none'; return; }
    showDropdown(fuse.search(q));
  });
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && fuse) {
      const res = fuse.search(searchInput.value.trim());
      if (res.length) selectPlace(res[0].item);
    }
  });
  document.addEventListener('click', e => {
    if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
      searchDropdown.style.display = 'none';
    }
  });

};
</script>
</body>
</html>

