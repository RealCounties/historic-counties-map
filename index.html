
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Historic Counties Interactive Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/polylabel@1.0.3/polylabel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

<style>
:root {
  --bg: #faf4e6;
  --card-bg: #f3e9da;
  --text: #333;
  --border: #ccc;
  --shadow: rgba(0,0,0,0.2);
  --accent: #9B2C2C;
  --tooltip-bg: rgba(255,255,255,0.9);
}
html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
#container { display:flex; height:100%; }
#logo-container { text-align:center; margin-bottom:10px; }
#sidebar-logo {
  max-width:100%; height:auto; display:block; margin:0 auto;
  opacity:0; transform:scale(0.9);
  animation:logoLoad 1.4s ease-out forwards;
}
@keyframes logoLoad {
  0%   { opacity:0; transform:scale(0.9) translateY(10px); }
  60%  { opacity:1; transform:scale(1.02); }
  100% { opacity:1; transform:scale(1); }
}
#logo-link { display:block; transition:opacity .25s ease; }
#logo-link:hover { opacity:.85; }

#sidebar {
  width:340px; background:var(--bg); padding:15px; overflow-y:auto;
  border-right:1px solid var(--border); transition:all .3s ease; position:relative;
  color:var(--text);
}

#search-bar { margin-top:15px; display:flex; gap:6px; align-items:center; justify-content:center; }
#search-bar input {
  flex:1; min-width:140px; padding:10px 12px; border:1px solid var(--border);
  border-radius:4px; font-size:.9rem; color:var(--text); background:#fff;
  box-shadow:0 2px 4px var(--shadow); transition:all .25s;
}
#search-bar input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(155,44,44,.2); }
#search-bar button {
  padding:10px 18px; background:var(--accent); color:#FAF4E6; border:none; border-radius:4px;
  font-weight:500; box-shadow:0 3px 6px var(--shadow); cursor:pointer;
  transition:all .25s cubic-bezier(.4,0,.2,1);
}
#search-bar button:hover { background:#7a2222; transform:translateY(-2px) scale(1.05); box-shadow:0 6px 14px var(--shadow); }

#map { flex:1; }

.county-card {
  background:var(--card-bg); padding:14px; border-radius:10px;
  box-shadow:0 2px 6px var(--shadow); transition:all .3s ease; cursor:pointer;
  position:relative;
}
.county-card:hover { transform:translateY(-6px); box-shadow:0 8px 18px var(--shadow); }

.county-card h3 {
  margin: 0 0 4px;
  font-size: 1.15rem;
  color: var(--text);
  word-wrap: break-word;
  max-width: calc(100% - 10px);
  line-height: 1.3;
}
.county-card h3::after {
  content: '';
  display: block;
  width: 60px;
  height: 2px;
  background: var(--accent);
  margin: 8px auto 0;
  border-radius: 1px;
}
.weather-badge {
  display: block;
  font-size: 0.82rem;
  background: rgba(0,0,0,0.1);
  color: var(--text);
  padding: 5px 10px;
  border-radius: 14px;
  font-weight: 500;
  margin: 8px 0 10px;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  max-width: fit-content;
  align-self: center;
}
.county-card p, .county-card ul { margin:6px 0; }
.county-card a { color:#0066cc; text-decoration:none; }
.county-card a:hover { text-decoration:underline; }

.leaflet-tooltip.county-tooltip {
  background:var(--tooltip-bg); border:1px solid var(--accent); color:var(--text);
  font-weight:bold; padding:2px 6px; border-radius:4px;
}

#closeSidebar {
  display: none;
  position: absolute; top: 10px; right: 12px;
  width: 32px; height: 32px; font-size: 20px; color: #666;
  background: rgba(255,255,255,0.9); border: none; border-radius: 50%;
  cursor: pointer; align-items: center; justify-content: center;
  z-index: 1001;
}
#closeSidebar:hover { background: #fff; }

@media (max-width:1024px) {
  #container { flex-direction:column; }
  #sidebar {
    position:fixed; bottom:16px; left:16px; width:45vw; max-width:380px;
    max-height:50vh; background:var(--bg); border-radius:14px;
    box-shadow:0 6px 20px var(--shadow); padding:14px; overflow-y:auto;
    transform:translateY(120%); transition:transform .32s cubic-bezier(.4,0,.2,1);
    z-index:1000; display:block !important; font-size:.94rem;
  }
  #sidebar.visible { transform:translateY(0); }
  #map { height:100vh !important; }
  #sidebar-logo { max-width:65%; }
  #closeSidebar { display: flex; }
}
@media (max-width:480px) {
  #sidebar { width:90vw; left:5vw; max-width:none; }
  #sidebar-logo { max-width:55%; }
}
#sidebar h2 { text-align:center; margin:5px 0 10px; color:var(--accent); }
</style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <button id="closeSidebar">x</button>
    <div id="logo-container">
      <a href="https://realcounties.com" target="_blank" rel="noopener" id="logo-link">
        <img src="https://realcounties.wordpress.com/wp-content/uploads/2025/06/logo-full-trans-16-6-25.png"
             alt="Campaign for Historic Counties Logo"
             id="sidebar-logo">
      </a>
    </div>
    <h2>Interactive Map</h2>
    <p>Select a county to view details.</p>
    <div id="info"><em>Loading counties...</em></div>
    <div id="search-bar">
      <input type="text" id="placeSearch" placeholder="Search for a place...">
      <button id="searchBtn">Search</button>
    </div>
    <div id="searchDropdown" style="position:absolute;background:white;border:1px solid #ccc;max-height:200px;overflow-y:auto;width:calc(100%-60px);display:none;z-index:1001;margin-top:5px;box-shadow:0 4px 8px rgba(0,0,0,0.1);"></div>
  </div>
  <div id="map"></div>
</div>

<script>
window.onload = function() {
  const sidebar = document.getElementById('sidebar');
  const closeBtn = document.getElementById('closeSidebar');
  const infoDiv = document.getElementById('info');
  const searchInput = document.getElementById('placeSearch');
  const searchDropdown = document.getElementById('searchDropdown');

  const map = L.map('map', { center: [54.5, -3], zoom: 6, minZoom: 5 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> | <a href="https://county-borders.co.uk" target="_blank">Historic County Borders Project</a>',
    maxZoom: 19
  }).addTo(map);
  const ukBounds = L.latLngBounds([49.5, -8.5], [60.9, 2.0]);
  map.setMaxBounds(ukBounds);
  map.fitBounds(ukBounds);

  const toggleButton = L.control({ position: 'topright' });
  toggleButton.onAdd = function() {
    const btn = L.DomUtil.create('button', 'leaflet-bar');
    btn.innerHTML = 'Info';
    btn.title = 'Show county info';
    btn.style.cssText = 'background:white; border:1px solid #999; width:34px; height:34px; font-size:18px; cursor:pointer; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,0.3);';
    btn.onclick = () => sidebar.classList.toggle('visible');
    return btn;
  };
  toggleButton.addTo(map);
  closeBtn.onclick = () => sidebar.classList.remove('visible');

  async function fetchWeather(lat, lon) {
    try {
      const res = await axios.get(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m`);
      const temp = Math.round(res.data.current.temperature_2m);
      const code = res.data.current.weather_code;
      const wind = Math.round(res.data.current.wind_speed_10m);
      const descMap = {0:'Clear',1:'Mostly clear',2:'Partly cloudy',3:'Overcast',45:'Fog',48:'Fog',51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',61:'Light rain',63:'Rain',65:'Heavy rain',71:'Light snow',73:'Snow',75:'Heavy snow',80:'Showers',81:'Rain showers',82:'Heavy showers',95:'Thunderstorm'};
      const desc = descMap[code] || 'Unknown';
      return { temp, desc, wind };
    } catch (e) { return null; }
  }

  let currentLayer = null;
  let photoTimeout;
  function updateCountyCard(englishName, layer, lat, lon) {
    const details = countyData[englishName] || {};
    const langEntry = countyLanguages[englishName];
    const events = details.events || [];
    const landmarks = details.landmarks || [];

    fetchWeather(lat, lon).then(weather => {
      const weatherHtml = weather
        ? `<div class="weather-badge">${weather.temp}°C • ${weather.desc} • Wind ${weather.wind} km/h</div>`
        : '';

      infoDiv.innerHTML = `
      	<div class="county-card">
          <h3>${englishName}</h3>
          ${langEntry ? `<p><strong>${langEntry.lang}:</strong> ${langEntry.name}</p>` : ''}
          <p><strong>Area:</strong> ${details.area || 'Unknown'}</p>
          <p><strong>Population:</strong> ${details.population || 'Unknown'}</p>
          ${events.length ? `<h4>Events</h4><ul>${events.map(e=>`<li>${e}</li>`).join('')}</ul>` : ''}
          ${landmarks.length ? `<h4>Landmarks</h4><ul>${landmarks.map(l=>`<li onmouseover="showPhoto('${l}', event)" onmouseout="hidePhoto()">${l}</li>`).join('')}</ul>` : ''}
          <div style="text-align: center;">
 						${weatherHtml}
          </div>
        </div>`;
    });

    if (currentLayer) currentLayer.setStyle({ weight: 1, fillOpacity: 0.35 });
    layer.setStyle({ weight: 3, fillOpacity: 0.6 });
    currentLayer = layer;
  }

  function showPhoto(landmark, e) {
    clearTimeout(photoTimeout);
    const img = document.createElement('img');
    img.src = `https://source.unsplash.com/400x300/?${encodeURIComponent(landmark + ' UK')}`;
    img.style.cssText = 'position:absolute; top:'+(e.clientY+10)+'px; left:'+(e.clientX+10)+'px; width:200px; height:auto; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:10000;';
    img.onload = () => document.body.appendChild(img);
    window.photoImg = img;
  }
  function hidePhoto() {
    photoTimeout = setTimeout(() => {
      if (window.photoImg) { document.body.removeChild(window.photoImg); delete window.photoImg; }
    }, 300);
  }

  const countyData = {
    "Aberdeenshire": { area: "1,950 sq mi", population: "380,495", events: ["Battle of Harlaw (1411): Clan battle that halted Highland expansion into Lowlands.", "Gordon Riots (1689): Jacobite uprising against William III.", "Founding of Aberdeen University (1495) by Bishop Elphinstone."], landmarks: ["Slains Castle", "Balmoral Castle (Royal residence)", "Dunnottar Castle"] },
    "Anglesey": { area: "277 sq mi", population: "69,751", events: ["Roman invasion repelled by druids (60 AD) at Mona.", "Owain Gwynedd's victory over Normans (1138).", "Llyn Peninsula Druid uprising crushed (78 AD)."], landmarks: ["Beaumaris Castle", "South Stack Lighthouse", "Menai Suspension Bridge"] },
    "Antrim": { area: "1,176 sq mi", population: "618,108", events: ["Battle of Antrim (1798): United Irishmen defeat.", "Carrickfergus Castle siege (1689).", "Giant's Causeway formed ~60 million years ago."], landmarks: ["Giant's Causeway", "Carrickfergus Castle", "Dark Hedges"] },
    "Armagh": { area: "512 sq mi", population: "174,792", events: ["St. Patrick founds Armagh (445 AD).", "Battle of the Diamond (1795): Orange Order formed."], landmarks: ["Navan Fort", "Armagh Observatory", "St. Patrick's Cathedral"] },
    "Ayrshire": { area: "1,129 sq mi", population: "366,900", events: ["Robert Burns born in Alloway (1759).", "Battle of Loudoun Hill (1307): Robert the Bruce victory."], landmarks: ["Culzean Castle", "Burns Cottage", "Ayr Racecourse"] },
    "Banffshire": { area: "641 sq mi", population: "50,000", events: ["Salmon fishing industry peak (19th century).", "Portsoy Marble used in Versailles."], landmarks: ["Duff House", "Portsoy Harbour", "Glenglassaugh Distillery"] },
    "Bedfordshire": { area: "477 sq mi", population: "669,338", events: ["John Bunyan writes Pilgrim's Progress in Bedford Gaol (1678).", "Woburn Abbey built (1744)."], landmarks: ["Woburn Abbey", "Bedford Castle", "Whipsnade Zoo"] },
    "Berkshire": { area: "726 sq mi", population: "911,403", events: ["Battle of Ashdown (871): Alfred the Great defeats Danes.", "Windsor Castle built (1070)."], landmarks: ["Windsor Castle", "Eton College", "Ascot Racecourse"] },
    "Berwickshire": { area: "457 sq mi", population: "27,000", events: ["Battle of Halidon Hill (1333): English victory.", "Berwick-upon-Tweed changes hands 13 times."], landmarks: ["Duns Castle", "Paxton House", "St. Abbs Head"] },
    "Brecknockshire": { area: "733 sq mi", population: "43,000", events: ["Llewelyn ap Gruffydd killed near Builth (1282).", "Brecon Beacons formed 300 million years ago."], landmarks: ["Brecon Cathedral", "Carreg Cennen Castle", "Dan-yr-Ogof Caves"] },
    "Buckinghamshire": { area: "746 sq mi", population: "916,903", events: ["Battle of Stony Stratford (1460) in Wars of Roses.", "Milton writes Paradise Lost at Chalfont (1667).", "Bletchley Park codebreaking (WWII, 1939-45)."], landmarks: ["Bletchley Park (WWII Codebreaking)", "Stowe House", "Eton College"] },
    "Buteshire": { area: "220 sq mi", population: "20,000", events: ["Viking settlement (9th century).", "Rothesay Castle built (13th century)."], landmarks: ["Rothesay Castle", "Mount Stuart House", "Arran Distillery"] },
    "Caernarfonshire": { area: "573 sq mi", population: "125,000", events: ["Edward I builds Caernarfon Castle (1283).", "Owain Glyndŵr rebellion (1400)."], landmarks: ["Caernarfon Castle", "Snowdon", "Portmeirion"] },
    "Caithness": { area: "686 sq mi", population: "26,000", events: ["Norse rule until 1266.", "John o' Groats named after Dutchman (1496)."], landmarks: ["Castle of Mey", "John o' Groats", "Duncansby Stacks"] },
    "Cardiganshire": { area: "693 sq mi", population: "75,000", events: ["Rebecca Riots (1843): toll gate protests.", "Aberystwyth University founded (1872)."], landmarks: ["Devil's Bridge", "Strata Florida Abbey", "Vale of Rheidol Railway"] },
    "Carmarthenshire": { area: "918 sq mi", population: "187,000", events: ["Battle of Mynydd Hyddgen (1401): Glyndŵr victory.", "Laugharne Castle inspires Dylan Thomas."], landmarks: ["Laugharne Castle", "Kidwelly Castle", "National Botanic Garden"] },
    "Cheshire": { area: "905 sq mi", population: "1,059,271", events: ["Battle of Rowton Moor (1645): Royalist defeat.", "Chester Roman Amphitheatre (1st century)."], landmarks: ["Chester Cathedral", "Beeston Castle", "Jodrell Bank Observatory"] },
    "Clackmannanshire": { area: "61 sq mi", population: "51,400", events: ["Smallest historic county in Scotland.", "Alloa Tower (14th century)."], landmarks: ["Alloa Tower", "Gartmorn Dam", "Castle Campbell"] },
    "Cornwall": { area: "1,376 sq mi", population: "565,968", events: ["Tamar Bridge opened (1961).", "Stannary Parliament (last met 1752)."], landmarks: ["Eden Project", "St Michael's Mount", "Tintagel Castle"] },
    "Cromartyshire": { area: "1,200 sq mi", population: "5,000", events: ["Enclave county with 12 detached parts.", "Merged with Ross-shire (1890)."], landmarks: ["Inverewe Garden", "Ben Wyvis", "Loch Maree"] },
    "Cumberland": { area: "1,520 sq mi", population: "294,000", events: ["Carlisle Castle siege (1644).", "Hadrian's Wall built (122 AD)."], landmarks: ["Carlisle Castle", "Hadrian's Wall", "Lake District"] },
    "Denbighshire": { area: "669 sq mi", population: "95,000", events: ["Ruthin Castle built (1277).", "Vale of Clwyd railway (1858)."], landmarks: ["Ruthin Castle", "Chirk Castle", "Llangollen Canal"] },
    "Derbyshire": { area: "1,016 sq mi", population: "1,053,316", events: ["Peak District National Park (1951).", "Arkwright's Mill, Cromford (1771)."], landmarks: ["Chatsworth House", "Peak Cavern", "Derwent Valley Mills"] },
    "Devon": { area: "2,590 sq mi", population: "1,194,166", events: ["Drake plays bowls before Armada (1588).", "Dartmoor Prison opened (1809)."], landmarks: ["Dartmoor", "Exeter Cathedral", "Jurassic Coast"] },
    "Dorset": { area: "1,024 sq mi", population: "772,268", events: ["Tolpuddle Martyrs (1834).", "Cerne Abbas Giant (prehistoric)."], landmarks: ["Durston Castle", "Cerne Abbas Giant", "Jurassic Coast"] },
    "Dumfriesshire": { area: "1,072 sq mi", population: "151,000", events: ["Robert the Bruce kills Red Comyn (1306).", "Sweetheart Abbey founded (1273)."], landmarks: ["Caerlaverock Castle", "Sweetheart Abbey", "Devil's Beef Tub"] },
    "Dunbartonshire": { area: "244 sq mi", population: "90,000", events: ["Loch Lomond and Trossachs National Park.", "Vale of Leven shipbuilding."], landmarks: ["Loch Lomond", "Dumbarton Castle", "Hill House"] },
    "Durham": { area: "1,050 sq mi", population: "866,000", events: ["Durham Cathedral founded (1093).", "Stockton-Darlington Railway (1825)."], landmarks: ["Durham Cathedral", "Beamish Museum", "High Force Waterfall"] },
    "East Lothian": { area: "262 sq mi", population: "105,000", events: ["Battle of Prestonpans (1745): Jacobite victory.", "John Muir born in Dunbar (1838)."], landmarks: ["Tantallon Castle", "Dunbar Castle", "Muirfield Golf"] },
    "Essex": { area: "1,420 sq mi", population: "1,832,752", events: ["Battle of Maldon (991): Viking victory.", "Harlow New Town (1947)."], landmarks: ["Colchester Castle", "Audley End House", "Southend Pier"] },
    "Fife": { area: "512 sq mi", population: "371,000", events: ["St Andrews University founded (1413).", "Fife Coastal Path."], landmarks: ["St Andrews Cathedral", "Falkland Palace", "Culross"] },
    "Flintshire": { area: "256 sq mi", population: "155,000", events: ["Ewloe Castle built (1257).", "Greenfield Valley industrial heritage."], landmarks: ["Flint Castle", "St Winefride's Well", "Basingwerk Abbey"] },
    "Glamorgan": { area: "813 sq mi", population: "1,300,000", events: ["Coal industry boom (19th century).", "Cardiff Castle (Roman origins)."], landmarks: ["Cardiff Castle", "Castell Coch", "Big Pit"] },
    "Gloucestershire": { area: "1,241 sq mi", population: "916,000", events: ["Battle of Tewkesbury (1471).", "Gloucester Cathedral (678 AD)."], landmarks: ["Gloucester Cathedral", "Berkeley Castle", "Cotswold Way"] },
    "Hampshire": { area: "1,455 sq mi", population: "1,844,245", events: ["D-Day landings planned in Southwick House.", "Jane Austen lived in Chawton."], landmarks: ["Winchester Cathedral", "Portsmouth Historic Dockyard", "New Forest"] },
    "Herefordshire": { area: "842 sq mi", population: "192,107", events: ["Battle of Mortimer's Cross (1461).", "Hereford Mappa Mundi (1300)."], landmarks: ["Hereford Cathedral", "Goodrich Castle", "Black and White Villages"] },
    "Hertfordshire": { area: "634 sq mi", population: "1,184,365", events: ["Hatfield House built (1611).", "St Albans Roman Verulamium."], landmarks: ["St Albans Cathedral", "Hatfield House", "Knebworth House"] },
    "Huntingdonshire": { area: "366 sq mi", population: "177,000", events: ["Oliver Cromwell born in Huntingdon (1599).", "Ramsey Abbey founded (969)."], landmarks: ["Hinchingbrooke House", "Ramsey Abbey Gatehouse", "Grafham Water"] },
    "Inverness-shire": { area: "4,211 sq mi", population: "80,000", events: ["Largest county by area.", "Loch Ness Monster sightings (1933)."], landmarks: ["Urquhart Castle", "Eilean Donan Castle", "Ben Nevis"] },
    "Kent": { area: "1,443 sq mi", population: "1,846,478", events: ["Battle of Britain (1940).", "Canterbury Cathedral (597 AD)."], landmarks: ["Canterbury Cathedral", "Leeds Castle", "White Cliffs of Dover"] },
    "Kincardineshire": { area: "383 sq mi", population: "40,000", events: ["Dunnottar Castle siege (1651).", "Stonehaven Tolbooth (16th century)."], landmarks: ["Dunnottar Castle", "Fetteresso Castle", "Muchalls Castle"] },
    "Kinross-shire": { area: "81 sq mi", population: "13,000", events: ["Loch Leven Castle: Mary Queen of Scots imprisoned (1567)."], landmarks: ["Loch Leven Castle", "Kinross House", "RSPB Vane Farm"] },
    "Kirkcudbrightshire": { area: "899 sq mi", population: "30,000", events: ["Artists' colony in Kirkcudbright (late 19th century).", "Threave Castle (14th century)."], landmarks: ["Threave Castle", "Broughton House", "Dundrennan Abbey"] },
    "Lanarkshire": { area: "879 sq mi", population: "650,000", events: ["New Lanark founded by Robert Owen (1800).", "Bothwell Bridge battle (1679)."], landmarks: ["New Lanark", "Chatelherault", "Falls of Clyde"] },
    "Lancashire": { area: "1,878 sq mi", population: "1,490,000", events: ["Pendle Witch Trials (1612).", "Blackpool Tower opened (1894)."], landmarks: ["Lancaster Castle", "Blackpool Tower", "Ribblehead Viaduct"] },
    "Leicestershire": { area: "833 sq mi", population: "1,053,000", events: ["Battle of Bosworth (1485): Richard III killed.", "National Space Centre opened (2001)."], landmarks: ["Belvoir Castle", "Ashby Castle", "Bradgate Park"] },
    "Lincolnshire": { area: "2,687 sq mi", population: "1,089,000", events: ["Lincoln Cathedral tallest building in world (1311–1548).", "Wool trade peak (14th century)."], landmarks: ["Lincoln Cathedral", "Tattershall Castle", "Theddlethorpe Dunes"] },
    "Londonderry": { area: "814 sq mi", population: "247,000", events: ["Siege of Derry (1689).", "Apprentice Boys founded (1814)."], landmarks: ["Derry City Walls", "Mussenden Temple", "Guildhall"] },
    "Middlesex": { area: "283 sq mi", population: "2,000,000", events: ["Hampton Court Palace built (1515).", "Wembley Stadium opened (1923)."], landmarks: ["Hampton Court", "Kew Gardens", "RAF Museum"] },
    "Midlothian": { area: "366 sq mi", population: "90,000", events: ["Edinburgh Castle (12th century).", "Rosslyn Chapel (1446)."], landmarks: ["Edinburgh Castle", "Rosslyn Chapel", "Scottish Parliament"] },
    "Monmouthshire": { area: "543 sq mi", population: "92,000", events: ["Raglan Castle siege (1646).", "Chartist uprising in Newport (1839)."], landmarks: ["Raglan Castle", "Tintern Abbey", "Big Pit"] },
    "Montgomeryshire": { area: "798 sq mi", population: "63,000", events: ["Owain Glyndŵr crowned Prince of Wales (1400).", "Montgomery Castle built (1223)."], landmarks: ["Powis Castle", "Montgomery Castle", "Lake Vyrnwy"] },
    "Morayshire": { area: "476 sq mi", population: "95,000", events: ["Elgin Cathedral founded (1224).", "Speyside whisky region."], landmarks: ["Elgin Cathedral", "Pluscarden Abbey", "Glen Moray Distillery"] },
    "Nairnshire": { area: "163 sq mi", population: "13,000", events: ["Cawdor Castle (14th century).", "Nairn Golf Club (1887)."], landmarks: ["Cawdor Castle", "Nairn Museum", "Boath House"] },
    "Norfolk": { area: "2,074 sq mi", population: "903,680", events: ["Nelson born in Burnham Thorpe (1758).", "Norfolk Broads formed (medieval peat digging)."], landmarks: ["Norwich Cathedral", "Sandringham House", "Holkham Hall"] },
    "Northamptonshire": { area: "913 sq mi", population: "747,622", events: ["Battle of Naseby (1645).", "Silverstone Circuit (1948)."], landmarks: ["Althorp House", "Rockingham Castle", "Silverstone"] },
    "Northumberland": { area: "2,023 sq mi", population: "319,000", events: ["Hadrian's Wall built (122 AD).", "Battle of Flodden (1513)."], landmarks: ["Hadrian's Wall", "Alnwick Castle", "Bamburgh Castle"] },
    "Nottinghamshire": { area: "835 sq mi", population: "1,154,195", events: ["Robin Hood legend.", "Sherwood Forest."], landmarks: ["Nottingham Castle", "Wollaton Hall", "Newstead Abbey"] },
    "Orkney": { area: "382 sq mi", population: "22,000", events: ["Skara Brae Neolithic village (3100 BC).", "Italian Chapel built by POWs (1943)."], landmarks: ["Skara Brae", "Ring of Brodgar", "St Magnus Cathedral"] },
    "Oxfordshire": { area: "1,006 sq mi", population: "687,000", events: ["Oxford University founded (1096).", "Blenheim Palace built (1705)."], landmarks: ["Blenheim Palace", "Oxford Colleges", "Cotswold Wildlife Park"] },
    "Peeblesshire": { area: "347 sq mi", population: "20,000", events: ["Neidpath Castle (14th century).", "Tweed Valley."], landmarks: ["Neidpath Castle", "Traquair House", "Dawyck Botanic Garden"] },
    "Pembrokeshire": { area: "614 sq mi", population: "125,000", events: ["St Davids Cathedral (1181).", "Pembrokeshire Coast National Park (1952)."], landmarks: ["St Davids Cathedral", "Pembroke Castle", "Skomer Island"] },
    "Perthshire": { area: "2,493 sq mi", population: "150,000", events: ["Battle of Killiecrankie (1689).", "Scone Palace: Stone of Destiny."], landmarks: ["Scone Palace", "Blair Castle", "Loch Tay"] },
    "Radnorshire": { area: "470 sq mi", population: "25,000", events: ["Llandrindod Wells spa town (19th century).", "Elan Valley dams (1893)."], landmarks: ["Elan Valley", "Radnor Forest", "Llandrindod Wells"] },
    "Renfrewshire": { area: "224 sq mi", population: "177,000", events: ["Paisley Abbey founded (1163).", "Weaver's cottage industry."], landmarks: ["Paisley Abbey", "Coats Observatory", "Castle Semple"] },
    "Ross-shire": { area: "3,095 sq mi", population: "60,000", events: ["Cromarty Firth naval base.", "Inverewe Garden subtropical."], landmarks: ["Inverewe Garden", "Beinn Eighe", "Loch Maree"] },
    "Roxburghshire": { area: "666 sq mi", population: "48,000", events: ["Floors Castle (1721).", "Jedburgh Abbey (1138)."], landmarks: ["Floors Castle", "Jedburgh Abbey", "Hermitage Castle"] },
    "Rutland": { area: "147 sq mi", population: "39,000", events: ["Smallest historic county in England.", "Rutland Water reservoir (1976)."], landmarks: ["Rutland Water", "Oakham Castle", "Rockingham Castle"] },
    "Selkirkshire": { area: "259 sq mi", population: "15,000", events: ["Philiphaugh battle (1645).", "Sir Walter Scott Sheriff (1799)."], landmarks: ["Bowhill House", "Abbotsford House", "Ettrick Forest"] },
    "Shetland": { area: "550 sq mi", population: "23,000", events: ["Up Helly Aa fire festival.", "Jarlshof prehistoric site."], landmarks: ["Jarlshof", "Shetland Museum", "Mousa Broch"] },
    "Shropshire": { area: "1,347 sq mi", population: "498,000", events: ["Battle of Shrewsbury (1403).", "Ironbridge Gorge (1781)."], landmarks: ["Ironbridge", "Shrewsbury Castle", "Ludlow Castle"] },
    "Somerset": { area: "1,610 sq mi", population: "965,000", events: ["Glastonbury Festival (1970).", "Sedgemoor battle (1685)."], landmarks: ["Glastonbury Tor", "Wells Cathedral", "Cheddar Gorge"] },
    "Staffordshire": { area: "1,053 sq mi", population: "1,133,000", events: ["Wedgwood pottery (1759).", "Lichfield Cathedral (7th century)."], landmarks: ["Lichfield Cathedral", "Alton Towers", "Trentham Estate"] },
    "Stirlingshire": { area: "451 sq mi", population: "90,000", events: ["Battle of Bannockburn (1314).", "Stirling Castle."], landmarks: ["Stirling Castle", "Bannockburn", "Wallace Monument"] },
    "Suffolk": { area: "1,466 sq mi", population: "761,000", events: ["Sutton Hoo burial (7th century).", "Newmarket horse racing."], landmarks: ["Sutton Hoo", "Framlingham Castle", "Southwold Pier"] },
    "Surrey": { area: "642 sq mi", population: "1,189,000", events: ["Brooklands racetrack (1907).", "RHS Wisley."], landmarks: ["Hampton Court", "Watts Gallery", "Box Hill"] },
    "Sussex": { area: "1,461 sq mi", population: "1,700,000", events: ["Battle of Hastings (1066).", "Brighton Pavilion."], landmarks: ["Battle Abbey", "Arundel Castle", "Brighton Pier"] },
    "Sutherland": { area: "2,028 sq mi", population: "13,000", events: ["Highland Clearances (19th century).", "Cape Wrath."], landmarks: ["Dunrobin Castle", "Handa Island", "Smoo Cave"] },
    "Tyrone": { area: "1,261 sq mi", population: "177,000", events: ["Flight of the Earls (1607).", "Omagh bombing (1998)."], landmarks: ["Ulster American Folk Park", "Sperrin Mountains", "Beaghmore Stone Circles"] },
    "Warwickshire": { area: "763 sq mi", population: "571,000", events: ["Shakespeare born in Stratford (1564).", "Battle of Edgehill (1642)."], landmarks: ["Stratford-upon-Avon", "Warwick Castle", "Kenilworth Castle"] },
    "West Lothian": { area: "162 sq mi", population: "183,000", events: ["Linlithgow Palace: Mary Queen of Scots born (1542)."], landmarks: ["Linlithgow Palace", "Blackness Castle", "Almond Valley"] },
    "Westmorland": { area: "792 sq mi", population: "75,000", events: ["Appleby Horse Fair.", "Kendal Mint Cake."], landmarks: ["Kendal Castle", "Sizergh Castle", "Levens Hall"] },
    "Wigtownshire": { area: "487 sq mi", population: "28,000", events: ["Whithorn Priory: St Ninian (397 AD).", "Mull of Galloway."], landmarks: ["Whithorn Priory", "Logan Botanic Garden", "Castle Kennedy"] },
    "Wiltshire": { area: "1,346 sq mi", population: "720,000", events: ["Stonehenge (3000 BC).", "Avebury stone circle."], landmarks: ["Stonehenge", "Avebury", "Salisbury Cathedral"] },
    "Worcestershire": { area: "672 sq mi", population: "592,000", events: ["Battle of Worcester (1651).", "Elgar born in Broadheath (1857)."], landmarks: ["Worcester Cathedral", "Malvern Hills", "Broadway Tower"] },
    "Yorkshire": { area: "6,079 sq mi", population: "5,400,000", events: ["Largest county in UK.", "York Minster (627 AD)."], landmarks: ["York Minster", "Castle Howard", "North York Moors"] }
  };

  const countyLanguages = {
    "Anglesey": { name: "Sir Fôn", lang: "Welsh" },
    "Brecknockshire": { name: "Sir Frycheiniog", lang: "Welsh" },
    "Caernarfonshire": { name: "Sir Gaernarfon", lang: "Welsh" },
    "Cardiganshire": { name: "Sir Aberteifi", lang: "Welsh" },
    "Carmarthenshire": { name: "Sir Gaerfyrddin", lang: "Welsh" },
    "Denbighshire": { name: "Sir Ddinbych", lang: "Welsh" },
    "Flintshire": { name: "Sir y Fflint", lang: "Welsh" },
    "Glamorgan": { name: "Morgannwg", lang: "Welsh" },
    "Merionethshire": { name: "Meirionnydd", lang: "Welsh" },
    "Monmouthshire": { name: "Sir Fynwy", lang: "Welsh" },
    "Montgomeryshire": { name: "Sir Drefaldwyn", lang: "Welsh" },
    "Pembrokeshire": { name: "Sir Benfro", lang: "Welsh" },
    "Radnorshire": { name: "Sir Faesyfed", lang: "Welsh" },
    "Aberdeenshire": { name: "Siorrachd Obar Dheathain", lang: "Scottish Gaelic" },
    "Angus": { name: "Aonghas", lang: "Scottish Gaelic" },
    "Argyllshire": { name: "Siorrachd Earra-Ghàidheal", lang: "Scottish Gaelic" },
    "Ayrshire": { name: "Siorrachd Inbhir Àir", lang: "Scottish Gaelic" },
    "Banffshire": { name: "Siorrachd Bhanbh", lang: "Scottish Gaelic" },
    "Berwickshire": { name: "Siorrachd Bhearaig", lang: "Scottish Gaelic" },
    "Buteshire": { name: "Siorrachd Bhùth", lang: "Scottish Gaelic" },
    "Caithness": { name: "Gallaibh", lang: "Scottish Gaelic" },
    "Clackmannanshire": { name: "Siorrachd Chlach Mhanainn", lang: "Scottish Gaelic" },
    "Cromartyshire": { name: "Siorrachd Chròmbaidh", lang: "Scottish Gaelic" },
    "Dumfriesshire": { name: "Siorrachd Dhùn Phris", lang: "Scottish Gaelic" },
    "Dunbartonshire": { name: "Siorrachd Dhùn Bhreatainn", lang: "Scottish Gaelic" },
    "East Lothian": { name: "Siorrachd an Ear Leothain", lang: "Scottish Gaelic" },
    "Fife": { name: "Fìobha", lang: "Scottish Gaelic" },
    "Inverness-shire": { name: "Siorrachd Inbhir Nis", lang: "Scottish Gaelic" },
    "Kincardineshire": { name: "Siorrachd Chinn Chàrdainn", lang: "Scottish Gaelic" },
    "Kinross-shire": { name: "Siorrachd Cheann Rois", lang: "Scottish Gaelic" },
    "Kirkcudbrightshire": { name: "Siorrachd Chille Chuithbeirt", lang: "Scottish Gaelic" },
    "Lanarkshire": { name: "Siorrachd Lanraig", lang: "Scottish Gaelic" },
    "Midlothian": { name: "Meadhan Labhdaidh", lang: "Scottish Gaelic" },
    "Morayshire": { name: "Moireibh", lang: "Scottish Gaelic" },
    "Nairnshire": { name: "Siorrachd Inbhir Narann", lang: "Scottish Gaelic" },
    "Orkney": { name: "Arcaibh", lang: "Scottish Gaelic" },
    "Peeblesshire": { name: "Siorrachd nam Pùballan", lang: "Scottish Gaelic" },
    "Perthshire": { name: "Siorrachd Pheairt", lang: "Scottish Gaelic" },
    "Renfrewshire": { name: "Siorrachd Rinn Friù", lang: "Scottish Gaelic" },
    "Ross-shire": { name: "Siorrachd Rois", lang: "Scottish Gaelic" },
    "Roxburghshire": { name: "Siorrachd Rosbroig", lang: "Scottish Gaelic" },
    "Selkirkshire": { name: "Siorrachd Shailcirc", lang: "Scottish Gaelic" },
    "Shetland": { name: "Sealtainn", lang: "Scottish Gaelic" },
    "Stirlingshire": { name: "Siorrachd Shruighlea", lang: "Scottish Gaelic" },
    "Sutherland": { name: "Cataibh", lang: "Scottish Gaelic" },
    "West Lothian": { name: "Lothian an Iar", lang: "Scottish Gaelic" },
    "Wigtownshire": { name: "Siorrachd Bhaile na h-Ùige", lang: "Scottish Gaelic" },
    "Antrim": { name: "Aontroim", lang: "Irish Gaelic" },
    "Armagh": { name: "Árd Mhacha", lang: "Irish Gaelic" },
    "Down": { name: "An Dún", lang: "Irish Gaelic" },
    "Fermanagh": { name: "Fear Manach", lang: "Irish Gaelic" },
    "Londonderry": { name: "Doire", lang: "Irish Gaelic" },
    "Tyrone": { name: "Tír Eoghain", lang: "Irish Gaelic" }
  };

  fetch('./counties_simplified8.json')
    .then(res => res.ok ? res.json() : Promise.reject(`Failed: ${res.status}`))
    .then(data => {
      const pastelColors = ["#ffdede","#dedefd","#deffde","#fff0de","#fdefff","#dfffee","#ffe7de","#f0deff","#defff5","#fdeeee","#e6f7ff","#f9ffe6","#fff6e6","#e6e6ff","#ffe6f2"];
      data.features.forEach((f, i) => f.properties.color = pastelColors[i % pastelColors.length]);

      L.geoJSON(data, {
        style: f => ({ color: "#333", weight: 1, fillColor: f.properties.color, fillOpacity: 0.35 }),
        onEachFeature: (feature, layer) => {
          const englishName = feature.properties.NAME;
          const langEntry = countyLanguages[englishName];
          const centroid = turf.centroid(feature);
          const lat = centroid.geometry.coordinates[1];
          const lon = centroid.geometry.coordinates[0];

          layer.on('add', () => {
            const text = langEntry ? `${englishName} (${langEntry.lang}: ${langEntry.name})` : englishName;
            layer.bindTooltip(text, { direction: 'center', className: 'county-tooltip' });
          });

          layer.on('click', () => {
            updateCountyCard(englishName, layer, lat, lon);
            if (window.innerWidth <= 1024) sidebar.classList.add('visible');
            map.fitBounds(layer.getBounds());
          });

          layer.on('mouseover', () => layer.setStyle({ weight: 2 }));
          layer.on('mouseout', () => layer.setStyle({ weight: 1 }));
        }
      }).addTo(map);

      map.invalidateSize();
      infoDiv.innerHTML = '<em>No county selected.</em>';
    })
    .catch(err => {
      console.error(err);
      infoDiv.innerHTML = '<em style="color:red;">Failed to load map data. Is counties_simplified8.json in the same folder?</em>';
    });

  L.Control.geocoder({ defaultMarkGeocode: true, placeholder: 'Search town, village, postcode…' }).addTo(map);

  window.places = []; let fuse = null; let searchMarker = null;
  function parseCSVLine(line) {
    const cols = []; const regex = /(?:\"([^\"]*)\"|([^,]+))/g; let m;
    while ((m = regex.exec(line)) !== null) cols.push(m[1] || m[2] || '');
    return cols;
  }
  function initFuse() { if (window.places.length) fuse = new Fuse(window.places, { keys: ['name', 'county'], threshold: 0.3 }); }
  function showDropdown(results) {
    searchDropdown.innerHTML = '';
    if (!results.length) { searchDropdown.style.display = 'none'; return; }
    results.slice(0, 10).forEach(r => {
      const div = document.createElement('div');
      div.style.cssText = 'padding:8px 12px; cursor:pointer; border-bottom:1px solid #eee; font-size:0.9rem;';
      div.textContent = `${r.item.name}, ${r.item.county || ''}`;
      div.onmouseover = () => div.style.backgroundColor = '#f5f5f5';
      div.onmouseout = () => div.style.backgroundColor = '';
      div.onclick = () => selectPlace(r.item);
      searchDropdown.appendChild(div);
    });
    searchDropdown.style.display = 'block';
  }
  function selectPlace(place) {
    if (searchMarker) map.removeLayer(searchMarker);
    searchMarker = L.marker([place.lat, place.lon]).addTo(map)
      .bindPopup(`<b>${place.name}</b><br>${place.county}`).openPopup();
    map.setView([place.lat, place.lon], 11);
    searchDropdown.style.display = 'none';
    searchInput.value = place.name;
    setTimeout(() => showCountyFromPoint(place.lat, place.lon), 500);
  }

  function showCountyFromPoint(lat, lon) {
    const point = turf.point([lon, lat]);
    let found = null;
    map.eachLayer(l => {
      if (l instanceof L.GeoJSON) {
        l.eachLayer(cl => {
          if (cl.getBounds && cl.getBounds().contains([lat, lon]) && turf.booleanPointInPolygon(point, cl.feature)) {
            found = cl;
          }
        });
      }
    });
    if (found) {
      const englishName = found.feature.properties.NAME;
      const centroid = turf.centroid(found.feature);
      const clat = centroid.geometry.coordinates[1];
      const clon = centroid.geometry.coordinates[0];
      updateCountyCard(englishName, found, clat, clon);
      if (window.innerWidth <= 1024) sidebar.classList.add('visible');
    } else {
      infoDiv.innerHTML = '<em>County not found.</em>';
    }
  }

  fetch('places_clean.csv')
    .then(r => r.text())
    .then(text => {
      const lines = text.trim().split('\n'); lines.shift();
      lines.forEach(line => {
        const c = parseCSVLine(line);
        const name = c[0], desc = c[2], county = c[3], lat = parseFloat(c[6]), lon = parseFloat(c[7]);
        if ((desc === 'LOC' || desc === 'PAR') && name && !isNaN(lat) && !isNaN(lon)) {
          window.places.push({ name, county, lat, lon });
        }
      });
      initFuse();
    });

  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim();
    if (!q || !fuse) { searchDropdown.style.display = 'none'; return; }
    showDropdown(fuse.search(q));
  });
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && fuse) {
      const res = fuse.search(searchInput.value.trim());
      if (res.length) selectPlace(res[0].item);
    }
  });
  document.addEventListener('click', e => {
    if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
      searchDropdown.style.display = 'none';
    }
  });
};
</script>
</body>
</html>


