<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Historic Counties Interactive Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.min.js"></script><script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.min.js"></script>
<style>
:root {
  --bg: #faf4e6; --card-bg: #f3e9da; --text: #333; --border: #ccc;
  --shadow: rgba(0,0,0,0.2); --accent: #9B2C2C; --tooltip-bg: rgba(255,255,255,0.9);
}
html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
#container { display:flex; height:100%; }
#logo-container { text-align:center; margin-bottom:10px; }
#sidebar-logo { max-width:50%; height:auto; display:block; margin:0 auto; opacity:0; transform:scale(0.9); animation:logoLoad 1.4s ease-out forwards; }
@keyframes logoLoad { 0% { opacity:0; transform:scale(0.9) translateY(10px); } 60% { opacity:1; transform:scale(1.02); } 100% { opacity:1; transform:scale(1); } }
#logo-link { display:block; transition:opacity .25s ease; } #logo-link:hover { opacity:.85; }
#sidebar { width:340px; background:var(--bg); padding:15px; overflow-y:auto; border-right:1px solid var(--border); transition:all .3s ease; position:relative; color:var(--text); }
#search-bar { margin-top:15px; display:flex; gap:6px; align-items:center; justify-content:center; }
#search-bar input { flex:1; min-width:140px; padding:10px 12px; border:1px solid var(--border); border-radius:4px; font-size:.9rem; color:var(--text); background:#fff; box-shadow:0 2px 4px var(--shadow); transition:all .25s; }
#search-bar input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(155,44,44,.2); }
#search-bar button { padding:10px 18px; background:var(--accent); color:#FAF4E6; border:none; border-radius:4px; font-weight:500; box-shadow:0 3px 6px var(--shadow); cursor:pointer; transition:all .25s cubic-bezier(.4,0,.2,1); }
#search-bar button:hover { background:#7a2222; transform:translateY(-2px) scale(1.05); box-shadow:0 6px 14px var(--shadow); }
 
/* -------------------------------------------------
   Subdivision buttons ‚Äì same style as Search / i-btn
   ------------------------------------------------- */
#subdivision-buttons {
  margin: 16px 0;
  display: flex;
  gap: 6px;
  justify-content: center;
  align-items: center;
  padding: 0 8px;
  overflow-x: auto;           /* ‚Üê Allows scrolling if needed */
  scrollbar-width: thin;
  -ms-overflow-style: none;
}

#subdivision-buttons::-webkit-scrollbar {
  display: none;
}

/* Desktop & Tab: Force one line */
@media (min-width: 768px) {
  #subdivision-buttons {
    flex-wrap: nowrap !important;
  }
}

/* Mobile: Allow wrap */
@media (max-width: 767px) {
  #subdivision-buttons {
    flex-wrap: wrap;
  }
}

.subdivision-btn {
  padding: 8px 14px;
  background: var(--accent);
  color: #FAF4E6;
  border: none;
  border-radius: 4px;
  font-weight: 500;
  font-size: .85rem;
  box-shadow: 0 3px 6px var(--shadow);
  cursor: pointer;
  transition: all .25s cubic-bezier(.4,0,.2,1);
  white-space: nowrap;
  flex-shrink: 0;             /* ‚Üê Prevents squashing */
  min-width: 70px;
}

.subdivision-btn:hover {
  background: #7a2222;
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 14px var(--shadow);
}

.subdivision-btn.active {
  background: #666;
  box-shadow: inset 0 2px 4px rgba(0,0,0,.2);
  transform: none;
}

.subdivision-btn.clear {
  background: #777 !important;     /* Slightly lighter than active */
  color: #FAF4E6;
  font-weight: 500 !important;      /* ‚Üê Force same weight */
  order: 999;
  min-width: 40px;
  opacity: 0.95;
  box-shadow: 0 3px 6px var(--shadow); /* ‚Üê Same shadow as others */
}
.subdivision-btn.clear:hover {
  background: #666 !important;
  opacity: 1;
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 14px var(--shadow);
}

.subdivision-label > div {
  background: #f3e9da !important;      /* Cream background */
  color: #9B2C2C !important;           /* Red text */
  border: 1px solid #9B2C2C !important; /* Red border */
  padding: 4px 8px !important;
  border-radius: 6px !important;
  font-weight: 600 !important;
  font-size: 0.78rem !important;
  text-align: center !important;
  white-space: normal !important;
  line-height: 1.3 !important;
  max-width: 180px !important;
  word-wrap: break-word !important;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
}

/* Optional: subtle hover (same as 'i' button) */
.subdivision-label:hover > div {
  background: #9B2C2C !important;
  color: #f3e9da !important;
  transform: scale(1.03);
  transition: all 0.2s ease;
}
#map { flex:1; background:#e0f2fe; height: 100vh; }
/* ---- CARD LAYOUT WITH FLAG ---- */
.county-card {
  background:var(--card-bg); padding:14px; border-radius:10px;
  box-shadow:0 2px 6px var(--shadow); transition:all .3s ease;
  cursor:pointer; text-align:center; margin-bottom:16px;
}
.county-card:hover { transform:translateY(-6px); box-shadow:0 8px 18px var(--shadow); }
.county-card .flag {
  width:64px; height:auto; border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.25); margin:0 auto 12px;
  display:block;
}
.county-card .card-body { }
.county-card h3 {
  margin:0 0 12px; font-size:1.25rem; color:var(--text);
  word-wrap:break-word; line-height:1.3; text-align:center;
}
.weather-badge { display:inline-block; font-size:0.82rem; background:rgba(0,0,0,0.1); color:var(--text); padding:6px 12px; border-radius:16px; font-weight:500; box-shadow:0 1px 3px rgba(0,0,0,0.12); }
.weather-underline { width:60px; height:2px; background:var(--accent); margin:8px auto 12px; border-radius:1px; }
.county-card p, .county-card ul { margin:6px 0; }
.county-card a { color:#0066cc; text-decoration:none; } .county-card a:hover { text-decoration:underline; }
.leaf-tooltip.county-tooltip { background:var(--tooltip-bg); border:1px solid var(--accent); color:var(--text); font-weight:bold; padding:2px 6px; border-radius:4px; }
 
/* COUNTY HOVER TOOLTIPS ‚Äì PERFECT STYLE + ALWAYS VISIBLE + ZERO FLICKER */
.leaflet-tooltip {
  background: #f3e9da !important;
  color: #9B2C2C !important;
  border: 1.5px solid #9B2C2C !important;
  padding: 6px 10px !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  font-size: 0.88rem !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
  transition: all 0.15s ease !important;
  pointer-events: none !important;
}

/* Hover flip effect */
.leaflet-tooltip:hover {
  background: #9B2C2C !important;
  color: #f3e9da !important;
  transform: scale(1.05);
}
  /* Instant clean pop-in ‚Äì no diagonal swipe, no fade */
.leaflet-tooltip {
  animation: none !important;
  transition: none !important;   /* removes the slight fade too if you want it 100% instant */
}

/* MOBILE: RESPONSIVENESS */
@media (max-width:1024px) {
  #container { flex-direction:column; }
  #sidebar {
    position:fixed; bottom:16px; left:16px; width:45vw; max-width:380px; max-height:50vh;
    background:var(--bg); border-radius:14px; box-shadow:0 6px 20px var(--shadow);
    padding:14px; overflow-y:auto; transform:translateY(120%);
    transition:transform .32s cubic-bezier(.4,0,.2,1); z-index:1000;
    display:block !important; font-size:.94rem;
  }
  #sidebar.visible { transform:translateY(0); }
  #map { height:100vh !important; }
  #sidebar-logo { max-width:50%; }

  /* ‚Üê THIS IS NOW THE ONLY CLOSE BUTTON STYLE IN THE ENTIRE FILE ‚Üí */
  #closeSidebar {
    display: flex !important;
    position: absolute;
    top: 12px;
    right: 12px;
    width: 44px;
    height: 44px;
    font-size: 28px;
    font-weight: bold;
    color: #999;
    background: none;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: all .2s;
  }
  #closeSidebar:hover {
    color: #555;
    background: rgba(0,0,0,0.05);
  }
}
@media (max-width:480px) { 
  #sidebar { width:90vw; left:5vw; max-width:none; } 
  #sidebar-logo { max-width:55%; } 
}
  .subdivision-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
.subdivision-btn.loading {
  position: relative;
  color: transparent !important;
}
.subdivision-btn.loading::after {
  content: '';
  position: absolute;
  width: 14px;
  height: 14px;
  top: 50%;
  left: 50%;
  margin-left: -7px;
  margin-top: -7px;
  border: 2px solid #FAF4E6;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
  .subdivision-btn .spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid #FAF4E6;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
/* 2√ó2 Grid for Lincolnshire ‚Äî TRUE 2√ó2 */
#subdivision-buttons.has-4 {
  display: grid !important;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto auto;
  gap: 6px;
  justify-items: stretch;
  align-items: stretch;
  overflow: visible !important;
  padding: 4px 0;
}

#subdivision-buttons.has-4 .subdivision-btn {
  width: 100%;
  max-width: none !important;
  white-space: normal;
  padding: 8px 6px;
  font-size: 0.82rem;
  margin: 0;
  text-align: center;
}

/* Explicit placement: 2 on top, 2 on bottom */
#subdivision-buttons.has-4 .subdivision-btn:nth-child(1) { grid-area: 1 / 1; }
#subdivision-buttons.has-4 .subdivision-btn:nth-child(2) { grid-area: 1 / 2; }
#subdivision-buttons.has-4 .subdivision-btn:nth-child(3) { grid-area: 2 / 1; }
#subdivision-buttons.has-4 .subdivision-btn:nth-child(4) { grid-area: 2 / 2; }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ZOOM BUTTONS ‚Äì EXACTLY LIKE SUBDIVISION BUTTONS & LABELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.leaflet-control-zoom a {
  background: #f3e9da !important;      /* cream background */
  color: #9B2C2C !important;           /* red + and ‚Äì */
  font-weight: 600 !important;
  font-size: 20px !important;
  line-height: 36px !important;
  width: 36px !important;
  height: 36px !important;
  border: 1.5px solid #9B2C2C !important;
  border-radius: 6px !important;
  box-shadow: 0 3px 8px rgba(0,0,0,0.25) !important;
  transition: all .25s cubic-bezier(.4,0,.2,1) !important;
}

.leaflet-control-zoom a:hover {
  background: #9B2C2C !important;      /* red background on hover */
  color: #f3e9da !important;           /* cream + and ‚Äì on hover */
  transform: translateY(-3px) scale(1.08) !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.3) !important;
}

/* Optional small spacing from edge */
.leaflet-control-zoom {
  margin-top: 12px !important;
  margin-left: 12px !important;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MAGNIFYING GLASS SEARCH BUTTON (the real one under the 'i') ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.leaflet-control-search .search-button,
.leaflet-control-search a {
  background: #f3e9da !important;       /* cream background */
  color: #9B2C2C !important;            /* red magnifying glass */
  border: 1.5px solid #9B2C2C !important;
  border-radius: 6px !important;
  box-shadow: 0 3px 8px rgba(0,0,0,0.25) !important;
  width: 36px !important;
  height: 36px !important;
  line-height: 36px !important;
  font-size: 18px !important;
  transition: all .25s cubic-bezier(.4,0,.2,1) !important;
  display: flex !important;
  align-items: center;
  justify-content: center;
}

.leaflet-control-search .search-button:hover,
.leaflet-control-search a:hover {
  background: #9B2C2C !important;
  color: #f3e9da !important;
  transform: translateY(-3px) scale(1.08) !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.3) !important;
}

/* Makes the little magnifying-glass SVG take the colour */
.leaflet-control-search .search-button svg {
  fill: currentColor !important;
}
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FINAL DROP-PIN POPUPS ‚Äì TIGHT, DYNAMIC SIZE + PERFECT FLIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.leaflet-popup-content-wrapper {
  background: #f3e9da !important;
  color: #9B2C2C !important;
  border: 1.5px solid #9B2C2C !important;
  border-radius: 8px !important;
  box-shadow: 0 3px 12px rgba(0,0,0,0.25) !important;
  padding: 6px 9px !important;        /* ‚Üê reduced from 8px 12px */
  font-weight: 600 !important;
  font-size: 0.88rem !important;
  line-height: 1.35 !important;
  transition: all 0.2s ease !important;
  max-width: none !important;          /* ‚Üê allows very long names to wrap */
  width: auto !important;              /* ‚Üê this is the magic: size-to-content */
}

/* Text inside inherits colour perfectly */
.leaflet-popup-content,
.leaflet-popup-content * {
  color: inherit !important;
  font-weight: 600 !important;
  margin: 0 !important;                /* ‚Üê removes Leaflet‚Äôs default margins */
}

/* Hover flip ‚Äì unchanged */
.leaflet-popup-content-wrapper:hover {
  background: #9B2C2C !important;
  color: #f3e9da !important;
  transform: scale(1.04);
}

/* Tip arrow */
.leaflet-popup-tip {
  background: #f3e9da !important;
  border: 1.5px solid #9B2C2C !important;
}
.leaflet-popup:hover .leaflet-popup-tip {
  background: #9B2C2C !important;
}
  /* Centre all Leaflet popup content */
.leaflet-popup-content {
    text-align: center;
}

/* Tablet: 2 columns */
@media (min-width: 768px) and (max-width: 1024px) {
  .news-card {
    flex: 1 1 calc(50% - 1rem); /* 2 columns */
  }
}

/* Mobile: 1 column */
@media (max-width: 767px) {
  .news-card {
    flex: 1 1 100%; /* full width */
  }
}

/* Optional: make excerpt fill remaining space so "Read More" aligns at bottom */
.news-card .wp-block-post-excerpt {
  flex-grow: 1;
}

@media screen and (max-width: 600px) {
  .news-grid .news-container {
    grid-template-columns: 1fr; /* 1 column on mobile */
  }
}
  .leaflet-control a { cursor: pointer; }

</style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <button id="closeSidebar" title="Close panel" aria-label="Close panel"
            style="position:absolute;top:12px;right:12px;background:none;border:none;
                   font-size:28px;font-weight:bold;color:#999;cursor:pointer;
                   width:40px;height:40px;border-radius:50%;display:flex;
                   align-items:center;justify-content:center;transition:all .2s;">
      √ó
    </button>
    <div id="logo-container">
      <div id="logo-link" style="cursor:pointer;" onclick="resetMapAndSidebar()" title="Reset map">
        <img src="https://realcounties.wordpress.com/wp-content/uploads/2025/06/logo-full-trans-16-6-25.png" alt="Reset Map - Historic Counties" id="sidebar-logo">
      </div>
    </div>
    <h2>Interactive Map</h2>
    <p>Select a county to view details.</p>
    <div id="info" class="loading"><em>Loading counties...</em></div>
    <div id="subdivision-buttons"></div>
    <div id="search-bar">
      <input type="text" id="placeSearch" placeholder="Search for a place...">
      <button id="searchBtn">Search</button>
    </div>
    <div id="searchDropdown" style="position:absolute;background:white;border:1px solid #ccc;max-height:200px;overflow-y:auto;width:calc(100% - 60px);display:none;z-index:1001;margin-top:5px;box-shadow:0 4px 8px rgba(0,0,0,0.1);"></div>
  </div>
  <div id="map"></div>
</div>

<script>
window.onload = function() {
  let subdivisionLabels = []; // ‚Üê Make sure this is at the top with other lets
  const sidebar = document.getElementById('sidebar');
  const closeBtn = document.getElementById('closeSidebar');
  const infoDiv = document.getElementById('info');
  const searchInput = document.getElementById('placeSearch');
  const searchDropdown = document.getElementById('searchDropdown');
  
  // Close ONLY the sidebar + clear the county card ‚Äî nothing else is touched
document.getElementById('closeSidebar').addEventListener('click', () => {
  const infoDiv = document.getElementById('info');
  const sidebar = document.getElementById('sidebar');
  
  infoDiv.innerHTML = '<em>Click a county to explore.</em>';
  infoDiv.scrollTop = 0;
  sidebar.classList.remove('visible');   // closes sidebar on mobile & desktop
});

  // Initialize Leaf map
  const map = L.map('map', { center: [54.5, -3], zoom: 6, minZoom: 5 });
  // === ADD LABEL VISIBILITY ON ZOOM ===


  map.on('zoomend', () => {
    const showLabels = map.getZoom() >= 9;
    subdivisionLabels.forEach(label => {
      if (showLabels && !map.hasLayer(label)) {
        label.addTo(map);
      } else if (!showLabels && map.hasLayer(label)) {
        map.removeLayer(label);
      }
    });
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> | <a href="https://county-borders.co.uk" target="_blank">Historic County Borders Project</a>',
    maxZoom: 19
  }).addTo(map);

  const ukBounds = L.latLngBounds([49.5, -8.5], [60.9, 2.0]);
  map.setMaxBounds(ukBounds);
  map.fitBounds(ukBounds);
  setTimeout(() => map.invalidateSize(), 400);

  // === BRANDED INFO BUTTON (i ICON) ===
  const toggleButton = L.control({ position: 'topright' });
  toggleButton.onAdd = function() {
    const btn = L.DomUtil.create('button', 'leaf-bar leaflet-control');
    btn.innerHTML = 'i';
    btn.title = 'Show county info';
    btn.setAttribute('aria-label', 'Show county info');
    btn.style.cssText = `
      background: #f3e9da;
      color: #9B2C2C;
      border: 1px solid #9B2C2C;
      width: 34px;
      height: 34px;
      font-size: 18px;
      font-weight: bold;
      font-family: Arial, sans-serif;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.25s ease;
    `;
    btn.onmouseover = () => {
      btn.style.background = '#9B2C2C';
      btn.style.color = '#f3e9da';
    };
    btn.onmouseout = () => {
      btn.style.background = '#f3e9da';
      btn.style.color = '#9B2C2C';
    };
    btn.onclick = () => sidebar.classList.toggle('visible');
    return btn;
  };
  toggleButton.addTo(map);

  // Reset function ‚Äî FULL RESET INCLUDING SUBDIVISIONS
  window.resetMapAndSidebar = function() {
    // 1. Reset map view
    map.fitBounds(ukBounds);

    // 2. Reset info panel
    infoDiv.innerHTML = '<em>Click a county to explore.</em>';
    infoDiv.scrollTop = 0;

    // 3. Reset county highlight
    if (currentLayer) {
      currentLayer.setStyle({ weight: 1, fillOpacity: 0.35 });
      currentLayer = null;
    }

    // 4. Reset search
    if (searchMarker) {
      map.removeLayer(searchMarker);
      searchMarker = null;
    }
    searchInput.value = '';
    searchDropdown.style.display = 'none';

    // 5. === REMOVE SUBDIVISION LAYER & LABELS ===
    if (subdivisionLayer) {
      map.removeLayer(subdivisionLayer);
      subdivisionLayer = null;
    }
    subdivisionLabels.forEach(label => {
      if (map.hasLayer(label)) map.removeLayer(label);
    });
    subdivisionLabels = [];

    // 6. === CLEAR SUBDIVISION STATE & BUTTONS ===
    activeSubdivision = null;
    const subdivBox = document.getElementById("subdivision-buttons");
    if (subdivBox) {
      subdivBox.innerHTML = "";
      subdivBox.className = "";
    }

    // 7. Reset any lingering button states
    document.querySelectorAll('.subdivision-btn').forEach(btn => {
      if (btn.textContent.startsWith('Hide')) {
        const type = btn.dataset.type || 'Subdivision';
        btn.textContent = `Show ${type}`;
        btn.classList.remove('active', 'loading');
        btn.disabled = false;
      }
    });

    // 8. Close sidebar on mobile
    if (window.innerWidth <= 1024) {
      sidebar.classList.remove('visible');
    }
  };
  // AUTO-DETECT VISITOR'S HISTORIC COUNTY ‚Äì MOBILE-FRIENDLY + NO BOLD
  const tryDetectLocation = () => {
    if ('geolocation' in navigator) {
      const detectMsg = L.control({position: 'bottomright'});
      detectMsg.onAdd = function() {
        const div = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
        div.innerHTML = 'Locating‚Ä¶';
        div.style.cssText = 'background:#f3e9da; color:#9B2C2C; padding:6px 12px; border-radius:8px; font-weight:600; box-shadow:0 3px 10px rgba(0,0,0,0.25); font-size:0.9rem;';
        return div;
      };
      detectMsg.addTo(map);

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          let foundLayer = null;
          map.eachLayer(layer => {
            if (layer instanceof L.GeoJSON) {
              layer.eachLayer(poly => {
                if (poly.getBounds?.().contains([lat, lon]) &&
                    turf.booleanPointInPolygon(turf.point([lon, lat]), poly.feature)) {
                  foundLayer = poly;
                }
              });
            }
          });

          map.removeControl(detectMsg);

          if (foundLayer) {
            const countyName = foundLayer.feature.properties.NAME;
            const toast = L.control({position: 'bottomright'});
            toast.onAdd = () => {
              const div = L.DomUtil.create('div', 'leaflet-control');
              div.innerHTML = `You are in<br><span style="color:#9B2C2C;font-size:1.15em;">${countyName}</span>`;
              div.style.cssText = 'background:#f3e9da; border:2px solid #9B2C2C; color:#333; padding:12px 16px; border-radius:10px; text-align:center; box-shadow:0 6px 20px rgba(0,0,0,0.3); margin:12px; font-weight:600; line-height:1.4;';
              setTimeout(() => map.removeControl(toast), 8000);
              return div;
            };
            toast.addTo(map);
            foundLayer.fire('click');
          } else {
            const toast = L.control({position: 'bottomright'});
            toast.onAdd = () => {
              const div = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
              div.innerHTML = 'Outside the<br>historic counties';
              div.style.cssText = 'background:#f3e9da; color:#666; padding:8px 12px; border-radius:8px; margin:12px; font-weight:600;';
              setTimeout(() => map.removeControl(toast), 5000);
              return div;
            };
            toast.addTo(map);
          }
        },
        () => map.removeControl(detectMsg),
        { timeout: 12000, maximumAge: 300000, enableHighAccuracy: true }
      );
    }
  };

  // Desktop: run immediately
  if (window.innerWidth > 1024) tryDetectLocation();

  // Mobile/tablet: run the first time they tap the "i" button
  toggleButton.getContainer().addEventListener('click', function runOnce() {
    tryDetectLocation();
    toggleButton.getContainer().removeEventListener('click', runOnce);
  }, { once: true });

  // County flags
  const countyFlags = {
    "Aberdeenshire": "https://realcounties.com/wp-content/uploads/2023/11/aberdeenshire-flag.png",
    "Anglesey": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/anglesey.png",
    "Banffshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/banffshire-flag-1.jpg",
    "Berkshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/berkshire.png",
    "Berwickshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/berwickshire.png",
    "Buckinghamshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/buckinghamshire.png",
    "Caernarfonshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/caernarfonshire.png",
    "Caithness": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/caithness-flag.png",
    "Cambridgeshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/cambridgeshire.png",
    "Cheshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/cheshire.png",
    "Cornwall": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/cornwall.png",
    "Cumberland": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/cumberland.png",
    "Derbyshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/derbyshire.jpg",
    "Devon": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/devon.jpg",
    "Dorset": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/dorset.jpg",
    "Durham": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/county-durham.png",
    "East Lothian": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/east-lothian-flag.png",
    "Essex": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/essex.jpg",
    "Flintshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/flintshire.png",
    "Glamorgan": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/glamorgan.png",
    "Gloucestershire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/gloucestershire.png",
    "Hampshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/hampshire.png",
    "Herefordshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/herefordshire.png",
    "Hertfordshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/hertfordshire.png",
    "Huntingdonshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/huntingdonshire.png",
    "Kent": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/kent.png",
    "Kirkcudbrightshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/kirkcudbrightshire-flag.png",
    "Lancashire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/lancashire.png",
    "Leicestershire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/leicestershire.png",
    "Lincolnshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/lincolnshire.png",
    "Merionethshire": "https://realcounties.com/wp-content/uploads/2023/11/merioneth.png",
    "Middlesex": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/middlesex.png",
    "Monmouthshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/monmouthshire.png",
    "Morayshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/morayshire-flag-2.jpg",
    "Norfolk": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/norfolk.png",
    "Northamptonshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/northamptonshire.png",
    "Northumberland": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/northumberland.jpg",
    "Nottinghamshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/nottinghamshire.jpg",
    "Orkney": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/orkney-flag.png",
    "Oxfordshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/oxfordshire.png",
    "Pembrokeshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/pembrokeshire.png",
    "Rutland": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/rutland.png",
    "Shetland": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/shetland-flag.png",
    "Shropshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/shropshire.png",
    "Somerset": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/somerset.png",
    "Staffordshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/staffordshire.png",
    "Suffolk": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/suffolk.png",
    "Surrey": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/surrey.png",
    "Sussex": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/sussex.png",
    "Sutherland": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/sutherland-flag.png",
    "Warwickshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/warwickshire.png",
    "Westmorland": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/westmorland.jpg",
    "Wiltshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/wiltshire.png",
    "Worcestershire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/worcestershire.png",
    "Yorkshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/yorkshire.jpg"
  };

  async function fetchWeather(lat, lon) {
    try {
      const res = await axios.get(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m`);
      const temp = Math.round(res.data.current.temperature_2m);
      const code = res.data.current.weather_code;
      const windKmh = res.data.current.wind_speed_10m;
      const windMph = Math.round(windKmh * 0.621371);
      const descMap = {
        0: 'Clear', 1: 'Mostly clear', 2: 'Partly cloudy', 3: 'Overcast',
        45: 'Fog', 48: 'Fog', 51: 'Light drizzle', 53: 'Drizzle', 55: 'Heavy drizzle',
        61: 'Light rain', 63: 'Rain', 65: 'Heavy rain',
        71: 'Light snow', 73: 'Snow', 75: 'Heavy snow',
        80: 'Showers', 81: 'Rain showers', 82: 'Heavy showers', 95: 'Thunderstorm'
      };
      const desc = descMap[code] || 'Unknown';
      return { temp, desc, wind: windMph };
    } catch (err) {
      console.error("Weather fetch failed:", err);
      return null;
    }
  }
  let currentLayer = null;
  let subdivisionLayer = null;

  // Load county data
  fetch('./counties_simplified8.json')
    .then(res => res.ok ? res.json() : Promise.reject(`Failed: ${res.status}`))
    .then(data => {
      const countyData = {
        "Aberdeenshire": { area: 1950, population: 380495, events: ["Battle of Harlaw (1411)", "Siege of Aberdeen (1646)", "North Sea oil discovered (1960s)"], landmarks: ["Slains Castle", "Balmoral Castle", "Craigievar Castle"], notablePersons: ["John Barbour, author (c.1320-1395)", "James Gregory, mathematician (1638-1675)", "Annie Lennox, singer (1954-present)"] },
        "Anglesey": { area: 277, population: 69751, events: ["Roman invasion repelled (60 AD)", "Glynd≈µr Rebellion (1400-1415)", "Menai Bridge opened (1826)"], landmarks: ["Beaumaris Castle", "South Stack Lighthouse", "Menai Suspension Bridge"], notablePersons: ["Henry Rowlands, antiquarian (1655‚Äì1723)", "Goronwy Owen, poet (1723‚Äì1769)", "Dawn French, comedian (1957-present)"] },
        "Angus": { area: 899, population: 264044, events: ["Battle of Nechtansmere (AD 685)", "Battle of Arbroath (1445)", "Birth of Military Aviation (1913)"], landmarks: ["Glamis Castle", "Arbroath Abbey", "Lunan Bay"], notablePersons: ["Hector Boece, historian (c.1465‚Äì1536)", "J.M. Barrie, author (1860‚Äì1937)", "Violet Jacob, novelist (1863‚Äì1946)"] }, 
        "Antrim": { area: 1175, population: 615701, events: ["Titanic built, Belfast (1912)", "Giant's Causeway formed (~60M BC)"], landmarks: ["Giant's Causeway", "Carrickfergus Castle", "Dark Hedges"], notablePersons: ["St Patrick, patron of Ireland (c.385‚Äì461)", "James McCosh, philosopher (1811‚Äì1894)", "Liam Neeson, actor (1952‚Äìpresent)"] },
        "Argyllshire": { area: 3110, population: 64819, events: ["Iona Abbey founded (563 AD)", "Glencoe Massacre (1692)"], landmarks: ["Iona Abbey", "Inveraray Castle", "Oban Distillery"], notablePersons: ["Duncan Ban MacIntyre, poet (1724‚Äì1812)", "Neil Munro, author (1863‚Äì1930)", "John Smith, Labour Leader (1938‚Äì1994)"] },
        "Armagh": { area: 512, population: 178598, events: ["St. Patrick founds cathedral (445 AD)", "Armagh Observatory (1790)"], landmarks: ["Armagh Cathedral", "Navan Fort", "Armagh Planetarium"], notablePersons: ["Richard Kane, Minorca Governor (1662‚Äì1736)", "T.R. Robinson, astronomer (1792‚Äì1882)", "Seamus Heaney, poet (1939‚Äì2013)"] },
        "Ayrshire": { area: 1129, population: 367676, events: ["Ayr made Royal burgh (1205)", "Battle of Largs (1263)", "Ayr FC founded (1879)"], landmarks: ["Culzean Castle", "Burns Cottage", "Laigh Milton Viaduct"], notablePersons: ["Alexander Peden, preacher (1626‚Äì1686)", "Robert Burns, poet (1759‚Äì1796)", "Kris Boyd, footballer (1983-present)"] },
        "Banffshire": { area: 641, population: 46537, events: ["Battle of Mortlach (1010)", "Battle of Glenlivet (1594)", "Banff Bridge built (1779)"], landmarks: ["Duff House", "Balvenie Castle", "Glenfiddich Distillery"], notablePersons: ["James Ferguson, astronomer (1710‚Äì1776)", "Thomas Edward, naturalist (1814‚Äì1886)", "James Naughtie, journalist (1951‚Äìpresent)"] },
        "Bedfordshire": { area: 468, population: 602847, events: ["Seige of Bedford Castle (1224)", "Bedford Infirmary established (1803)", "Woburn Safari Park (1970)"], landmarks: ["De Grey Mausoleum", "Summeries Castle", "Woburn Abbey"], notablePersons: ["John Bunyan, author (1628‚Äì1688)", "John Crawley, parliamentarian (1760‚Äì1836)", "Paul Young, singer (1956‚Äìpresent)"] },
        "Berkshire": { area: 722, population: 842804, events: ["Battle of Reading (871)", "Re-Foundation of Abingdon Abbey (1080s)", "Declared Royal County (1957)"], landmarks: ["Ascot Racecourse", "Uffington White Horse", "Windsor Castle"], notablePersons: ["üëë Alfred the Great (849‚Äì899)", "Kenneth Grahame, author (1859‚Äì1932)", "Kate Winslet, actress (1975‚Äìpresent)"] },
        "Berwickshire": { area: 457, population: 26458, events: ["Seige of Berwick (1333)", "Duns destroyed (1545)", "Berwickshire Naturalists Club (1831)"], landmarks: ["Duns Castle", "Paxton House", "St Abb‚Äôs Head"], notablePersons: ["Duns Scotus, philosopher (c.1266‚Äì1308)", "David Hume, philosopher (1711‚Äì1776)", "Thomas McCrae, physician (1870‚Äì1935)"] },
        "Brecknockshire": { area: 742, population: 67598, events: ["Norman conquest of Brycheiniog (1093)", "Brecknockshire Agricultural Society (1755)", "Brecon & Merthyr Railway (1863)"], landmarks: ["Brecon Beacons", "Brecon Cathedral", "Llangorse Lake"], notablePersons: ["Hywel ap Rhys, prince (c.1270‚Äì1330)", "Sarah Siddons, actress (1755‚Äì1831)", "Roger Glover, songwriter (1945‚Äìpresent)"] },
        "Buckinghamshire": { area: 746, population: 916903, events: ["Stony Stratford Market (1194)", "Eton College founded (1440)", "Bletchley Park breaks Enigma (1940)"], landmarks: ["Bletchley Park", "Stowe House", "Eton College"], notablePersons: ["John Hampden, parliamentarian (1594‚Äì1643)", "William Herschel, astronomer (1738‚Äì1822)", "Roald Dahl, author (1916‚Äì1990)"] },
        "Buteshire": { area: 225, population: 12534, events: ["Rothesay Castle built (1200s)", "Rothesay Castle destroyed (1685)", "Mount Stuart completed (1879)"], landmarks: ["Rothesay Castle", "Mount Stuart House", "Bute Museum"], notablePersons: ["Ninian Stewart, Lord Treasurer (c.1540‚Äì1609)", "John Stuart, Prime Minister (1713‚Äì1792)", "Lena Zavaroni, singer (1963-1999)"] },
        "Caernarfonshire": { area: 563, population: 139065, events: ["Edward I builds castle (1283)", "County established (1284)", "Prince Charles investiture (1969)"], landmarks: ["Caernarfon Castle", "Snowdon", "Llanberis Slate Museum"], notablePersons: ["üëë Gruffudd ap Cynan (c.1055‚Äì1137)", "William Morgan, Bible translator (1545‚Äì1604)", "T.E. Lawrence, L. of Arabia (1888‚Äì1935)"] },
        "Caithness": { area: 618, population: 26486, events: ["Castle of Old Wick (1159)", "Caithness Grain Riots (1847)", "Dounreay nuclear site (1955)"], landmarks: ["Castle of Mey", "John o‚Äô Groats", "Duncansby Stacks"], notablePersons: ["John o' Groat (legendary, c.1500s)", "Sir John Sinclair, parliamentarian (1754‚Äì1835)", "Martin Henderson, actor (1974‚Äìpresent)"] },
        "Cambridgeshire": { area: 858, population: 460448, events: ["Settled by Angles (6th Century)", "Cambridge University (1209)", "Fens drained (1630s)"], landmarks: ["King‚Äôs College Chapel", "Ely Cathedral", "Duxford IWM"], notablePersons: ["Thomas Hobson, carrier (1544‚Äì1631)", "Samuel Pepys, diarist (1633‚Äì1703)", "Syd Barrett, singer (1946‚Äì2006)"] },
        "Cardiganshire": { area: 693, population: 75784, events: ["Arrival of Christianity (5th Century)", "Gerard of Wales's journey (1188)", "Aberystwyth University (1872)"], landmarks: ["Devil‚Äôs Bridge", "Strata Florida Abbey", "Vale of Rheidol Railway"], notablePersons: ["Dafydd ap Gwilym, poet (c.1315‚Äìc.1350)", "Edward Richard, educator (1714‚Äì1777)", "John Davies, historian (1916‚Äì1990)"] },
        "Carmarthenshire": { area: 937, population: 184232, events: ["County established (1284)", "Owain Glynd≈µr's Rebellion (15thC)", "Rebecca Riots (1839-43)"], landmarks: ["Carreg Cennen Castle", "Laugharne Castle", "National Botanic Garden"], notablePersons: ["Rhys ap Gruffydd, prince (1132‚Äì1197)", "John Dyer, poet & painter (1699‚Äì1757)", "Barry John, rugby player (1945-2024)"] },
        "Cheshire": { area: 1035, population: 1668894, events: ["Roman Deva fortress (70 AD)", "Siege of Chester (1644‚Äì1646)", "Jodrell Bank telescope (1957)"], landmarks: ["Beeston Castle", "Chester Cathedral", "Dunham Massey"], notablePersons: ["John Bradshaw, judge (1602‚Äì1659)", "Lewis Carroll, author (1832‚Äì1898)", "Patricia Routledge, actress (1929-2025)"] },
        "Clackmannanshire": { area: 48, population: 50957, events: ["Clackmannan Tolbooth (1592)", "Kirkyard Riot (1858)", "Devon Colliery Tragedy (1897)"], landmarks: ["Alloa Tower", "Castle Campbell", "Dollar Glen"], notablePersons: ["Sir William Bruce, architect (c.1630‚Äì1710)", "James Bruce, explorer (1730‚Äì1794)", "Jackie Bird, journalist (1962‚Äìpresent)"] },
        "Cornwall": { area: 1365, population: 533594, events: ["Mining begins (2150BC)", "Kingdom of Cornwall emerges (500)", "Romans take Cornwall (after 43AD)"], landmarks: ["St Michael‚Äôs Mount", "Eden Project", "Tintagel Castle"], notablePersons: ["John Trehenban, rebel (c.1500‚Äì1570)", "Richard Trevithick, inventor (1771‚Äì1833)", "Kristin Scott Thomas, actress (1960‚Äìpresent)"] },
        "Cromartyshire": { area: 370, population: 7074, events: ["Established as sherrifdom (12thC)", "Mackenzies purchase feudal Barony (1682)", "Hugh Miller fossils (1820s)"], landmarks: ["Cromarty Courthouse", "Hugh Miller‚Äôs Cottage", "Ben More Coigach"], notablePersons: ["Sir Thomas Urquhart, writer (1611‚Äì1660)", "George Mackenzie, Earl of Cromartie (1630-1714)", "Hugh Miller, geologist (1802‚Äì1856)"] },
        "Cumberland": { area: 1525, population: 306241, events: ["Prehistoric settlement (12,000BC)", "Ceded to Scotland (945AD)", "County established (12thC)"], landmarks: ["Carlisle Castle", "Hadrian‚Äôs Wall", "Scafell Pike"], notablePersons: ["Robert de Eglesfield, founder of Queen's College Oxford (c.1295‚Äì1349)", "William Wordsworth, poet (1770‚Äì1850)", "Bill Shankly, football manager (1913-present)"] },
        "Denbighshire": { area: 668, population: 227680, events: ["Denbigh Castle built (1282)", "Royalist stronghold (1642-1651)", "Llyn Brenig Reservoir (1970)"], landmarks: ["Denbigh Castle", "Pontcysyllte Aqueduct", "Llangollen Railway"], notablePersons: ["Owain Glynd≈µr, prince (c.1359‚Äìc.1415)", "Henry Stanley, explorer (1841‚Äì1904)", "Ian Rush, footballer (1961‚Äìpresent)"] },
        "Derbyshire": { area: 1017, population: 1148373, events: ["Derby established (807AD)", "County first mentioned (1048)", "Rolls Royce in Derby (1907)"], landmarks: ["Blue John Mines", "Chatsworth House", "Peak District National Park"], notablePersons: ["Anthony Babington, plotter (1561‚Äì1586)", "Joseph Wright, painter (1734‚Äì1797)", "Alison Lapper, artist (1965‚Äìpresent)"] },
        "Devon": { area: 2621, population: 1133463, events: ["Roman Conquest (43AD)", "Viking Raids (9thC)", "Plymouth naval base (1691)"], landmarks: ["Dartmoor", "Exeter Cathedral", "Jurassic Coast"], notablePersons: ["Francis Drake, circumnavigator (c.1540‚Äì1596)", "Charles Babbage, inventor (1791‚Äì1871)", "Agatha Christie, crime novelist (1890‚Äì1976)"] },
        "Dorset": { area: 1005, population: 543296, events: ["Neolithic Settlements (12,500BC)", "Black Death (1348)", "D-Day Landings (1944)"], landmarks: ["Cerne Abbas Giant", "Durdlestone Head", "Lulworth Cove"], notablePersons: ["Giles Daubeney, Lord Chamberlain (1451‚Äì1508)", "Mary Anning, fossil hunter (1799‚Äì1847)", "John le Carr√©, spy novelist (1931‚Äì2020)"] },
        "Down": { area: 950, population: 528983, events: ["Fiatach Rule (400 AD)", "St. Patrick's Arrival (432 AD)", "Norman Conquest (1177)"], landmarks: ["Downpatrick Cathedral", "Mourne Mountains", "Scrabo Tower"], notablePersons: ["Sir Hans Sloane, naturalist (1660‚Äì1753)", "C.S. Lewis, author (1898‚Äì1963)", "Rory McIlroy, golfer (1989‚Äìpresent)"] },
        "Dumfriesshire": { area: 1063, population: 77160, events: ["Dumfries established (1180)", "Rise of Castles (15-17thC)", "Pan Am Flight 103 bomb (1988)"], landmarks: ["Caerlaverock Castle", "Crawick Multiverse", "Devorgilla Bridge"], notablePersons: ["William Paterson, founder of the Bank of England (1658‚Äì1719)", "Thomas Carlyle, historian (1795‚Äì1881)", "David McKail, actor (1938‚Äìpresent)"] },
        "Dunbartonshire": { area: 241, population: 262419, events: ["Viking siege of Dumbarton (870)", "Dumbarton Castle captured (1305)", "Helensburgh becomes Burgh of Barony (1807)"], landmarks: ["Dumbarton Castle", "Hill House", "Loch Lomond"], notablePersons: ["George Buchanan, humanist scholar (1506‚Äì1582)", "Tobias Smollett, novelist (1721‚Äì1771)", "John Logie Baird, inventor of TV (1888‚Äì1946)"] },
        "Durham": { area: 1022, population: 1467037, events: ["Durham Cathedral founded (1093)", "Durham miners strike (1831)", "Beamish Museum opens (1970)"], landmarks: ["Barnard Castle", "Durham Cathedral", "Tanfield Railway"], notablePersons: ["Bede, English History (c.673‚Äì735)", "George Stephenson, railways (1781‚Äì1848)", "Rowan Atkinson, comedian (1955‚Äìpresent)"] },
        "East Lothian": { area: 267, population: 74882, events: ["Capture of Dunbar Castle (1296)", "Battle of Prestonpans (1745)", "Luftwaffe Raids (1940)"], landmarks: ["Bass Rock", "Dirleton Castle", "Tantallon Castle"], notablePersons: ["John Knox, Protestant reformer (c.1514‚Äì1572)", "John Muir, conservationist (1838‚Äì1914)", "John Bellany (1942‚Äì2013)"] },
        "Essex": { area: 1591, population: 2999248, events: ["Formation of the Kingdom of Essex (c.527)", "Marian Persecutions (1555-58)", "Southend Pier opens (1830)"], landmarks: ["Audley End House", "Colchester Castle", "Southend Pier"], notablePersons: ["John Ball, led peasants revolt (c.1338‚Äì1381)", "Anne Knight, suffragist (1786‚Äì1862)", "Jamie Oliver, chef (1975‚Äìpresent)"] },
        "Fermanagh": { area: 715, population: 61170, events: ["Kingdom of Fermanagh (c.900-1200)", "Flight of the Earls (1607)", "Battle of the Ford of the Biscuits (1594)"], landmarks: ["Enniskillen Castle", "Devenish Island", "Marble Arch Caves"], notablePersons: ["John Armstrong, soldier & poet (1674‚Äì1742)", "William Archdall, antiquary (1761‚Äì1834)", "Gordon Wilson, peace advocate (1927‚Äì1995)"] },
        "Fife": { area: 504, population: 365493, events: ["Kingdom of Fife (c.500-900)", "Dunfermline Abbey founded (1070s)", "St Andrews University founded (1413)"], landmarks: ["Culross Palace", "Falkland Palace", "St Andrew's Cathedral"], notablePersons: ["Robert Henryson, makar poet (c.1425‚Äì1500)", "Adam Smith, economist (1723‚Äì1790)", "Ian Rankin, crime writer (1960‚Äìpresent)"] },
        "Flintshire": { area: 260, population: 215390, events: ["Flint Castle built (1277)", "Capture of Richard II (1399)", "Shotton Steelworks (1916)"], landmarks: ["Flint Castle", "St Winifred‚Äôs Well", "Basingwerk Abbey"], notablePersons: ["Thomas Pennant, naturalist (1726‚Äì1798)", "Daniel Owen, Welsh novelist (1836‚Äì1895)", "Gary Speed, footballer (1969‚Äì2011)"] },
        "Glamorgan": { area: 827, population: 1321460, events: ["Kingdom of Morgannwg (c.400-1000)", "Glamorganshire Canal (1794)", "Castell Coch rebuilt (1870s)"], landmarks: ["Cardiff Castle", "Castell Coch", "National Museum Cardiff"], notablePersons: ["üëë Iestyn ap Gwrgant (c.1081‚Äì1093)", "Roald Dahl, author (1916‚Äì1990)", "Anthony Hopkins, actor (1937‚Äìpresent)"] },
        "Gloucestershire": { area: 1293, population: 1147106, events: ["Gloucester / Glevum founded (97AD)", "Death of Edward II (1327)", "Siege of Gloucester (1643)"], landmarks: ["Berkeley Castle", "Cotswold Way", "Gloucester Cathedral"], notablePersons: ["William Tyndale, translator (c.1494‚Äì1536)", "Edward Jenner, vaccine pioneer (1749‚Äì1823)", "Simon Pegg, actor (1970‚Äìpresent)"] },
        "Hampshire": { area: 1656, population: 2099640, events: ["Winchester Cathedral begun (1079)", "King Charles I imprisoned (1647)", "Jane Austen's death (1817)"], landmarks: ["New Forest National Park", "Osborne House (Isle of Wight)", "Portsmouth Dockyard"], notablePersons: ["William of Wykeham, Winchester College founder (1324‚Äì1404)", "Jane Austen, novelist (1775‚Äì1817)", "Charles Dickens, novelist (1812‚Äì1870)"] },
        "Herefordshire": { area: 837, population: 183631, events: ["Anglo-Saxon Settlement (5-6thC)", "Hereford & Gloucester Canal (1798)", "Agricultural innovation (1850s)"], landmarks: ["Berrington Hall", "Hereford Castle (ruins)", "Ledbury Market House"], notablePersons: ["Roger de Breteuil, rebel (c.1050‚Äìafter 1087)", "David Garrick, actor (1717‚Äì1779)", "Ellie Goulding (1986‚Äìpresent)"] },
        "Hertfordshire": { area: 633, population: 1157166, events: ["Verulamium founded (50 AD)", "Siege of Hertford Castle (1216)", "Warner Bros. Studio opens (2012)"], landmarks: ["St Albans Cathedral", "Hatfield House", "Knebworth House"], notablePersons: ["Nicholas Breakspear, Pope Adrian IV (c.1100‚Äì1159)", "H.G. Wells, sci-fi writer (1866‚Äì1946)", "Vinnie Jones, footballer/actor (1965‚Äìpresent)"] },
        "Huntingdonshire": { area: 366, population: 211776, events: ["Huntingdon made royal borough (c.974)", "Cromwell born (1599)", "Arrival of Great Northern Railway (1840s)"], landmarks: ["Grafham Water SSSI", "Hinchingbrooke House", "Ramsey Abbey Gatehouse"], notablePersons: ["Henry of Huntingdon, historian (c.1088‚Äì1157)", "Oliver Cromwell, Lord Protector (1599‚Äì1658)", "David Howarth, historian (1912‚Äì1991)"] },
        "Inverness-shire": { area: 4211, population: 118077, events: ["Rise of Clan System (11-12thC)", "Battle of Culloden (1746)", "Loch Ness Monster reported (1933)"], landmarks: ["Caledonian Canal", "Loch Ness", "Urquhart Castle"], notablePersons: ["James Macpherson, translator (1736‚Äì1796)", "Flora MacDonald, Jacobite heroine (1722‚Äì1790)", "Ali Smith, novelist (1962‚Äìpresent)"] },
        "Kent": { area: 1611, population: 2747715, events: ["Christianisation (597)", "Dover Castle built (1180s)", "Hundred Years‚Äô War (1337‚Äì1453)"], landmarks: ["Canterbury Cathedral", "Leeds Castle", "White Cliffs of Dover"], notablePersons: ["William Caxton, printer (c.1422‚Äì1491)", "Christopher Marlowe, playwright (1564‚Äì1593)", "Mick Jagger, singer (1943‚Äìpresent)"] },
        "Kincardineshire": { area: 380, population: 77670, events: ["Norse Raids (9-11thC)", "Dunnottar Castle siege (1651)", "Expansion of Stonehaven Harbour (1820s)"], landmarks: ["Cowie Castle (ruins)", "Dunnottar Castle", "Stonehaven Tolbooth Museum"], notablePersons: ["John Mair, philosopher (1467‚Äì1550)", "James Beattie, poet (1735‚Äì1803)", "David Foggie, portrait painter (1878‚Äì1948)"] },
        "Kinross-shire": { area: 73, population: 11223, events: ["Pictish & early Scottish rule (9-11thC)", "Mary Queen of Scots imprisoned (1567)", "Arrival of railways (19thC)"], landmarks: ["Kinross House", "Loch Leven Castle", "RSPB Loch Leven"], notablePersons: ["Patrick Simson, theologian (c. 1556‚Äì1618)", "Michael Bruce, poet (1746‚Äì1767)", "Douglas Young, Scots poet (1913‚Äì1973)"] },
        "Kirkcudbrightshire": { area: 899, population: 47546, events: ["Part of the Lordship of Galloway (12thC)", "Covenanter movement (1638‚Äì1651)", "Growth in tourism (20thC)"], landmarks: ["Broughton House", "Dundrennan Abbey", "Threave Castle"], notablePersons: ["Sir John Dalrymple, 1st Baronet of Stair (c. 1650 ‚Äì 1721)", "S.R. Crockett, author (1859‚Äì1914)", "Malcolm Caldwell, academic (1931‚Äì1978)"] },
        "Lanarkshire": { area: 879, population: 1008014, events: ["Developed as feudal county (12-13thC)", "Battle of Lanark (1297)", "Covenanter period (1638‚Äì1651)"], landmarks: ["Lanark Castle (ruins)", "Hamilton Mausoleum", "Falls of Clyde"], notablePersons: ["James Hamilton, assassin (c. 1530‚ÄØ‚Äì‚ÄØ1578)", "David Livingstone, explorer (1813‚Äì1873)", "R.D. Laing, psychaiatrist (1927‚Äì1989)"] },
        "Lancashire": { area: 1909, population: 4942364, events: ["Established as county (1182)", "Scottish Raid & Burning of Lancaster (1322)", "Pendle Witch Trials (1612)", "Peterloo Massacre (1819)"], landmarks: ["Lancaster Castle", "Blackpool Tower", "Royal Albert Dock"], notablePersons: ["Roger of Poitou, founded Lancaster (c.1065‚Äìc.1140)", "George Formby, entertainer (1875‚Äì1921)", "Paul McCartney, musician (1942‚Äìpresent)"] },
        "Leicestershire": { area: 836, population: 975403, events: ["Ratae Corieltauvorum (Leicester) Roman town", "Battle of Bosworth (1485)", "Chartist movement (1830s/40s)"], landmarks: ["Belvoir Castle", "Bosworth Battlefield Heritage Centre", "National Space Centre"], notablePersons: ["Simon de Montfort, Baronial reformer (c.1208‚Äì1265)", "Thomas Cook, tourism (1808‚Äì1892)", "Gary Lineker, footballer (1960‚Äìpresent)"] },
        "Lincolnshire": { area: 2687, population: 1038510, events: ["Part of Lindsey then Mercia Kingdoms (5-11thC)", "Second Battle of Lincoln (1217)", "Lincolnshire Uprising (1470s)"], landmarks: ["Lincoln Cathedral", "Tattershall Castle", "Theddlethorpe Dunes"], notablePersons: ["Hereward the Wake, outlaw (c.1035‚Äìc.1072)", "Isaac Newton, physicist (1643‚Äì1727)", "Margaret Thatcher, first female PM (1925‚Äì2013)"] },
        "Londonderry": { area: 816, population: 247971, events: ["City walls built (1613)", "Siege of Derry (1689)", "Peace Bridge opens (2011)"], landmarks: ["Derry City Walls", "Guildhall", "Peace Bridge"], notablePersons: ["Sir Randal Beresford, Baronet (c.1636-1681)", "Charles Thomson, US patriot leader (1729‚Äì1824)", "James Chichester‚ÄëClark, PM of NI (1923‚Äì2002)"] },
        "Merionethshire": { area: 676, population: 37874, events: ["Castell y Bere captured (13thC)", "Glynd≈µr parliament (1404)", "Ffestiniog Railway (1836)"], landmarks: ["Cader Idris", "Harlech Castle", "Portmeirion Village"], notablePersons: ["Ellis Wynne, author (1671‚Äì1734)", "Richard Roberts, inventor (1789‚Äì1864)", "Bob Roberts, folk singer (1907‚Äì1982)"] },
        "Middlesex": { area: 285, population: 4000927, events: ["The Battle of Brentford (c.1016)", "Charterhouse founded (1371)", "Middlesex Regiment formed (1881)"], landmarks: ["Palace of Westminster", "Wrotham Park", "Wembley Stadium"], notablePersons: ["Geoffrey Chaucer, writer (c.1343‚Äì1400)", "John Keats, poet (1795‚Äì1821)", "Amy Winehouse, singer (1983‚Äì2011)"] },
        "Midlothian": { area: 362, population: 621610, events: ["Viking raids (9th-10th centuries)", "Battle of Roslin (1303)", "Musselburgh Racecourse founded (1816)"], landmarks: ["Edinburgh Castle", "Rosslyn Chapel", "Newbattle Abbey"], notablePersons: ["üëë James VI of Scotland (1566‚ÄØ‚Äì‚ÄØ1625)", "Walter Scott, novelist (1771‚Äì1832)", "Tam Dalyell, parliamentarian (1932‚Äì2017)"] },
        "Monmouthshire": { area: 542, population: 514723, events: ["Owain Glynd≈µr rebellion (1400-15)", "Chartist March (1839)", "Big Pit Coal Museum (1983)"], landmarks: ["Big Pit: National Coal Museum", "Raglan Castle", "Tintern Abbey"], notablePersons: ["Geoffrey of Monmouth, chronicler (c.1095‚Äì1155)", "üëë Henry V (1386‚Äì1422)", "Desmond Llewelyn, actor (1914‚Äì1999)"] },
        "Montgomeryshire": { area: 796, population: 61956, events: ["Montgomery Castle (12thC)", "Dolforwyn Castle (13thC)", "Lake Vyrnwy Dam (1880s)"], landmarks: ["Montgomery Castle", "Montgomeryshire Canal", "Powis Castle"], notablePersons: ["Dafydd Nanmor, bard (c.1420‚Äìc.1490)", "Robert Owen, co-op founder (1771‚Äì1858)", "Robert William Griffiths, farmer (1896‚Äì1962)"] },
        "Morayshire": { area: 476, population: 67654, events: ["Elgin Cathedral founded (1224)", "Jacobite risings (1689‚Äì1746)", "Glen Moray Distillery (1897)"], landmarks: ["Duffus Castle", "Elgin Cathedral", "Pluscarden Abbey"], notablePersons: ["Alexander Brodie, diarist (1617‚Äì1680)", "James Grant, novelist (1802‚Äì1879)", "Kenneth Mackessack, cricketer (1902‚Äì1982)"] },
        "Nairnshire": { area: 200, population: 13894, events: ["Cawdor Castle built (1300s)", "Clan disputes & raids (16th‚Äì17thC)", "Nairn Golf Club founded (1887)"], landmarks: ["Cawdor Castle", "Nairn Museum", "Nairn / Culloden Viaduct"], notablePersons: ["James Brodie, botanist (1744‚Äì1824)", "Hugh Rose, 15th Baron Kilravock (1663‚Äì1732)", "James Campbell, potter (1943‚Äì2019)"] },
        "Norfolk": { area: 2057, population: 807721, events: ["Boudica‚Äôs Revolt (c.60AD)", "Norwich Castle built (1067)", "Railway expansion (19thC)"], landmarks: ["Norwich Cathedral", "Sandringham House", "Holkham Hall"], notablePersons: ["Julian of Norwich, mystic (c.1342‚Äìc.1416)", "Horatio Nelson, naval hero (1758‚Äì1805)", "Edith Cavell, WWI nurse (1865‚Äì1915)"] },
        "Northamptonshire": { area: 998, population: 838786, events: ["Trial of Simon de Montfort‚Äôs supporters (1264)", "Battle of Northampton (1460)", "Battle of Naseby (1645)"], landmarks: ["Althorp", "Fotheringhay Castle", "Rockingham Castle"], notablePersons: ["Simon de Senlis, Norman Earl (c.1098‚Äì1153)", "John Dryden, Poet Laureate (1631‚Äì1700)", "Alan Moore, comic writer (1953‚Äìpresent)"] },
        "Northumberland": { area: 2019, population: 797006, events: ["Roman occupation (c.70‚Äì410 AD)", "Battle of Heavenfield (c.634)", "Battle of Flodden Field (1513)"], landmarks: ["Hadrian‚Äôs Wall", "Alnwick Castle", "Lindisfarne"], notablePersons: ["Henry 'Hotspur' Percy, rebel (1364‚Äì1403)", "Grace Darling, rescue heroine (1815‚Äì1842)", "Sting (1951‚Äìpresent)"] },
        "Nottinghamshire": { area: 843, population: 1096617, events: ["Siege of Nottingham (1016)", "Battle of Stoke Field (1487)", "Nottingham Canal (1796)"], landmarks: ["Sherwood Forest", "Nottingham Castle", "Wollaton Hall"], notablePersons: ["Robin Hood, folk hero (c.1190)", "William Booth, Salvation Army (1829‚Äì1912)", "D.H. Lawrence, author (1885‚Äì1930)"] },
        "Orkney": { area: 376, population: 21349, events: ["Neolithic settlement (c.4000‚Äì2500 BC)", "Annexation to Scotland (1472)", "Scapa Flow scuttling (1919)"], landmarks: ["Ring of Brodgar", "Skara Brae", "St Magnus Cathedral"], notablePersons: ["William Elphinstone, Aberdeen University founder (1431‚Äì1514)", "Edwin Muir, novelist (1887‚Äì1959)", "George Mackay Brown, poet (1921‚Äì1996)"] },
        "Oxfordshire": { area: 754, population: 512345, events: ["Oxford University founded (1096)", "Siege of Oxford (1646)", "Mini car production (1959-2000)"], landmarks: ["Oxford Colleges", "Blenheim Palace", "Christ Church Cathedral"], notablePersons: ["William Lenthall, HoC Speaker (1591‚Äì1662)", "Warren Hastings, India Gov-Gen (1732‚Äì1818)", "Winston Churchill, PM (1874‚Äì1965)"] },
        "Peeblesshire": { area: 548, population: 19074, events: ["Traquair House oldest (1107)", "Wars of Scottish Independence (1296‚Äì1357)", "Dawyck Botanic Garden (1600s)"], landmarks: ["Dawyck Botanic Garden", "Neidpath Castle", "Traquair House"], notablePersons: ["Sir David Murray (c.1599‚Äì1653)", "William Chambers, publisher (1800‚Äì1883)", "John Buchan, author (1875‚Äì1940)"] },
        "Pembrokeshire": { area: 625, population: 122122, events: ["St Davids Cathedral (1181)", "Flemish settlement (12-13thC)", "Coast Path (1970)"], landmarks: ["St Davids Cathedral", "Pembroke Castle", "Skomer Island"], notablePersons: ["Asser, bishop & biographer (d. 909)", "Henry Tudor, Henry VII (1457‚Äì1509)", "Christian Bale, actor (1974‚Äìpresent)"] },
        "Perthshire": { area: 2493, population: 156371, events: ["Scone Palace: Stone of Destiny (800s)", "Perth made royal burgh (12-13thC)", "Tay Bridge collapse (1879)"], landmarks: ["Blair Castle", "Loch Tay", "Scone Palace"], notablePersons: ["Neil Gow, musician (1727‚Äì1807)", "William Soutar, poet (1898‚Äì1943)", "Alan Cumming, actor (1965-present)"] },
        "Radnorshire": { area: 470, population: 25821, events: ["Roman occupation (1st-4thC)", "Norman invasion (late 11thC)", "Turnpike roads then railways (19thC"], landmarks: ["Cefnllys Castle", "Radnor Forest", "Llandrindod Wells"], notablePersons: ["Thomas Huet, poet (d. 1591)", "John Price, soldier & antiquary (1600‚Äì1676)", "David Jones, poet & artist (1895‚Äì1974)"] },
        "Renfrewshire": { area: 245, population: 508064, events: ["Paisley Abbey founded (1163)", "Paisley pattern created (18thC)", "Renfrew Airport opens (1918)"], landmarks: ["Castle Semple", "Coats Observatory", "Paisley Abbey"], notablePersons: ["Robert Tannahill, weaver poet (1774‚Äì1810)", "James Watt, inventor (1736‚Äì1819)", "Lena Zavaroni, singer (1963‚ÄØ‚Äì‚ÄØ1999)"] },
        "Ross-shire": { area: 3089, population: 69503, events: ["Arrival of St. Maelrubha (673)", "Christianisation of the Picts (7th‚Äì9th centuries)", "Inverness & Ross-shire Railway (1860s)"], landmarks: ["Eilean Donan Castle", "Falls of Measach", "Fortrose Cathedral"], notablePersons: ["Sir George Munro, soldier (1685 ‚Äì 1746)", "Sir Hector Mackenzie, clan chief (1758‚ÄØ‚Äì‚ÄØ1826)", "Francis Charles Fraser, zoologist (1903 ‚Äì 1978)"] },
        "Roxburghshire": { area: 666, population: 50800, events: ["üëë Death of James II (1460)", "Covenanter movement (1638‚Äì1651)", "Waverley Railway Line (1849‚Äì1862)"], landmarks: ["Bowmont Water Valley", "Jedburgh Abbey", "Roxburgh Castle"], notablePersons: ["Robert Ker, Earl of Roxburghe (c. 1570 ‚Äì 1650)", "John Leyden, orientalist (1775‚Äì1811)", "Thomas Pringle, anti-slavery poet (1789‚Äì1834)"] },
        "Rutland": { area: 152, population: 37677, events: ["Granted to Norman lords (>1066)", "Railways reached Oakham (1840s)", "Rutland Water created (1976)"], landmarks: ["Oakham Castle", "Rutland Railway Museum", "St Mary‚Äôs Church (Tickencote)"], notablePersons: ["William de Ros, signed Magna Carta (c.1255‚Äì1316)", "Thomas Barker, meteorologist (1769‚Äì1847)", "Richard Condon, cricketer (1937‚Äì1991)"] },
        "Selkirkshire": { area: 267, population: 16010, events: ["Ettrick Medieval Royal Forest (from 12thC)", "Lawless Border Reivers (15th-16thC)", "Battle of Philiphaugh (1645)"], landmarks: ["Bowhill House", "Selkirk Town Hall", "Yair Bridge"], notablePersons: ["James Hogg, novelist (1770‚Äì1835)", "Andrew Currie, sculptor (1812‚Äì1891)", "Walter Greive, cricketer (1891‚Äì1917)"] },
        "Shetland": { area: 551, population: 23167, events: ["Norse Settlement (c.800‚Äì900AD)", "Transfer to Scotland (1469)", "Rise of Fishing Industry (19thC)"], landmarks: ["Jarlshof", "Noss National Nature Reserve", "Scalloway Castle"], notablePersons: ["Patrick Stewart, Earl of Orkney (c. 1566‚Äì1615)", "Arthur Anderson, P&O founder (1792‚Äì1868)", "Christine De Luca, poet (1947‚Äìpresent)"] },
        "Shropshire": { area: 1342, population: 472027, events: ["Battle of Maserfield (642 AD)", "Battle of Shrewsbury (1403)", "Birth of Industrial Revolution, Ironbridge (1709)"], landmarks: ["Ironbridge Gorge", "Shrewsbury Castle", "Wrekin Hill"], notablePersons: ["Orderic Vitalis, chronicler (1075‚Äìc.1142)", "Charles Darwin, naturalist (1809‚Äì1882)", "Wilfred Owen, WWI poet (1893‚Äì1918)"] },
        "Somerset": { area: 1633, population: 1053504, events: ["Battle of Peonnum (658)", "Battle of Sedgemoor (1685)", "Somerset Levels Drained (18th-19thC)"], landmarks: ["Cheddar Gorge", "Glastonbury Abbey", "Wells Cathedral"], notablePersons: ["Joseph of Glastonbury, Arthurian Legend chronicler (c.1360‚Äìc.1420)", "Samuel Taylor Coleridge, poet (1772‚Äì1834)", "John Cleese, comedian (1939‚Äìpresent)"] },
        "Staffordshire": { area: 1176, population: 2159392, events: ["Stafford castle built (c.1085)", "Lichfield Cathedral consecrated (1195)", "Rise of the Potteries (18thC)"], landmarks: ["Alton Towers", "Lichfield Cathedral", "Trentham Estate"], notablePersons: ["Izaak Walton, author (1593‚Äì1683)", "Josiah Wedgwood, industrialist (1730‚Äì1795)", "Lemmy Kilmister, musician (1945‚Äì2015)"] },
        "Stirlingshire": { area: 447, population: 244092, events: ["Battle of Bannockburn (1314)", "Jacobite Rising (1715)", "Forth & Clyde Canal opens (1790)"], landmarks: ["Bannockburn Battlefield", "River Forth", "Stirling Castle"], notablePersons: ["James Bruce of Kinnaird, laird (1610‚Äì1680)", "James Bruce of Kinnaird, explorer (1730‚Äì1794)", "Billy Bremner, footballer (1942‚Äì1997"] },
        "Suffolk": { area: 1505, population: 775099, events: ["Foundation of Bury St Edmunds Abbey (1020)", "Battle of Leiston (1217)", "Ipswich & Felixstowe Port Development (19thC)"], landmarks: ["Framlingham Castle", "Southwold Lighthouse", "Suffolk Coast & Heaths AONB"], notablePersons: ["Thomas Cavendish, navigator (1560‚Äì1592)", "Thomas Gainsborough, painter (1727‚Äì1788)", "Benjamin Britten, composer (1913‚Äì1976)"] },
        "Surrey": { area: 759, population: 2975836, events: ["Battle of Aclea (c. 825)", "Magna Carta at Runnymede (1215)", "Brooklands racetrack opens (1907)"], landmarks: ["Brooklands Museum", "Gatwick Airport", "Waverley Abbey (ruins)"], notablePersons: ["Sir William Perkins, merchant (1631 ‚Äì 1696)", "Aldous Huxley, author (1894‚Äì1963)", "Eric Clapton, guitarist (1945‚Äìpresent)"] },
        "Sussex": { area: 1466, population: 1612454, events: ["Battle of Hastings (1066)", "Siege of Lewes (1264)", "Railways spur seaside tourism (19thC)"], landmarks: ["Arundel Castle", "Battle Abbey", "Brighton Royal Pavilion"], notablePersons: ["John Selden, scholar (1584 ‚Äì 1654)", "Gideon Mantell, paleontologist (1790‚Äì1852)", "Peter James, crime novelist (1948‚Äìpresent)"] },
        "Sutherland": { area: 2028, population: 12803, events: ["Norse Influence (8th‚Äì13th centuries)", "Clan Conflicts (13th‚Äì16th centuries)", "Highland Clearances (18th-19thC)"], landmarks: ["Dornoch Cathedral", "Dunrobin Castle", "Loch Shin"], notablePersons: ["Robert Gordon, historian (1635‚ÄØ‚Äì‚ÄØ1695)", "Hugh Mackay, military officer (c. 1740‚Äì1800)", "Alistair, 25th Earl of Sutherland (1947-present)"] },
        "Tyrone": { area: 1260, population: 178440, events: ["Norman Invasion & Gaelic Lords (12th‚Äì13th centuries)", "Battle of the Yellow Ford (1598)", "Penal Laws & Religious Tensions (18th-19thC)"], landmarks: ["Dungannon Castle", "Omagh Cathedral", "Gortin Glen Forest Park"], notablePersons: ["Turlough Luineach O‚ÄôNeill, noble (c.1530‚Äì1595)", "John Dunlap, printed US DoI (1747‚Äì1822)", "Brian Friel, dramatist (1929‚Äì2015)"] },
        "Warwickshire": { area: 918, population: 1632885, events: ["Foundation of Warwick Castle (1068)", "Shakespeare born (1564)", "Coventry Blitz (1940)"], landmarks: ["Coventry Cathedral", "Jephson Gardens", "Kenilworth Castle"], notablePersons: ["Guy of Warwick, legendary knight (c.930)", "William Shakespeare, playwright (1564‚Äì1616)", "George Eliot, novelist (1819‚Äì1880)"] },
        "West Lothian": { area: 120, population: 154830, events: ["Battle of Linlithgow Bridge (1526)", "Covenanter activity (1640s)", "Oil Shale Industry (19th‚Äì20th centuries)"], landmarks: ["Bathgate Oil Shale Works", "Beecraigs Country Park", "Linlithgow Palace"], notablePersons: ["Mary, Queen of Scots (1542‚Äì1587)", "Sir James Simpson, obstetrician (1811‚Äì1870)", "Susan Boyle, singer (1961‚Äìpresent)"] },
        "Westmorland": { area: 785, population: 87466, events: ["Construction of Appleby Castle (12thC)", "Kendal Green cloth production (17th-18thC)", "Kendal to Lancaster Canal built (18thC)"], landmarks: ["Kendal Castle", "Levens Hall", "Rydal Mount"], notablePersons: ["Lancelot de Threlkeld, knight (c.1435‚Äì1493)", "John Gough, natural philosopher (1757 ‚Äì 1825)", "Helen Skelton, TV presenter (1983‚Äìpresent)"] },
        "Wigtownshire": { area: 487, population: 26618, events: ["Norse Influence (8th‚Äì12th centuries)", "Wigtown Martyrs (1685)", "Portpatrick & Wigtownshire Railway (19thC)"], landmarks: ["Castle Kennedy", "Mull of Galloway Lighthouse", "Whithorn Priory"], notablePersons: ["Margaret Wilson, covenanter martyr (c.‚ÄØ1667‚Äì1685)", "Sir Herbert Maxwell, 7th Baronet (1845-1937)", "Graeme Parker, YouTuber (1982-present)"] },
        "Wiltshire": { area: 1374, population: 682380, events: ["Stonehenge built (c.3000 BC)", "Roman Occupation (1st‚Äì5th centuries)", "Salisbury Cathedral (1220)"], landmarks: ["Avebury", "Salisbury Cathedral", "Stonehenge"], notablePersons: ["√Üthelweard, chronicler (c.940‚Äì998)", "Christopher Wren, architect (1632‚Äì1723)", "John Rhys-Davies, actor (1944-present)"] },
        "Worcestershire": { area: 709, population: 1125037, events: ["Foundation of Worcester Cathedral (7thC)", "Battle of Worcester (1651)", "Canal Construction (18th century)"], landmarks: ["Malvern Hills", "Worcester & Birmingham Canal", "Worcester Cathedral"], notablePersons: ["Edward Winslow, Pilgrim leader (1595‚Äì1655)", "Jenny Lind, opera singer (1820‚Äì1887)", "Edward Elgar, composer (1857‚Äì1934)"] },
        "Yorkshire": { area: 6081, population: 5218838, events: ["Roman Conquest (43‚Äì410)", "Norse Kingdom of J√≥rv√≠k (9th-10thC)", "Siege of York (1644)"], landmarks: ["Fountains Abbey, West Riding", "Hull Docks, East Riding", "York Minster, York within the Walls"], notablePersons: ["Alcuin of York, scholar (c.735‚Äì804)", "Charlotte Bront√´, novelist (1816‚Äì1855)", "J.B. Priestley, writer (1894‚Äì1984)"] }
      };

      const countyLanguages = {
        "Anglesey": { name: "Sir F√¥n", lang: "Welsh" },
        "Brecknockshire": { name: "Sir Frycheiniog", lang: "Welsh" },
        "Caernarfonshire": { name: "Sir Gaernarfon", lang: "Welsh" },
        "Cardiganshire": { name: "Sir Aberteifi / Ceredigion", lang: "Welsh" },
        "Carmarthenshire": { name: "Sir Gaerfyrddin", lang: "Welsh" },
        "Denbighshire": { name: "Sir Ddinbych", lang: "Welsh" },
        "Flintshire": { name: "Sir y Fflint", lang: "Welsh" },
        "Glamorgan": { name: "Morgannwg", lang: "Welsh" },
        "Merionethshire": { name: "Meirionnydd", lang: "Welsh" },
        "Monmouthshire": { name: "Sir Fynwy", lang: "Welsh" },
        "Montgomeryshire": { name: "Sir Drefaldwyn", lang: "Welsh" },
        "Pembrokeshire": { name: "Sir Benfro", lang: "Welsh" },
        "Radnorshire": { name: "Sir Faesyfed", lang: "Welsh" },
        "Aberdeenshire": { name: "Siorrachd Obar Dheathain", lang: "Scottish Gaelic" },
        "Angus": { name: "Aonghas", lang: "Scottish Gaelic" },
        "Argyllshire": { name: "Siorrachd Earra-Gh√†idheal", lang: "Scottish Gaelic" },
        "Ayrshire": { name: "Siorrachd Inbhir √Äir", lang: "Scottish Gaelic" },
        "Banffshire": { name: "Siorrachd Bhanbh", lang: "Scottish Gaelic" },
        "Berwickshire": { name: "Siorrachd Bhearaig", lang: "Scottish Gaelic" },
        "Buteshire": { name: "Siorrachd Bh√πth", lang: "Scottish Gaelic" },
        "Caithness": { name: "Gallaibh", lang: "Scottish Gaelic" },
        "Clackmannanshire": { name: "Siorrachd Chlach Mhanainn", lang: "Scottish Gaelic" },
        "Cromartyshire": { name: "Siorrachd Chr√≤mbaidh", lang: "Scottish Gaelic" },
        "Dumfriesshire": { name: "Siorrachd Dh√πn Phris", lang: "Scottish Gaelic" },
        "Dunbartonshire": { name: "Siorrachd Dh√πn Bhreatainn", lang: "Scottish Gaelic" },
        "East Lothian": { name: "Siorrachd an Ear Leothain", lang: "Scottish Gaelic" },
        "Fife": { name: "F√¨obha", lang: "Scottish Gaelic" },
        "Inverness-shire": { name: "Siorrachd Inbhir Nis", lang: "Scottish Gaelic" },
        "Kincardineshire": { name: "Siorrachd Chinn Ch√†rdainn", lang: "Scottish Gaelic" },
        "Kinross-shire": { name: "Siorrachd Cheann Rois", lang: "Scottish Gaelic" },
        "Kirkcudbrightshire": { name: "Siorrachd Chille Chuithbeirt", lang: "Scottish Gaelic" },
        "Lanarkshire": { name: "Siorrachd Lanraig", lang: "Scottish Gaelic" },
        "Midlothian": { name: "Meadhan Labhdaidh", lang: "Scottish Gaelic" },
        "Morayshire": { name: "Moireibh", lang: "Scottish Gaelic" },
        "Nairnshire": { name: "Siorrachd Inbhir Narann", lang: "Scottish Gaelic" },
        "Orkney": { name: "Arcaibh", lang: "Scottish Gaelic" },
        "Peeblesshire": { name: "Siorrachd nam P√πballan", lang: "Scottish Gaelic" },
        "Perthshire": { name: "Siorrachd Pheairt", lang: "Scottish Gaelic" },
        "Renfrewshire": { name: "Siorrachd Rinn Fri√π", lang: "Scottish Gaelic" },
        "Ross-shire": { name: "Siorrachd Rois", lang: "Scottish Gaelic" },
        "Roxburghshire": { name: "Siorrachd Rosbroig", lang: "Scottish Gaelic" },
        "Selkirkshire": { name: "Siorrachd Shailcirc", lang: "Scottish Gaelic" },
        "Shetland": { name: "Sealtainn", lang: "Scottish Gaelic" },
        "Stirlingshire": { name: "Siorrachd Shruighlea", lang: "Scottish Gaelic" },
        "Sutherland": { name: "Cataibh", lang: "Scottish Gaelic" },
        "West Lothian": { name: "Lothian an Iar", lang: "Scottish Gaelic" },
        "Wigtownshire": { name: "Siorrachd Bhaile na h-√ôige", lang: "Scottish Gaelic" },
        "Antrim": { name: "Aontroim", lang: "Irish Gaelic" },
        "Armagh": { name: "√Ård Mhacha", lang: "Irish Gaelic" },
        "Down": { name: "An D√∫n", lang: "Irish Gaelic" },
        "Fermanagh": { name: "Fear Manach", lang: "Irish Gaelic" },
        "Londonderry": { name: "Doire", lang: "Irish Gaelic" },
        "Tyrone": { name: "T√≠r Eoghain", lang: "Irish Gaelic" }
      };

// Update card function
window.updateCountyCard = function(englishName, layer, lat, lon) {
        const details = countyData[englishName] || {};
        const langEntry = countyLanguages[englishName];
        const area = details.area || 0;
        const pop = details.population || 0;
        const density = area > 0 ? (pop / area).toFixed(1) : 'N/A';

        let badgeStyle = '';
        if (density > 1000) badgeStyle = 'background:#9B2C2C; color:white;';
        else if (density > 500) badgeStyle = 'background:#D32F2F; color:white;';
        else if (density > 200) badgeStyle = 'background:#FF7043; color:white;';
        else if (density > 100) badgeStyle = 'background:#FFB300; color:white;';
        else if (density > 50) badgeStyle = 'background:#8BC34A; color:white;';
        else badgeStyle = 'background:#66BB6A; color:white;';

        fetchWeather(lat, lon).then(weather => {
          const weatherBlock = weather ? `
            <div style="text-align:center; margin:14px 0 8px;">
              <div class="weather-underline" style="margin:0 auto 14px;"></div>
              <div class="weather-badge">
                ${weather.temp}¬∞C ‚Ä¢ ${weather.desc} ‚Ä¢ Wind ${weather.wind} mph
              </div>
            </div>` : '';

          const flagUrl = countyFlags[englishName];
          const flagHTML = flagUrl ? `<img src="${flagUrl}" alt="${englishName} flag" class="flag" onerror="this.style.display='none'">` : '';

          const cardHTML = `
            <div class="county-card" style="margin-bottom:16px;">
              ${flagHTML}
              <div class="card-body">
                <h3>${englishName}</h3>
                ${langEntry ? `<p style="margin:6px 0; font-size:0.9rem; text-align:center;"><strong>${langEntry.lang}:</strong> ${langEntry.name}</p>` : ''}
                <div style="display:flex; justify-content:space-between; margin:12px 0; font-size:0.95rem;">
                  <div><strong>Area:</strong> ${area.toLocaleString()} sq mi</div>
                  <div><strong>Pop:</strong> ${pop.toLocaleString()}</div>
                </div>
                <div style="text-align:center; margin:12px 0;">
                  <span style="${badgeStyle} padding:6px 16px; border-radius:20px; font-weight:600; font-size:0.9rem; display:inline-block; box-shadow:0 1px 3px rgba(0,0,0,0.2);">
                    Density: ${density} people/sq mi
                  </span>
                </div>

                ${details.events?.length ? `
                  <div style="margin:14px 0 8px;">
                    <h4 style="margin:0 0 6px; color:var(--accent); font-size:1rem; text-align:left; border-bottom:1px solid #eee; padding-bottom:4px;">Key Events</h4>
                    <ul style="margin:6px 0; padding-left:20px; font-size:0.88rem; line-height:1.5; text-align:left;">
                      ${details.events.map(e => `<li>${e}</li>`).join('')}
                    </ul>
                  </div>` : ''}

                ${details.landmarks?.length ? `
                  <div style="margin:14px 0 8px;">
                    <h4 style="margin:0 0 6px; color:var(--accent); font-size:1rem; text-align:left; border-bottom:1px solid #eee; padding-bottom:4px;">Notable Landmarks</h4>
                    <ul style="margin:6px 0; padding-left:20px; font-size:0.88rem; line-height:1.5; text-align:left;">
                      ${details.landmarks.map(l => `
                              <li>${l}</li>
                            `).join('')}
                    </ul>
                  </div>` : ''}

                ${details.notablePersons?.length ? `
                  <div style="margin:14px 0 8px;">
                    <h4 style="margin:0 0 6px; color:var(--accent); font-size:1rem; text-align:left; border-bottom:1px solid #eee; padding-bottom:4px;">Notable Persons</h4>
                    <ul style="margin:6px 0; padding-left:20px; font-size:0.88rem; line-height:1.5; text-align:left;">
                      ${details.notablePersons.slice(0, 3).map(p => `<li>${p}</li>`).join('')}
                    </ul>
                  </div>` : ''}

                ${weatherBlock}
              </div>
            </div>`;

          infoDiv.innerHTML = cardHTML;
          infoDiv.scrollTop = 0;
        });
      };

      const pastelColors = ["#ffdede","#dedefd","#deffde","#fff0de","#fdefff","#dfffee","#ffe7de","#f0deff","#defff5","#fdeeee","#e6f7ff","#f9ffe6","#fff6e6","#e6e6ff","#ffe6f2"];
      data.features.forEach((f, i) => f.properties.color = pastelColors[i % pastelColors.length]);

      L.geoJSON(data, {
        style: f => ({ color: "#333", weight: 1, fillColor: f.properties.color, fillOpacity: 0.35 }),
        onEachFeature: (feature, layer) => {
          const englishName = feature.properties.NAME;
          const details = countyData[englishName] || {};
          const langEntry = countyLanguages[englishName];
          const density = details.area > 0 ? Math.round(details.population / details.area) : '?';
          const centroid = turf.centroid(feature);
          const lat = centroid.geometry.coordinates[1];
          const lon = centroid.geometry.coordinates[0];

          layer.bindTooltip(`
            <div style="text-align:center; font-weight:bold; font-size:0.95rem;">
              ${englishName}<br>
              ${langEntry ? `<small>${langEntry.lang}: ${langEntry.name}</small><br>` : ''}
              <small style="color:#555;">${density} people/sq mi</small>
            </div>
          `, { direction: 'center', className: 'county-tooltip' });

          layer.on('click', () => {
            layer._cardLayer = layer;
            window.updateCountyCard(englishName, layer, lat, lon);
            
            // === ADD SUBDIVISION BUTTONS HERE ===
            const subdivBox = document.getElementById("subdivision-buttons");
            subdivBox.innerHTML = "";
            subdivBox.className = ""; // reset

            const subs = subdivisionFiles[englishName];
            if (subs) {
              const order = englishName === "Lincolnshire"
                ? ["Parts", "Wapentakes", "Lindsey Ridings"]
                : Object.keys(subs);

              const buttonTypes = order.filter(type => subs[type]);
              const totalButtons = buttonTypes.length + 1; // +1 for Clear

              buttonTypes.forEach(type => {
                const btn = document.createElement('button');
                btn.className = 'subdivision-btn';
                btn.textContent = `Show ${type}`;
                btn.dataset.type = type;
                btn.onclick = () => loadSubdivisionLayer(subs[type], type, btn);
                subdivBox.appendChild(btn);
              });

              const clearBtn = document.createElement('button');
              clearBtn.className = 'subdivision-btn clear';
              clearBtn.textContent = 'Clear';
              clearBtn.onclick = () => {
                if (subdivisionLayer) {
                  map.removeLayer(subdivisionLayer);
                  subdivisionLayer = null;
                }
                subdivisionLabels.forEach(label => {
                  if (map.hasLayer(label)) map.removeLayer(label);
                });
                subdivisionLabels = [];
                activeSubdivision = null;
                document.querySelectorAll('.subdivision-btn').forEach(b => {
                  if (b.textContent.startsWith('Hide')) {
                    const type = b.dataset.type;
                    b.textContent = `Show ${type}`;
                    b.classList.remove('active', 'loading');
                    b.disabled = false;
                  }
                });
              };
              subdivBox.appendChild(clearBtn);

              // 2√ó2 Grid for Lincolnshire
              if (totalButtons === 4) {
                subdivBox.classList.add('has-4');
              }
            }

            if (window.innerWidth <= 1024) sidebar.classList.add('visible');
            map.fitBounds(layer.getBounds());
          });  // ‚Üê CLOSES layer.on('click', ...)

          layer.on('mouseover', () => layer.setStyle({ weight: 2 }));
          layer.on('mouseout', () => layer.setStyle({ weight: 1 }));
        }
      }).addTo(map);

      setTimeout(() => map.invalidateSize(), 300);
      infoDiv.innerHTML = '<em>Click a county to explore.</em>';
      infoDiv.classList.remove('loading');
    })
    .catch(err => {
      console.error(err);
      infoDiv.innerHTML = '<em style="color:red;">Failed to load map data. Check console.</em>';
    });

  // Search & Geocoder
  L.Control.geocoder({ defaultMarkGeocode: true, placeholder: 'Search town, village, postcode‚Ä¶' }).addTo(map);
  window.places = []; let fuse = null; let searchMarker = null;

  function initFuse() {
    if (window.places.length) {
      fuse = new Fuse(window.places, {
        keys: ['name', 'county'],
        threshold: 0.4
      });
    }
  }

  function showDropdown(results) {
    searchDropdown.innerHTML = '';
    if (!results.length) { searchDropdown.style.display = 'none'; return; }
    results.slice(0, 10).forEach(r => {
      const div = document.createElement('div');
      div.style.cssText = 'padding:8px 12px; cursor:pointer; border-bottom:1px solid #eee; font-size:0.9rem;';
      div.textContent = `${r.item.name}, ${r.item.county || ''}`;
      div.onmouseover = () => div.style.backgroundColor = '#f5f5f5';
      div.onmouseout = () => div.style.backgroundColor = '';
      div.onclick = () => selectPlace(r.item);
      searchDropdown.appendChild(div);
    });
    searchDropdown.style.display = 'block';
  }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   LOAD YORKSHIRE RIDINGS (INVISIBLE ‚Äì USED ONLY FOR POINT TESTING)
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

let yorkshireRidingsData = null;
let yorkshireRidingsReady = false;

fetch('subdivisions/YorkshireRidingsA.json')
  .then(r => r.json())
  .then(json => {
    yorkshireRidingsData = json;
    yorkshireRidingsReady = true;
    console.log("Yorkshire ridings loaded.");
  })
  .catch(err => console.error("Failed to load Yorkshire ridings:", err));



/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   SELECT PLACE ‚Äî WITH YORKSHIRE RIDING DETECTION
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function selectPlace(place) {

  // Remove old marker
  if (searchMarker) map.removeLayer(searchMarker);

  const baseName = place.name.split(',')[0];
  let popupText = `<b>${baseName}</b><br>${place.county}`;

  // Detect whether search result is in Yorkshire
  const isYorkshirePlace =
    (place.county && place.county === "Yorkshire") ||
    (place.name && place.name.toLowerCase().includes("yorkshire"));

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     YORKSHIRE RIDING CHECK (TURF)
     Uses only the GeoJSON boundaries invisibly
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  if (isYorkshirePlace && yorkshireRidingsReady && yorkshireRidingsData) {
    try {
      const pt = turf.point([Number(place.lon), Number(place.lat)]);
      let foundRiding = null;

      yorkshireRidingsData.features.forEach(feat => {
        if (!feat.geometry) return;
        if (turf.booleanPointInPolygon(pt, feat)) {
          const rn = feat.properties?.name?.trim();
          if (rn) foundRiding = rn;   // East Riding / North Riding / West Riding / York
        }
      });

      if (foundRiding) {
        popupText = `<b>${baseName}</b><br>Yorkshire (${foundRiding})`;
      }

    } catch (err) {
      console.warn("Yorkshire riding detection error:", err);
    }
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     SHOW MARKER + POPUP
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

  searchMarker = L.marker([place.lat, place.lon])
    .addTo(map)
    .bindPopup(popupText)
    .openPopup();

  map.setView([place.lat, place.lon], 11);
  searchDropdown.style.display = 'none';
  searchInput.value = place.name;

  setTimeout(() => showCountyFromPoint(place.lat, place.lon), 500);
}

let activeSubdivision = null;

// === MOVE loadSubdivisionLayer OUTSIDE the main fetch block ===
async function loadSubdivisionLayer(fileName, type, button) {
  // === TOGGLE OFF ===
  if (activeSubdivision && activeSubdivision.file === fileName) {
    if (subdivisionLayer) map.removeLayer(subdivisionLayer);
    subdivisionLayer = null;
    subdivisionLabels.forEach(l => map.removeLayer(l));
    subdivisionLabels = [];
    activeSubdivision = null;
    button.textContent = `Show ${type}`;
    button.classList.remove('active');
    return;
  }

  // === REMOVE PREVIOUS ===
  if (subdivisionLayer) map.removeLayer(subdivisionLayer);
  subdivisionLayer = null;
  subdivisionLabels.forEach(l => map.removeLayer(l));
  subdivisionLabels = [];

  // === LOAD NEW ===
  try {
    button.textContent = 'Loading‚Ä¶';
    button.classList.add('loading');
    button.disabled = true;

    const url = `subdivisions/${fileName}.json`;
    console.log('Fetching:', url);
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const geojson = await resp.json();

    subdivisionLayer = L.geoJSON(geojson, {
      style: { color: '#444', weight: 1.2, fillOpacity: 0.12, dashArray: '5,5' },
      onEachFeature: (feature, layer) => {
        const name = feature.properties.NAME || feature.properties.name || 'Unknown';
        layer.bindTooltip(name, { sticky: true });
        const center = layer.getBounds().getCenter();

        try {
          // === CANVAS TEXT MEASUREMENT (REUSABLE) ===
          if (!window._labelCanvas) window._labelCanvas = document.createElement('canvas');
          const ctx = window._labelCanvas.getContext('2d');
          ctx.font = '600 0.78rem sans-serif';

          const maxWidth = 180;
          const padding = 16;
          const minWidth = 60;
          const baseHeight = 30;
          const lineHeight = 16;

          let textWidth = ctx.measureText(name).width + padding;
          let width = Math.min(Math.max(textWidth, minWidth), maxWidth);
          let height = baseHeight;
          let displayName = name;

          if (textWidth > maxWidth) {
            const words = name.split(' ');
            let line1 = '', i = 0;
            while (i < words.length) {
              const test = line1 + (line1 ? ' ' : '') + words[i];
              if (ctx.measureText(test).width + padding > maxWidth - 20) break;
              line1 = test;
              i++;
            }
            const line2 = words.slice(i).join(' ');
            const w1 = ctx.measureText(line1).width + padding;
            const w2 = line2 ? ctx.measureText(line2).width + padding : 0;
            width = Math.min(Math.max(Math.max(w1, w2), minWidth), maxWidth);
            height = baseHeight + lineHeight;
            displayName = name.replace(/ (.+)/, '<br>$1');
          }

          const labelHtml = `
            <div style="
              background:#f3e9da;color:#9B2C2C;border:1px solid #9B2C2C;
              padding:4px 8px;border-radius:6px;font-weight:600;font-size:0.78rem;
              text-align:center;line-height:1.3;max-width:${maxWidth}px;
              width:${width}px;height:${height}px;display:flex;align-items:center;justify-content:center;
              box-shadow:0 1px 3px rgba(0,0,0,0.2);transition:all 0.2s ease;word-wrap:break-word;
              white-space:normal;
            "
            onmouseover="this.style.background='#9B2C2C';this.style.color='#f3e9da';this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#f3e9da';this.style.color='#9B2C2C';this.style.transform='scale(1)';">
              ${displayName}
            </div>`;
          const label = L.marker(center, {
            icon: L.divIcon({
              className: 'subdivision-label',
              html: labelHtml,
              iconSize: [width, height],
              iconAnchor: [width / 2, height / 2]
            })
          }).addTo(map);

          subdivisionLabels.push(label);
        } catch (e) {
          console.error('Label creation error:', e);
        }
      }
    }).addTo(map);

    activeSubdivision = { file: fileName, type, layer: subdivisionLayer };
    button.textContent = `Hide ${type}`;
    button.classList.remove('loading');
    button.classList.add('active');
    button.disabled = false;
  } catch (e) {
    console.error('Subdivision load error:', e);
    button.textContent = 'Error';
    button.classList.remove('loading');
    button.disabled = true;
  }
} // ‚Üê FUNCTION CLOSED

// === NOW SAFE: TOP-LEVEL ===
const subdivisionFiles = {
  "Yorkshire": {
    "Ridings": "YorkshireRidingsA",
    "Wapentakes": "YorkshireWapentakesA"
  },
  "Lincolnshire": {
    "Parts": "LincolnshirePartsA",
    "Wapentakes": "LincolnshireWapentakesA",
    "Lindsey Ridings": "LindseyRidingsA"
  },
  "Sussex": {
    "Rapes": "SussexRapesA",
    "Hundreds": "SussexHundredsA"
  },
  "Kent": {
    "Lathes": "KentLathes",
    "Hundreds": "KentHundreds"
  },
  "Cumberland": { "Wards": "CumberlandWards" },
  "Durham": { "Wards": "DurhamWardsA" },
  "Northumberland": { "Wards": "NorthumberlandWardsA" },
  "Westmorland": { "Wards": "WestmorlandWardsA" },
  // Hundreds by default
  "Anglesey": { "Hundreds": "AngleseyHundreds" },
  "Bedfordshire": { "Hundreds": "BedfordshireHundredsA" },
  "Berkshire": { "Hundreds": "BerkshireHundredsA" },
  "Brecknockshire": { "Hundreds": "BrecknockshireHundredsA" },
  "Buckinghamshire": { "Hundreds": "BuckinghamshireHundredsA" },
  "Caernarfonshire": { "Hundreds": "CaernarfonshireHundredsA" },
  "Cambridgeshire": { "Hundreds": "CambridgeshireHundreds" },
  "Cardiganshire": { "Hundreds": "CardiganshireHundreds" },
  "Carmarthenshire": { "Hundreds": "CarmarthenshireHundreds" },
  "Cheshire": { "Hundreds": "CheshireHundreds" },
  "Cornwall": { "Hundreds": "CornwallHundredsA" },
  "Denbighshire": { "Hundreds": "DenbighshireHundredsA" },
  "Derbyshire": { "Hundreds": "DerbyshireHundredsA" },
  "Devon": { "Hundreds": "DevonHundredsA" },
  "Dorset": { "Hundreds": "DorsetHundredsA" },
  "Essex": { "Hundreds": "EssexHundreds" },
  "Flintshire": { "Hundreds": "FlintshireHundredsA" },
  "Glamorgan": { "Hundreds": "GlamorganHundreds" },
  "Gloucestershire": { "Hundreds": "GloucestershireHundredsA" },
  "Hampshire": { "Hundreds": "HampshireHundredsA" },
  "Herefordshire": { "Hundreds": "HerefordshireHundredsA" },
  "Hertfordshire": { "Hundreds": "HertfordshireHundredsA" },
  "Huntingdonshire": { "Hundreds": "HuntingdonshireHundredsA" },
  "Lanarkshire": { "Wards": "LanarkshireWards" },
  "Lancashire": { "Hundreds": "LancashireHundredsA" },
  "Leicestershire": { "Hundreds": "LeicestershireHundredsA" },
  "Lindsey": { "Ridings": "LindseyRidingsA" },
  "Merionethshire": { "Hundreds": "MerionethshireHundredsA" },
  "Middlesex": { "Hundreds": "MiddlesexHundreds" },
  "Monmouthshire": { "Hundreds": "MonmouthshireHundredsA" },
  "Montgomeryshire": { "Hundreds": "MontgomeryshireHundredsA" },
  "Norfolk": { "Hundreds": "NorfolkHundreds" },
  "Suffolk": { "Hundreds": "SuffolkHundreds" },
  "Northamptonshire": { "Hundreds": "NorthamptonshireHundredsA" },
  "Nottinghamshire": { "Wapentakes": "NottinghamshireWapentakesA" },
  "Oxfordshire": { "Hundreds": "OxfordshireHundredsA" },
  "Pembrokeshire": { "Hundreds": "PembrokeshireHundreds" },
  "Radnorshire": { "Hundreds": "RadnorshireHundredsA" },
  "Rutland": { "Hundreds": "RutlandHundreds" },
  "Shropshire": { "Hundreds": "ShropshireHundredsA" },
  "Somerset": { "Hundreds": "SomersetHundredsA" },
  "Staffordshire": { "Hundreds": "StaffordshireHundredsA" },
  "Surrey": { "Hundreds": "SurreyHundreds" },
  "Warwickshire": { "Hundreds": "WarwickshireHundredsA" },
  "Wiltshire": { "Hundreds": "WiltshireHundredsA" },
  "Worcestershire": { "Hundreds": "WorcestershireHundredsA" }
};
  function showCountyFromPoint(lat, lon) {
    const point = turf.point([lon, lat]);
    let found = null;
    map.eachLayer(l => {
      if (l instanceof L.GeoJSON) {
        l.eachLayer(cl => {
          if (cl.getBounds && cl.getBounds().contains([lat, lon]) && turf.booleanPointInPolygon(point, cl.feature)) {
            found = cl;
          }
        });
      }
    });
    if (found) {
      const englishName = found.feature.properties.NAME;
      const centroid = turf.centroid(found.feature);
      window.updateCountyCard(englishName, found, centroid.geometry.coordinates[1], centroid.geometry.coordinates[0]);
      if (window.innerWidth <= 1024) sidebar.classList.add('visible');
    } else {
      infoDiv.innerHTML = '<em>County not found.</em>';
    }
  }

// === REPLACE ENTIRE CSV LOADING BLOCK WITH THIS ===
fetch('places_clean.csv')
  .then(r => r.ok ? r.text() : Promise.reject(`CSV load failed: ${r.status}`))
  .then(csvText => {
    Papa.parse(csvText, {
      header: false,
      skipEmptyLines: true,
      complete: function(results) {
        for (let i = 1; i < results.data.length; i++) {
          const row = results.data[i];
          if (row.length < 8) continue;
          const desc = row[2]?.trim();
          const name = row[0]?.trim();
          const county = row[3]?.trim();
          const lat = parseFloat(row[6]);
          const lon = parseFloat(row[7]);
          if (['LOC','PAR','COM','CTYHIST','NPARK'].includes(desc) && name && !isNaN(lat) && !isNaN(lon)) {
            window.places.push({ name, county, lat, lon });
          }
        }
        initFuse();
        console.log(`Loaded ${window.places.length} places`);
      }
    });
  })
  .catch(err => {
    console.error("CSV fetch failed:", err);
    infoDiv.innerHTML = '<em style="color:red;">Failed to load places data.</em>';
  });

  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim();
    if (!q || !fuse) { searchDropdown.style.display = 'none'; return; }
    showDropdown(fuse.search(q));
  });

  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && fuse) {
      const res = fuse.search(searchInput.value.trim());
      if (res.length) selectPlace(res[0].item);
    }
  });

  document.addEventListener('click', e => {
    if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
      searchDropdown.style.display = 'none';
    }
  });
  // ELIMINATE TOOLTIP FLICKER PERMANENTLY (one line!)
  map.getPane('tooltipPane').style.pointerEvents = 'none';
    }
          // === SHARE THIS COUNTY BUTTON ===
        document.getElementById('shareCountyBtn')?.addEventListener('click', () => {
          const cleanName = englishName.replace(/ /g, '-').replace(/[^a-zA-Z-]/g, '');
          const shareUrl = window.location.origin + window.location.pathname + '#' + cleanName;

          if (navigator.share) {
            // Native mobile share sheet (Android/iOS)
            navigator.share({
              title: `Historic ${englishName}`,
              url: shareUrl
            }).catch(() => {}); // user cancelled ‚Üí silent
          } else {
            // Desktop + fallback: copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
              const feedback = document.getElementById('shareFeedback');
              feedback.textContent = 'Link copied!';
              feedback.style.color = '#9B2C2C';
              setTimeout(() => feedback.textContent = '', 3000);
            });
          }
        });

        // Also open the correct county when page has a hash on load
        if (window.location.hash) {
          const hashName = decodeURIComponent(window.location.hash.substring(1)).replace(/-/g, ' ');
          map.eachLayer(l => {
            if (l instanceof L.GeoJSON) {
              l.eachLayer(poly => {
                if (poly.feature?.properties?.NAME === hashName) {
                  setTimeout(() => poly.fire('click'), 800); // wait for map ready
                }
              });
            }
          });
        }
  
</script>
</body>
</html>
