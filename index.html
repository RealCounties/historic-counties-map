<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Historic Counties Interactive Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
#container { display: flex; height: 100%; }
#sidebar { width: 340px; background: #f7f7f7; padding: 15px; overflow-y: auto; border-right: 1px solid #ccc; }
#map { flex: 1; }

.county-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.county-card h3 { margin-top: 0; color: #333; }
.county-card p { margin: 4px 0; }
.county-card a { color: #0066cc; text-decoration: none; }
.county-card a:hover { text-decoration: underline; }

/* Tooltip style */
.leaflet-tooltip.county-tooltip {
  background-color: rgba(255,255,255,0.9);
  border: 1px solid #333;
  color: #333;
  font-weight: bold;
  padding: 2px 6px;
  border-radius: 4px;
}
</style>
</head>
<body>

<div id="container">
  <div id="sidebar">
    <h2>Historic Counties</h2>
    <p>Select a county to view details.</p>
    <div id="info"><em>No county selected.</em></div>
  </div>
  <div id="map"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/polylabel@1.0.3/polylabel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
window.onload = function() {

  // County data
  var countyData = {
    "Aberdeenshire": { area: "1,950 sq mi", population: "380,495", link: "" },
    "Anglesey": { area: "277 sq mi", population: "69,751", link: "" },
    "Angus": { area: "899 sq mi", population: "264,044", link: "" },
    // … add all remaining counties …
  };

  // Initialize map
  var map = L.map('map', { center: [54.5, -3], zoom: 6, minZoom: 5 });

  // Base OSM map
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: attribution: '&copy; <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> contributors | <a href="https://county-borders.co.uk" target="_blank">Historic County Borders Project</a>'
    maxZoom: 19
  }).addTo(map);

  // Restrict map to British Isles
  var ukBounds = L.latLngBounds([49.5, -8.5], [60.9, 2.0]);
  map.setMaxBounds(ukBounds);
  map.fitBounds(ukBounds);

  var infoDiv = document.getElementById('info');

  // Load GeoJSON
  fetch('./counties_simplified8.json')
    .then(res => res.json())
    .then(data => {
      const pastelColors = [
        "#ffdede", "#dedefd", "#deffde", "#fff0de", "#fdefff",
        "#dfffee", "#ffe7de", "#f0deff", "#defff5", "#fdeeee",
        "#e6f7ff", "#f9ffe6", "#fff6e6", "#e6e6ff", "#ffe6f2"
      ];
      data.features.forEach((feature, idx) => {
        feature.properties.color = pastelColors[idx % pastelColors.length];
      });

      // Main county polygons layer
      var geoJsonLayer = L.geoJSON(data, {
        filter: f => f.geometry && f.geometry.coordinates && f.geometry.coordinates.length > 0,
        style: f => ({
          color: "#333",
          weight: 1,
          fillColor: f.properties.color,
          fillOpacity: 0.35,
          fillRule: 'evenodd'
        }),
        onEachFeature: (feature, layer) => {
          const details = countyData[feature.properties.NAME];
          const areaText = details?.area || 'Unknown area';
          layer.bindTooltip(`${feature.properties.NAME} — ${areaText}`, {
            permanent: false,
            direction: 'top',
            className: 'county-tooltip'
          });

          layer.on('click', () => {
            infoDiv.innerHTML = `<div class="county-card">
              <h3>${feature.properties.NAME}</h3>
              <p><strong>Area:</strong> ${details?.area || 'Unknown'}</p>
              <p><strong>Population:</strong> ${details?.population || 'Unknown'}</p>
              ${details?.link ? `<p><a href="${details.link}" target="_blank">More about ${feature.properties.NAME}</a></p>` : ''}
            </div>`;
            try { map.fitBounds(layer.getBounds()); } catch(e) {}
          });

          layer.on('mouseover', () => layer.setStyle({ weight: 2, color: '#111' }));
          layer.on('mouseout', () => layer.setStyle({ weight: 1, color: '#333' }));
        }
      }).addTo(map);

      if (geoJsonLayer.getBounds().isValid()) map.fitBounds(geoJsonLayer.getBounds());
      setTimeout(() => map.invalidateSize(), 100);

      // County name labels
      var labelLayer = L.layerGroup();
      geoJsonLayer.eachLayer(layer => {
        if (layer.feature && layer.feature.properties && layer.feature.properties.NAME) {
          var coords = layer.feature.geometry.coordinates;
          var polygons = layer.feature.geometry.type === 'MultiPolygon' ? coords : [coords];
          var largestPoly = polygons.reduce((maxPoly, poly) => {
            var area = turf.area({ type: 'Polygon', coordinates: poly });
            return area > (maxPoly.area || 0) ? { coordinates: poly, area: area } : maxPoly;
          }, {});
          var labelPoint = polylabel(largestPoly.coordinates, 1.0);
          var label = L.marker([labelPoint[1], labelPoint[0]], {
            icon: L.divIcon({
              className: 'county-label',
              html: layer.feature.properties.NAME,
              iconSize: [100, 20],
              iconAnchor: [50, 10]
            })
          });
          labelLayer.addLayer(label);
        }
      });

      var style = document.createElement('style');
      style.textContent = `
        .county-label {
          font-size: 13px;
          font-weight: bold;
          color: #222;
          text-shadow: 0 0 4px rgba(255,255,255,0.8);
          pointer-events: none;
          white-space: nowrap;
          text-align: center;
        }
      `;
      document.head.appendChild(style);

      // Toggle button for labels
      var LabelsControl = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function(map) {
          var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
          var button = L.DomUtil.create('a', '', container);
          button.href = '#';
          button.title = 'Toggle County Names';
          button.innerHTML = '🏷️';
          button.style.width = '34px';
          button.style.height = '34px';
          button.style.lineHeight = '34px';
          button.style.textAlign = 'center';
          button.style.fontSize = '18px';
          button.style.background = 'white';
          button.style.color = '#333';
          button.style.cursor = 'pointer';

          L.DomEvent.disableClickPropagation(container);

          var labelsVisible = false;
          L.DomEvent.on(button, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            if (labelsVisible) {
              map.removeLayer(labelLayer);
              button.style.background = 'white';
            } else {
              map.addLayer(labelLayer);
              button.style.background = '#e6e6e6';
            }
            labelsVisible = !labelsVisible;
          });

          return container;
        }
      });
      map.addControl(new LabelsControl());

      // Auto show/hide labels on zoom
      map.on('zoomend', function() {
        if (map.getZoom() >= 7) {
          if (!map.hasLayer(labelLayer)) map.addLayer(labelLayer);
        } else {
          if (map.hasLayer(labelLayer)) map.removeLayer(labelLayer);
        }
      });

    }).catch(err => console.error('GeoJSON error:', err));

  // Search control
  L.Control.geocoder({
    defaultMarkGeocode: true,
    placeholder: 'Search town, village, postcode…',
    geocoder: new L.Control.Geocoder.Nominatim(),
    inputId: 'geocoder-input'
  }).addTo(map);

};
</script>
</body>
</html>
