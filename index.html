<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Historic Counties Interactive Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
<style>
:root {
  --bg: #faf4e6; --card-bg: #f3e9da; --text: #333; --border: #ccc;
  --shadow: rgba(0,0,0,0.2); --accent: #9B2C2C; --tooltip-bg: rgba(255,255,255,0.9);
}
html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
#container { display:flex; height:100%; }
#logo-container { text-align:center; margin-bottom:10px; }
#sidebar-logo { max-width:50%; height:auto; display:block; margin:0 auto; opacity:0; transform:scale(0.9); animation:logoLoad 1.4s ease-out forwards; }
@keyframes logoLoad { 0% { opacity:0; transform:scale(0.9) translateY(10px); } 60% { opacity:1; transform:scale(1.02); } 100% { opacity:1; transform:scale(1); } }
#logo-link { display:block; transition:opacity .25s ease; } #logo-link:hover { opacity:.85; }
#sidebar { width:340px; background:var(--bg); padding:15px; overflow-y:auto; border-right:1px solid var(--border); transition:all .3s ease; position:relative; color:var(--text); }
#search-bar { margin-top:15px; display:flex; gap:6px; align-items:center; justify-content:center; }
#search-bar input { flex:1; min-width:140px; padding:10px 12px; border:1px solid var(--border); border-radius:4px; font-size:.9rem; color:var(--text); background:#fff; box-shadow:0 2px 4px var(--shadow); transition:all .25s; }
#search-bar input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(155,44,44,.2); }
#search-bar button { padding:10px 18px; background:var(--accent); color:#FAF4E6; border:none; border-radius:4px; font-weight:500; box-shadow:0 3px 6px var(--shadow); cursor:pointer; transition:all .25s cubic-bezier(.4,0,.2,1); }
#search-bar button:hover { background:#7a2222; transform:translateY(-2px) scale(1.05); box-shadow:0 6px 14px var(--shadow); }
#map { flex:1; background:#e0f2fe; }
/* ---- CARD LAYOUT WITH FLAG ---- */
.county-card {
  background:var(--card-bg); padding:14px; border-radius:10px;
  box-shadow:0 2px 6px var(--shadow); transition:all .3s ease;
  cursor:pointer; text-align:center; margin-bottom:16px;
}
.county-card:hover { transform:translateY(-6px); box-shadow:0 8px 18px var(--shadow); }
.county-card .flag {
  width:64px; height:auto; border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.25); margin:0 auto 12px;
  display:block;
}
.county-card .card-body { }
.county-card h3 {
  margin:0 0 12px; font-size:1.25rem; color:var(--text);
  word-wrap:break-word; line-height:1.3; text-align:center;
}
.weather-badge { display:inline-block; font-size:0.82rem; background:rgba(0,0,0,0.1); color:var(--text); padding:6px 12px; border-radius:16px; font-weight:500; box-shadow:0 1px 3px rgba(0,0,0,0.12); }
.weather-underline { width:60px; height:2px; background:var(--accent); margin:8px auto 12px; border-radius:1px; }
.county-card p, .county-card ul { margin:6px 0; }
.county-card a { color:#0066cc; text-decoration:none; } .county-card a:hover { text-decoration:underline; }
.leaflet-tooltip.county-tooltip { background:var(--tooltip-bg); border:1px solid var(--accent); color:var(--text); font-weight:bold; padding:2px 6px; border-radius:4px; }
#closeSidebar { display:none; position:absolute; top:10px; right:12px; width:32px; height:32px; font-size:20px; color:#666; background:rgba(255,255,255,0.9); border:none; border-radius:50%; cursor:pointer; align-items:center; justify-content:center; z-index:1001; }
#closeSidebar:hover { background:#fff; }
@media (max-width:1024px) {
  #container { flex-direction:column; }
  #sidebar { position:fixed; bottom:16px; left:16px; width:45vw; max-width:380px; max-height:50vh; background:var(--bg); border-radius:14px; box-shadow:0 6px 20px var(--shadow); padding:14px; overflow-y:auto; transform:translateY(120%); transition:transform .32s cubic-bezier(.4,0,.2,1); z-index:1000; display:block !important; font-size:.94rem; }
  #sidebar.visible { transform:translateY(0); }
  #map { height:100vh !important; }
  #sidebar-logo { max-width:50%; }
  #closeSidebar { display:flex; }
}
@media (max-width:480px) { #sidebar { width:90vw; left:5vw; max-width:none; } #sidebar-logo { max-width:55%; } }
#sidebar h2 { text-align:center; margin:5px 0 10px; color:var(--accent); }
#logo-link:hover img {
  opacity: 0.8;
  transform: scale(0.98);
  transition: all 0.2s ease;
}
</style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <button id="closeSidebar">x</button>
    <div id="logo-container">
      <div id="logo-link" style="cursor:pointer;" onclick="resetMapAndSidebar()">
        <img src="https://realcounties.wordpress.com/wp-content/uploads/2025/06/logo-full-trans-16-6-25.png" alt="Reset Map - Historic Counties" id="sidebar-logo">
      </div>
    </div>
    <h2>Interactive Map</h2>
    <p>Select a county to view details.</p>
    <div id="info"><em>Loading counties...</em></div>
    <div id="search-bar">
      <input type="text" id="placeSearch" placeholder="Search for a place...">
      <button id="searchBtn">Search</button>
    </div>
    <div id="searchDropdown" style="position:absolute;background:white;border:1px solid #ccc;max-height:200px;overflow-y:auto;width:calc(100%-60px);display:none;z-index:1001;margin-top:5px;box-shadow:0 4px 8px rgba(0,0,0,0.1);"></div>
  </div>
  <div id="map"></div>
</div>

<script>
window.onload = function() {
  const sidebar = document.getElementById('sidebar');
  const closeBtn = document.getElementById('closeSidebar');
  const infoDiv = document.getElementById('info');
  const searchInput = document.getElementById('placeSearch');
  const searchDropdown = document.getElementById('searchDropdown');
  
  // Initialize map
  const map = L.map('map', { center: [54.5, -3], zoom: 6, minZoom: 5 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> | <a href="https://county-borders.co.uk" target="_blank">Historic County Borders Project</a>',
    maxZoom: 19
  }).addTo(map);

  const ukBounds = L.latLngBounds([49.5, -8.5], [60.9, 2.0]);
  map.setMaxBounds(ukBounds);
  map.fitBounds(ukBounds);

  // Toggle button
  const toggleButton = L.control({ position: 'topright' });
  toggleButton.onAdd = function() {
    const btn = L.DomUtil.create('button', 'leaflet-bar');
    btn.innerHTML = 'Info'; btn.title = 'Show county info';
    btn.style.cssText = 'background:white; border:1px solid #999; width:34px; height:34px; font-size:18px; cursor:pointer; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,0.3);';
    btn.onclick = () => sidebar.classList.toggle('visible');
    return btn;
  };
  toggleButton.addTo(map);
  closeBtn.onclick = () => sidebar.classList.remove('visible');

  function resetMapAndSidebar() {
    // Reset map view
    map.fitBounds(ukBounds);

    // Clear sidebar info
    infoDiv.innerHTML = '<em>Click a county to explore.</em>';

    // Remove county highlight
    if (currentLayer) {
      currentLayer.setStyle({ weight: 1, fillOpacity: 0.35 });
      currentLayer = null;
    }

    // Remove search marker
    if (searchMarker) {
      map.removeLayer(searchMarker);
      searchMarker = null;
    }

    // Clear search
    searchInput.value = '';
    searchDropdown.style.display = 'none';

    // Close mobile sidebar
    if (window.innerWidth <= 1024) {
      sidebar.classList.remove('visible');
    }
  }
  // County flags
  const countyFlags = {
    "Aberdeenshire": "https://realcounties.com/wp-content/uploads/2023/11/aberdeenshire-flag.png",
    "Anglesey": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/anglesey.png",
    "Banffshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/banffshire-flag-1.jpg",
    "Berkshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/berkshire.png",
    "Berwickshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/berwickshire.png",
    "Buckinghamshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/buckinghamshire.png",
    "Caernarfonshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/caernarfonshire.png",
    "Caithness": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/caithness-flag.png",
    "Cambridgeshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/cambridgeshire.png",
    "Cheshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/cheshire.png",
    "Cornwall": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/cornwall.png",
    "Cumberland": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/cumberland.png",
    "Derbyshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/derbyshire.jpg",
    "Devon": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/devon.jpg",
    "Dorset": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/dorset.jpg",
    "Durham": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/county-durham.png",
    "East Lothian": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/east-lothian-flag.png",
    "Essex": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/essex.jpg",
    "Flintshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/flintshire.png",
    "Glamorgan": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/glamorgan.png",
    "Gloucestershire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/gloucestershire.png",
    "Hampshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/hampshire.png",
    "Herefordshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/herefordshire.png",
    "Hertfordshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/hertfordshire.png",
    "Huntingdonshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/huntingdonshire.png",
    "Kent": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/kent.png",
    "Kirkcudbrightshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/kirkcudbrightshire-flag.png",
    "Lancashire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/lancashire.png",
    "Leicestershire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/leicestershire.png",
    "Lincolnshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/lincolnshire.png",
    "Middlesex": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/middlesex.png",
    "Monmouthshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/monmouthshire.png",
    "Morayshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/morayshire-flag-2.jpg",
    "Norfolk": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/norfolk.png",
    "Northamptonshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/northamptonshire.png",
    "Northumberland": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/northumberland.jpg",
    "Nottinghamshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/nottinghamshire.jpg",
    "Orkney": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/orkney-flag.png",
    "Oxfordshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/oxfordshire.png",
    "Pembrokeshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/pembrokeshire.png",
    "Rutland": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/rutland.png",
    "Shetland": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/shetland-flag.png",
    "Shropshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/shropshire.png",
    "Somerset": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/somerset.png",
    "Staffordshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/staffordshire.png",
    "Suffolk": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/suffolk.png",
    "Surrey": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/surrey.png",
    "Sussex": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/sussex.png",
    "Sutherland": "https://realcounties.wordpress.com/wp-content/uploads/2023/10/sutherland-flag.png",
    "Warwickshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/warwickshire.png",
    "Westmorland": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/westmorland.jpg",
    "Wiltshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/wiltshire.png",
    "Worcestershire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/worcestershire.png",
    "Yorkshire": "https://realcounties.wordpress.com/wp-content/uploads/2023/11/yorkshire.jpg"
  };

  async function fetchWeather(lat, lon) {
    try {
      const res = await axios.get(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m`);
      const temp = Math.round(res.data.current.temperature_2m);
      const code = res.data.current.weather_code;
      const windKmh = res.data.current.wind_speed_10m;
      const windMph = Math.round(windKmh * 0.621371);
      const descMap = {
        0: 'Clear', 1: 'Mostly clear', 2: 'Partly cloudy', 3: 'Overcast',
        45: 'Fog', 48: 'Fog', 51: 'Light drizzle', 53: 'Drizzle', 55: 'Heavy drizzle',
        61: 'Light rain', 63: 'Rain', 65: 'Heavy rain',
        71: 'Light snow', 73: 'Snow', 75: 'Heavy snow',
        80: 'Showers', 81: 'Rain showers', 82: 'Heavy showers', 95: 'Thunderstorm'
      };
      const desc = descMap[code] || 'Unknown';
      return { temp, desc, wind: windMph };
    } catch (err) {
      console.error("Weather fetch failed:", err);
      return null;
    }
  }

  let currentLayer = null;
  let photoTimeout;
  function showPhoto(landmark, e) {
    clearTimeout(photoTimeout);
    const img = document.createElement('img');
    img.src = `https://source.unsplash.com/400x300/?${encodeURIComponent(landmark + ' UK')}`;
    img.style.cssText = 'position:absolute; top:'+(e.clientY+10)+'px; left:'+(e.clientX+10)+'px; width:200px; height:auto; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:10000;';
    img.onload = () => document.body.appendChild(img);
    window.photoImg = img;
  }
  function hidePhoto() {
    photoTimeout = setTimeout(() => {
      if (window.photoImg) { document.body.removeChild(window.photoImg); delete window.photoImg; }
    }, 300);
  }

  // Load county data
  fetch('./counties_simplified8.json')
    .then(res => res.ok ? res.json() : Promise.reject(`Failed: ${res.status}`))
    .then(data => {
      const countyData = {
        "Aberdeenshire": { area: 1950, population: 380495, events: ["Battle of Harlaw (1411)", "Aberdeen University founded (1495)"], landmarks: ["Slains Castle", "Balmoral Castle", "Dunnottar Castle"], notablePersons: ["John Barbour, author (c.1320-1395)", "James Gregory, mathematician (1638-1675)", "Annie Lennox, singer (1954-present)"] },
        "Anglesey": { area: 277, population: 69751, events: ["Roman invasion repelled (60 AD)", "Menai Bridge opened (1826)"], landmarks: ["Beaumaris Castle", "South Stack Lighthouse", "Menai Suspension Bridge"] },
        "Angus": { area: 899, population: 264044, events: ["Battle of Nechtansmere (AD 685)", "Battle of Arbroath (1445)", "RAF Montrose - Birth of Military Aviation (1913)"], landmarks: ["Glamis Castle", "Arbroath Abbey", "Lunan Bay"] }, 
        "Antrim": { area: 1175, population: 615701, events: ["Titanic built in Belfast (1912)", "Giant's Causeway formed (~60M BC)"], landmarks: ["Giant's Causeway", "Carrickfergus Castle", "Dark Hedges"] },
        "Argyllshire": { area: 3110, population: 64819, events: ["Iona Abbey founded (563 AD)", "Massacre of Glencoe (1692)"], landmarks: ["Iona Abbey", "Inveraray Castle", "Oban Distillery"] },
        "Armagh": { area: 512, population: 178598, events: ["St. Patrick founds cathedral (445 AD)", "Armagh Observatory opens (1790)"], landmarks: ["Armagh Cathedral", "Navan Fort", "Armagh Planetarium"] },
        "Ayrshire": { area: 1129, population: 367676, events: ["Robert Burns born (1759)", "Ayr Racecourse founded (1907)"], landmarks: ["Culzean Castle", "Burns Cottage", "Ailsa Craig"] },
        "Banffshire": { area: 641, population: 46537, events: ["Whisky boom begins (1820s)", "Banff Bridge built (1779)"], landmarks: ["Duff House", "Balvenie Castle", "Glenfiddich Distillery"] },
        "Bedfordshire": { area: 468, population: 602847, events: ["Bunyan writes Pilgrim's Progress (1678)", "Woburn Safari Park opens (1970)"], landmarks: ["Woburn Abbey", "Whipsnade Zoo", "Shuttleworth Collection"] },
        "Berkshire": { area: 722, population: 842804, events: ["Battle of Reading (871)", "Re-Foundation of Abingdon Abbey (1080s)"], landmarks: ["Windsor Castle", "Ascot Racecourse", "Uffington White Horse"] },
        "Berwickshire": { area: 457, population: 26458, events: ["Flodden Field aftermath (1513)", "Union of Crowns impacts (1603)"], landmarks: ["Paxton House", "Duns Castle", "St Abb’s Head"] },
        "Brecknockshire": { area: 742, population: 67598, events: ["Norman conquest of Brycheiniog (1093)", "Brecon & Merthyr Railway (1863)"], landmarks: ["Brecon Beacons", "Brecon Cathedral", "Llangorse Lake"] },
        "Buckinghamshire": { area: 746, population: 916903, events: ["Bletchley Park breaks Enigma (1940)", "Eton College founded (1440)"], landmarks: ["Bletchley Park", "Stowe House", "Eton College"] },
        "Buteshire": { area: 225, population: 12534, events: ["Rothesay Castle built (1200s)", "Mount Stuart completed (1879)"], landmarks: ["Rothesay Castle", "Mount Stuart House", "Bute Museum"] },
        "Caernarfonshire": { area: 563, population: 139065, events: ["Edward I builds castle (1283)", "Prince Charles investiture (1969)"], landmarks: ["Caernarfon Castle", "Snowdon", "Llanberis Slate Museum"] },
        "Caithness": { area: 618, population: 26486, events: ["Norse earldom (871)", "Dounreay nuclear site (1955)"], landmarks: ["Castle of Mey", "John o’ Groats", "Duncansby Stacks"] },
        "Cambridgeshire": { area: 858, population: 460448, events: ["University founded (1209)", "Fens drained (1630s)"], landmarks: ["King’s College Chapel", "Ely Cathedral", "Duxford IWM"] },
        "Cardiganshire": { area: 693, population: 75784, events: ["Aberystwyth Castle built (1277)", "Aberystwyth University (1872)"], landmarks: ["Devil’s Bridge", "Strata Florida Abbey", "Vale of Rheidol Railway"] },
        "Carmarthenshire": { area: 937, population: 184232, events: ["Rebecca Riots (1839-43)", "National Botanic Garden opens (2000)"], landmarks: ["Carreg Cennen Castle", "Laugharne Castle", "National Botanic Garden"] },
        "Cheshire": { area: 1035, population: 1668894, events: ["Roman Deva fortress (70 AD)", "Siege of Chester (1644–1646)", "Jodrell Bank telescope (1957)"], landmarks: ["Chester Cathedral", "Beeston Castle", "Dunham Massey"] },
        "Clackmannanshire": { area: 48, population: 50957, events: ["Sauchieburn Battle aftermath (1488)", "Gartmorn Dam completed (1713)"], landmarks: ["Alloa Tower", "Castle Campbell", "Dollar Glen"] },
        "Cornwall": { area: 1365, population: 533594, events: ["Tin mining peak (1800s)", "Eden Project opens (2001)"], landmarks: ["St Michael’s Mount", "Eden Project", "Tintagel Castle"] },
        "Cromartyshire": { area: 370, population: 7074, events: ["Hugh Miller fossils (1820s)", "Cromarty Courthouse built (1773)"], landmarks: ["Cromarty Courthouse", "Hugh Miller’s Cottage", "Invergordon"] },
        "Cumberland": { area: 1525, population: 306241, events: ["Hadrian’s Wall built (122 AD)", "Lake District National Park (1951)"], landmarks: ["Carlisle Castle", "Hadrian’s Wall", "Scafell Pike"] },
        "Denbighshire": { area: 668, population: 227680, events: ["Denbigh Castle built (1282)", "Pontcysyllte Aqueduct opens (1805)", "Opening of Llyn Brenig Reservoir (1970)"], landmarks: ["Denbigh Castle", "Pontcysyllte Aqueduct", "Llangollen Railway"] },
        "Derbyshire": { area: 1017, population: 1148373, events: ["Cromford Mill opens (1771)", "Peak District National Park (1951)"], landmarks: ["Chatsworth House", "Cromford Mill", "Peak Cavern"] },
        "Devon": { area: 2621, population: 1133463, events: ["Drake plays bowls (1588)", "Jurassic Coast UNESCO (2001)"], landmarks: ["Dartmoor", "Exeter Cathedral", "Jurassic Coast"] },
        "Dorset": { area: 1005, population: 543296, events: ["Tolpuddle Martyrs (1834)", "Dorset Coast UNESCO (2001)"], landmarks: ["Cerne Abbas Giant", "Lulworth Cove", "Durdlestone Head"] },
        "Down": { area: 950, population: 528983, events: ["St. Patrick lands (432 AD)", "Scrabo Tower built (1857)"], landmarks: ["Mourne Mountains", "Downpatrick Cathedral", "Scrabo Tower"] },
        "Dumfriesshire": { area: 1063, population: 77160, events: ["Robert the Bruce kills Comyn (1306)", "Devorgilla Bridge built (1432)"], landmarks: ["Caerlaverock Castle", "Sweetheart Abbey", "Devorgilla Bridge"] },
        "Dunbartonshire": { area: 241, population: 262419, events: ["Viking siege of Dumbarton (870)", "Hill House designed (1904)"], landmarks: ["Dumbarton Castle", "Loch Lomond", "Hill House"] },
        "Durham": { area: 1022, population: 1467037, events: ["Durham Cathedral founded (1093)", "Beamish Museum opens (1970)"], landmarks: ["Durham Cathedral", "Beamish Museum", "High Force Waterfall"] },
        "East Lothian": { area: 267, population: 74882, events: ["Battle of Prestonpans (1745)", "John Muir born (1838)"], landmarks: ["Tantallon Castle", "Dirleton Castle", "Bass Rock"] },
        "Essex": { area: 1591, population: 2999248, events: ["Battle of Maldon (991)", "Southend Pier opens (1830)"], landmarks: ["Colchester Castle", "Audley End House", "Southend Pier"] },
        "Fermanagh": { area: 715, population: 61170, events: ["Devenish Island monastery (6th c.)", "Marble Arch Caves discovered (1895)"], landmarks: ["Enniskillen Castle", "Devenish Island", "Marble Arch Caves"] },
        "Fife": { area: 504, population: 365493, events: ["St Andrews University founded (1413)", "Culross Palace completed (1597)"], landmarks: ["St Andrews Cathedral", "Falkland Palace", "Culross Palace"] },
        "Flintshire": { area: 260, population: 215390, events: ["Flint Castle built (1277)", "Greenfield Valley mills (1780s)", "National Eisteddfod at Mold (1923 & 1991)"], landmarks: ["Flint Castle", "St Winifred’s Well", "Basingwerk Abbey"] },
        "Glamorgan": { area: 827, population: 1321460, events: ["Coal boom begins (1800s)", "Castell Coch rebuilt (1870s)"], landmarks: ["Cardiff Castle", "Castell Coch", "National Museum Cardiff"] },
        "Gloucestershire": { area: 1293, population: 1147106, events: ["Berkeley Castle: Edward II murdered (1327)", "Cotswold Way opens (1970)"], landmarks: ["Gloucester Cathedral", "Berkeley Castle", "Cotswold Way"] },
        "Hampshire": { area: 1656, population: 2099640, events: ["Jane Austen at Chawton (1809)", "Winchester Cathedral begun (1079)"], landmarks: ["Portsmouth Dockyard", "Winchester Cathedral", "New Forest"] },
        "Herefordshire": { area: 837, population: 183631, events: ["Offa’s Dyke built (8th c.)", "Mappa Mundi created (1300)"], landmarks: ["Hereford Cathedral", "Goodrich Castle", "Black & White Villages"] },
        "Hertfordshire": { area: 633, population: 1157166, events: ["St Albans Roman city (43 AD)", "Warner Bros. Studio opens (2012)"], landmarks: ["St Albans Cathedral", "Hatfield House", "Warner Bros. Studio"] },
        "Huntingdonshire": { area: 366, population: 211776, events: ["Cromwell born (1599)", "Grafham Water opens (1965)"], landmarks: ["Hinchingbrooke House", "Ramsey Abbey Gatehouse", "Grafham Water"] },
        "Inverness-shire": { area: 4211, population: 118077, events: ["Urquhart Castle built (1200s)", "Loch Ness Monster reported (1933)"], landmarks: ["Loch Ness", "Urquhart Castle", "Eilean Donan Castle"] },
        "Kent": { area: 1611, population: 2747715, events: ["Canterbury Cathedral founded (597)", "Dover Castle built (1180s)"], landmarks: ["Canterbury Cathedral", "Leeds Castle", "White Cliffs of Dover"] },
        "Kincardineshire": { area: 380, population: 77670, events: ["Dunnottar Castle siege (1651)", "Fetteresso Castle rebuilt (1782)"], landmarks: ["Dunnottar Castle", "Stonehaven Harbour", "Muchalls Castle"] },
        "Kinross-shire": { area: 73, population: 11223, events: ["Mary Queen imprisoned (1567)", "Loch Leven Castle ruins (1300s)"], landmarks: ["Loch Leven Castle", "Kinross House", "RSPB Vane Farm"] },
        "Kirkcudbrightshire": { area: 899, population: 47546, events: ["Artists’ colony begins (1880s)", "Broughton House museum (1920s)"], landmarks: ["Threave Castle", "Broughton House", "Dundrennan Abbey"] },
        "Lanarkshire": { area: 879, population: 1008014, events: ["New Lanark founded (1800)", "Chatelherault built (1740s)"], landmarks: ["New Lanark", "Chatelherault", "Falls of Clyde"] },
        "Lancashire": { area: 1909, population: 4942364, events: ["Scottish Raid & Burning of Lancaster (1322)", "Pendle Witch Trials (1612)", "Cotton Industry Strikes (1936-37)"], landmarks: ["Lancaster Castle", "Blackpool Tower", "Royal Albert Dock"] },
        "Leicestershire": { area: 836, population: 975403, events: ["Bosworth Battle (1485)", "National Space Centre (2001)"], landmarks: ["Bosworth Battlefield", "Belvoir Castle", "National Space Centre"] },
        "Lincolnshire": { area: 2687, population: 1038510, events: ["Lincoln Cathedral tallest (1311)", "Tattershall Castle built (1430s)"], landmarks: ["Lincoln Cathedral", "Tattershall Castle", "Theddlethorpe Dunes"] },
        "Londonderry": { area: 816, population: 247971, events: ["City walls built (1613)", "Peace Bridge opens (2011)"], landmarks: ["Derry City Walls", "Guildhall", "Peace Bridge"] },
        "Merionethshire": { area: 676, population: 37874, events: ["Glyndŵr parliament (1404)", "Bala Lake railway (1868)"], landmarks: ["Harlech Castle", "Portmeirion Village", "Cader Idris"] },
        "Middlesex": { area: 285, population: 4000927, events: ["Hampton Court built (1515)", "Kew Gardens UNESCO (2003)"], landmarks: ["Hampton Court Palace", "Kew Gardens", "Wembley Stadium"] },
        "Midlothian": { area: 362, population: 621610, events: ["Edinburgh Castle founded (1100s)", "Scottish Parliament opens (2004)"], landmarks: ["Edinburgh Castle", "Rosslyn Chapel", "Scottish Parliament"] },
        "Monmouthshire": { area: 542, population: 514723, events: ["Chartist March (1839)", "Big Pit opens as museum (1983)"], landmarks: ["Tintern Abbey", "Raglan Castle", "Big Pit"] },
        "Montgomeryshire": { area: 796, population: 61956, events: ["Powis Castle gardens (1700s)", "Lake Vyrnwy dam (1880s)"], landmarks: ["Powis Castle", "Montgomery Castle", "Lake Vyrnwy"] },
        "Morayshire": { area: 476, population: 67654, events: ["Elgin Cathedral founded (1224)", "Glen Moray Distillery (1897)"], landmarks: ["Elgin Cathedral", "Pluscarden Abbey", "Duffus Castle"] },
        "Nairnshire": { area: 200, population: 13894, events: ["Cawdor Castle built (1300s)", "Nairn Golf Club founded (1887)"], landmarks: ["Cawdor Castle", "Nairn Museum", "Nairn Viaduct"] },
        "Norfolk": { area: 2057, population: 807721, events: ["Norwich Castle built (1067)", "Sandringham bought (1862)"], landmarks: ["Norwich Cathedral", "Sandringham House", "Holkham Hall"] },
        "Northamptonshire": { area: 998, population: 838786, events: ["Naseby Battle (1645)", "Silverstone Circuit opens (1948)"], landmarks: ["Althorp", "Rockingham Castle", "Silverstone"] },
        "Northumberland": { area: 2019, population: 797006, events: ["Hadrian’s Wall built (122 AD)", "Lindisfarne Priory (634)"], landmarks: ["Hadrian’s Wall", "Alnwick Castle", "Lindisfarne"] },
        "Nottinghamshire": { area: 843, population: 1096617, events: ["Sherwood Forest outlaws (1200s)", "Wollaton Hall built (1580s)"], landmarks: ["Sherwood Forest", "Nottingham Castle", "Wollaton Hall"] },
        "Orkney": { area: 376, population: 21349, events: ["Skara Brae settled (3100 BC)", "Scapa Flow scuttling (1919)"], landmarks: ["Skara Brae", "St Magnus Cathedral", "Ring of Brodgar"] },
        "Oxfordshire": { area: 754, population: 512345, events: ["Oxford University founded (1096)", "Mini car production (1959)"], landmarks: ["Oxford Colleges", "Blenheim Palace", "Christ Church Cathedral"] },
        "Peeblesshire": { area: 548, population: 19074, events: ["Traquair House oldest (1107)", "Dawyck Botanic Garden (1600s)"], landmarks: ["Traquair House", "Neidpath Castle", "Dawyck Botanic Garden"] },
        "Pembrokeshire": { area: 625, population: 122122, events: ["St Davids Cathedral (1181)", "Coast Path opens (1970)"], landmarks: ["St Davids Cathedral", "Pembroke Castle", "Skomer Island"] },
        "Perthshire": { area: 2493, population: 156371, events: ["Scone Palace: Stone of Destiny (800s)", "Tay Bridge collapse (1879)"], landmarks: ["Scone Palace", "Blair Castle", "Loch Tay"] },
        "Radnorshire": { area: 470, population: 25821, events: ["Offa’s Dyke (8th c.)", "Elan Valley dams (1893)"], landmarks: ["Elan Valley", "Radnor Forest", "Llandrindod Wells"] },
        "Renfrewshire": { area: 245, population: 508064, events: ["Paisley Abbey founded (1163)", "Coats Observatory opens (1883)"], landmarks: ["Paisley Abbey", "Coats Observatory", "Castle Semple"] },
        "Ross-shire": { area: 3089, population: 69503, events: ["Eilean Donan Castle (1200s)", "Beinn Eighe reserve (1951)"], landmarks: ["Eilean Donan Castle", "Inverewe Garden", "Loch Maree"] },
        "Roxburghshire": { area: 666, population: 50800, events: ["Kelso Abbey founded (1128)", "Hermitage Castle (1300s)"], landmarks: ["Floors Castle", "Kelso Abbey", "Hermitage Castle"] },
        "Rutland": { area: 152, population: 37677, events: ["Oakham Castle founded (1180)", "Rutland Water created (1976)"], landmarks: ["Rutland Water", "Oakham Castle", "Rockingham Castle"] },
        "Selkirkshire": { area: 267, population: 16010, events: ["Philiphaugh Battle (1645)", "Ettrick Forest royal (1100s)"], landmarks: ["Bowhill House", "Philiphaugh Battlefield", "Loch of the Lowes"] },
        "Shetland": { area: 551, population: 23167, events: ["Jarlshof settled (2500 BC)", "Mousa Broch (100 BC)"], landmarks: ["Jarlshof", "Shetland Museum", "Mousa Broch"] },
        "Shropshire": { area: 1342, population: 472027, events: ["Ironbridge built (1779)", "Ludlow Castle (1080s)"], landmarks: ["Ironbridge Gorge", "Shrewsbury Castle", "Ludlow Castle"] },
        "Somerset": { area: 1633, population: 1053504, events: ["Sedgemoor Battle (1685)", "Glastonbury Festival (1970)"], landmarks: ["Glastonbury Tor", "Wells Cathedral", "Cheddar Gorge"] },
        "Staffordshire": { area: 1176, population: 2159392, events: ["Wedgwood pottery (1759)", "Alton Towers opens (1980)"], landmarks: ["Lichfield Cathedral", "Alton Towers", "Trentham Estate"] },
        "Stirlingshire": { area: 447, population: 244092, events: ["Bannockburn Battle (1314)", "Wallace Monument (1869)"], landmarks: ["Stirling Castle", "Bannockburn", "Wallace Monument"] },
        "Suffolk": { area: 1505, population: 775099, events: ["Sutton Hoo burial (625 AD)", "Southwold Pier (1900)"], landmarks: ["Sutton Hoo", "Framlingham Castle", "Southwold Pier"] },
        "Surrey": { area: 759, population: 2975836, events: ["Magna Carta at Runnymede (1215)", "Brooklands racetrack (1907)"], landmarks: ["Runnymede", "Hampton Court", "Brooklands Museum"] },
        "Sussex": { area: 1466, population: 1612454, events: ["Battle of Hastings (1066)", "Brighton Pavilion (1815)"], landmarks: ["Battle Abbey", "Arundel Castle", "Brighton Pavilion"] },
        "Sutherland": { area: 2028, population: 12803, events: ["Highland Clearances (1810s)", "Cape Wrath lighthouse (1828)"], landmarks: ["Dunrobin Castle", "Cape Wrath", "Smoo Cave"] },
        "Tyrone": { area: 1260, population: 178440, events: ["Flight of the Earls (1607)", "Ulster Folk Park (1976)"], landmarks: ["Ulster American Folk Park", "Sperrin Mountains", "Beaghmore Stone Circles"] },
        "Warwickshire": { area: 918, population: 1632885, events: ["Shakespeare born (1564)", "Kenilworth Castle (1100s)"], landmarks: ["Stratford-upon-Avon", "Warwick Castle", "Kenilworth Castle"] },
        "West Lothian": { area: 120, population: 154830, events: ["Mary Queen born (1542)", "Shale oil boom (1850s)"], landmarks: ["Linlithgow Palace", "Blackness Castle", "Almond Valley"] },
        "Westmorland": { area: 785, population: 87466, events: ["Appleby Horse Fair (1100s)", "Levens Hall topiary (1694)"], landmarks: ["Kendal Castle", "Levens Hall", "Rydal Mount"] },
        "Wigtownshire": { area: 487, population: 26618, events: ["St Ninian at Whithorn (397 AD)", "Logan Botanic Garden (1869)"], landmarks: ["Logan Botanic Garden", "Mull of Galloway", "Whithorn Priory"] },
        "Wiltshire": { area: 1374, population: 682380, events: ["Stonehenge built (3000 BC)", "Salisbury Cathedral (1220)"], landmarks: ["Stonehenge", "Avebury", "Salisbury Cathedral"] },
        "Worcestershire": { area: 709, population: 1125037, events: ["Worcester Battle (1651)", "Malvern Hills (ancient)"], landmarks: ["Worcester Cathedral", "Malvern Hills", "Broadway Tower"] },
        "Yorkshire": { area: 6081, population: 5218838, events: ["York Minster founded (627)", "Castle Howard (1699)"], landmarks: ["York Minster", "Castle Howard", "Whitby Abbey"] }
      };

      const countyLanguages = {
        "Anglesey": { name: "Sir Fôn", lang: "Welsh" },
        "Brecknockshire": { name: "Sir Frycheiniog", lang: "Welsh" },
        "Caernarfonshire": { name: "Sir Gaernarfon", lang: "Welsh" },
        "Cardiganshire": { name: "Sir Aberteifi / Ceredigion", lang: "Welsh" },
        "Carmarthenshire": { name: "Sir Gaerfyrddin", lang: "Welsh" },
        "Denbighshire": { name: "Sir Ddinbych", lang: "Welsh" },
        "Flintshire": { name: "Sir y Fflint", lang: "Welsh" },
        "Glamorgan": { name: "Morgannwg", lang: "Welsh" },
        "Merionethshire": { name: "Meirionnydd", lang: "Welsh" },
        "Monmouthshire": { name: "Sir Fynwy", lang: "Welsh" },
        "Montgomeryshire": { name: "Sir Drefaldwyn", lang: "Welsh" },
        "Pembrokeshire": { name: "Sir Benfro", lang: "Welsh" },
        "Radnorshire": { name: "Sir Faesyfed", lang: "Welsh" },
        "Aberdeenshire": { name: "Siorrachd Obar Dheathain", lang: "Scottish Gaelic" },
        "Angus": { name: "Aonghas", lang: "Scottish Gaelic" },
        "Argyllshire": { name: "Siorrachd Earra-Ghàidheal", lang: "Scottish Gaelic" },
        "Ayrshire": { name: "Siorrachd Inbhir Àir", lang: "Scottish Gaelic" },
        "Banffshire": { name: "Siorrachd Bhanbh", lang: "Scottish Gaelic" },
        "Berwickshire": { name: "Siorrachd Bhearaig", lang: "Scottish Gaelic" },
        "Buteshire": { name: "Siorrachd Bhùth", lang: "Scottish Gaelic" },
        "Caithness": { name: "Gallaibh", lang: "Scottish Gaelic" },
        "Clackmannanshire": { name: "Siorrachd Chlach Mhanainn", lang: "Scottish Gaelic" },
        "Cromartyshire": { name: "Siorrachd Chròmbaidh", lang: "Scottish Gaelic" },
        "Dumfriesshire": { name: "Siorrachd Dhùn Phris", lang: "Scottish Gaelic" },
        "Dunbartonshire": { name: "Siorrachd Dhùn Bhreatainn", lang: "Scottish Gaelic" },
        "East Lothian": { name: "Siorrachd an Ear Leothain", lang: "Scottish Gaelic" },
        "Fife": { name: "Fìobha", lang: "Scottish Gaelic" },
        "Inverness-shire": { name: "Siorrachd Inbhir Nis", lang: "Scottish Gaelic" },
        "Kincardineshire": { name: "Siorrachd Chinn Chàrdainn", lang: "Scottish Gaelic" },
        "Kinross-shire": { name: "Siorrachd Cheann Rois", lang: "Scottish Gaelic" },
        "Kirkcudbrightshire": { name: "Siorrachd Chille Chuithbeirt", lang: "Scottish Gaelic" },
        "Lanarkshire": { name: "Siorrachd Lanraig", lang: "Scottish Gaelic" },
        "Midlothian": { name: "Meadhan Labhdaidh", lang: "Scottish Gaelic" },
        "Morayshire": { name: "Moireibh", lang: "Scottish Gaelic" },
        "Nairnshire": { name: "Siorrachd Inbhir Narann", lang: "Scottish Gaelic" },
        "Orkney": { name: "Arcaibh", lang: "Scottish Gaelic" },
        "Peeblesshire": { name: "Siorrachd nam Pùballan", lang: "Scottish Gaelic" },
        "Perthshire": { name: "Siorrachd Pheairt", lang: "Scottish Gaelic" },
        "Renfrewshire": { name: "Siorrachd Rinn Friù", lang: "Scottish Gaelic" },
        "Ross-shire": { name: "Siorrachd Rois", lang: "Scottish Gaelic" },
        "Roxburghshire": { name: "Siorrachd Rosbroig", lang: "Scottish Gaelic" },
        "Selkirkshire": { name: "Siorrachd Shailcirc", lang: "Scottish Gaelic" },
        "Shetland": { name: "Sealtainn", lang: "Scottish Gaelic" },
        "Stirlingshire": { name: "Siorrachd Shruighlea", lang: "Scottish Gaelic" },
        "Sutherland": { name: "Cataibh", lang: "Scottish Gaelic" },
        "West Lothian": { name: "Lothian an Iar", lang: "Scottish Gaelic" },
        "Wigtownshire": { name: "Siorrachd Bhaile na h-Ùige", lang: "Scottish Gaelic" },
        "Antrim": { name: "Aontroim", lang: "Irish Gaelic" },
        "Armagh": { name: "Árd Mhacha", lang: "Irish Gaelic" },
        "Down": { name: "An Dún", lang: "Irish Gaelic" },
        "Fermanagh": { name: "Fear Manach", lang: "Irish Gaelic" },
        "Londonderry": { name: "Doire", lang: "Irish Gaelic" },
        "Tyrone": { name: "Tír Eoghain", lang: "Irish Gaelic" }
      };

// Update card function
window.updateCountyCard = function(englishName, layer, lat, lon) {
  const details = countyData[englishName] || {};          // <-- fixed
  const langEntry = countyLanguages[englishName];
  const area = details.area || 0;                        // <-- fixed
  const pop = details.population || 0;                   // <-- fixed
  const density = area > 0 ? (pop / area).toFixed(1) : 'N/A';

  let badgeStyle = '';
  if (density > 1000) badgeStyle = 'background:#9B2C2C; color:white;';
  else if (density > 500) badgeStyle = 'background:#D32F2F; color:white;';
  else if (density > 200) badgeStyle = 'background:#FF7043; color:white;';
  else if (density > 100) badgeStyle = 'background:#FFB300; color:white;';
  else if (density > 50) badgeStyle = 'background:#8BC34A; color:white;';
  else badgeStyle = 'background:#66BB6A; color:white;';

  fetchWeather(lat, lon).then(weather => {
    const weatherBlock = weather ? `
      <div style="text-align:center; margin:14px 0 8px;">
        <div class="weather-underline" style="margin:0 auto 14px;"></div>
        <div class="weather-badge">
          ${weather.temp}°C • ${weather.desc} • Wind ${weather.wind} mph
        </div>
      </div>` : '';

    const flagUrl = countyFlags[englishName];
    const flagHTML = flagUrl ? `<img src="${flagUrl}" alt="${englishName} flag" class="flag" onerror="this.style.display='none'">` : '';

    const cardHTML = `
      <div class="county-card" style="margin-bottom:16px;">
        ${flagHTML}
        <div class="card-body">
          <h3>${englishName}</h3>
          ${langEntry ? `<p style="margin:6px 0; font-size:0.9rem; text-align:center;"><strong>${langEntry.lang}:</strong> ${langEntry.name}</p>` : ''}
          <div style="display:flex; justify-content:space-between; margin:12px 0; font-size:0.95rem;">
            <div><strong>Area:</strong> ${area.toLocaleString()} sq mi</div>
            <div><strong>Pop:</strong> ${pop.toLocaleString()}</div>
          </div>
          <div style="text-align:center; margin:12px 0;">
            <span style="${badgeStyle} padding:6px 16px; border-radius:20px; font-weight:600; font-size:0.9rem; display:inline-block; box-shadow:0 1px 3px rgba(0,0,0,0.2);">
              Density: ${density} people/sq mi
            </span>
          </div>

          ${details.events?.length ? `
            <div style="margin:14px 0 8px;">
              <h4 style="margin:0 0 6px; color:var(--accent); font-size:1rem; text-align:left; border-bottom:1px solid #eee; padding-bottom:4px;">Key Events</h4>
              <ul style="margin:6px 0; padding-left:20px; font-size:0.88rem; line-height:1.5; text-align:left;">
                ${details.events.map(e => `<li>${e}</li>`).join('')}
              </ul>
            </div>` : ''}

          ${details.landmarks?.length ? `
            <div style="margin:14px 0 8px;">
              <h4 style="margin:0 0 6px; color:var(--accent); font-size:1rem; text-align:left; border-bottom:1px solid #eee; padding-bottom:4px;">Notable Landmarks</h4>
              <ul style="margin:6px 0; padding-left:20px; font-size:0.88rem; line-height:1.5; text-align:left;">
                ${details.landmarks.map(l => `
                  <li onmouseover="showPhoto('${l}', event)" onmouseout="hidePhoto()" style="cursor:pointer; color:#0066cc; text-decoration:underline;">
                    ${l}
                  </li>`).join('')}
              </ul>
            </div>` : ''}

          ${details.notablePersons?.length ? `
            <div style="margin:14px 0 8px;">
              <h4 style="margin:0 0 6px; color:var(--accent); font-size:1rem; text-align:left; border-bottom:1px solid #eee; padding-bottom:4px;">Notable Persons</h4>
              <ul style="margin:6px 0; padding-left:20px; font-size:0.88rem; line-height:1.5; text-align:left;">
                ${details.notablePersons.slice(0, 3).map(p => `<li>${p}</li>`).join('')}
              </ul>
            </div>` : ''}

          ${weatherBlock}
        </div>
      </div>`;

    infoDiv.innerHTML = cardHTML;
    infoDiv.scrollTop = 0;
  });

  // Highlight selected county
  if (currentLayer) currentLayer.setStyle({ weight: 1, fillOpacity: 0.35 });
  layer.setStyle({ weight: 3, fillOpacity: 0.6 });
  currentLayer = layer;
};
      const pastelColors = ["#ffdede","#dedefd","#deffde","#fff0de","#fdefff","#dfffee","#ffe7de","#f0deff","#defff5","#fdeeee","#e6f7ff","#f9ffe6","#fff6e6","#e6e6ff","#ffe6f2"];
      data.features.forEach((f, i) => f.properties.color = pastelColors[i % pastelColors.length]);

      L.geoJSON(data, {
        style: f => ({ color: "#333", weight: 1, fillColor: f.properties.color, fillOpacity: 0.35 }),
        onEachFeature: (feature, layer) => {
          const englishName = feature.properties.NAME;
          const details = countyData[englishName] || {};
          const langEntry = countyLanguages[englishName];
          const density = details.area > 0 ? Math.round(details.population / details.area) : '?';
          const centroid = turf.centroid(feature);
          const lat = centroid.geometry.coordinates[1];
          const lon = centroid.geometry.coordinates[0];

          layer.bindTooltip(`
            <div style="text-align:center; font-weight:bold; font-size:0.95rem;">
              ${englishName}<br>
              ${langEntry ? `<small>${langEntry.lang}: ${langEntry.name}</small><br>` : ''}
              <small style="color:#555;">${density} people/sq mi</small>
            </div>
          `, { direction: 'center', className: 'county-tooltip' });

          layer.on('click', () => {
            layer._cardLayer = layer; // Bind layer to card
            window.updateCountyCard(englishName, layer, lat, lon);
            if (window.innerWidth <= 1024) sidebar.classList.add('visible');
            map.fitBounds(layer.getBounds());
          });

          layer.on('mouseover', () => layer.setStyle({ weight: 2 }));
          layer.on('mouseout', () => layer.setStyle({ weight: 1 }));
        }
      }).addTo(map);

      // Fix map size after load
      setTimeout(() => map.invalidateSize(), 300);
      infoDiv.innerHTML = '<em>Click a county to explore.</em>';
    })
    .catch(err => {
      console.error(err);
      infoDiv.innerHTML = '<em style="color:red;">Failed to load map data. Check console.</em>';
    });

  // Search & Geocoder
  L.Control.geocoder({ defaultMarkGeocode: true, placeholder: 'Search town, village, postcode…' }).addTo(map);
  window.places = []; let fuse = null; let searchMarker = null;

  function parseCSVLine(line) {
    const cols = []; const regex = /(?:\"([^\"]*)\"|([^,]+))/g; let m;
    while ((m = regex.exec(line)) !== null) cols.push(m[1] || m[2] || '');
    return cols;
  }

  function initFuse() { if (window.places.length) fuse = new Fuse(window.places, { keys: ['name', 'county'], threshold: 0.3 }); }

  function showDropdown(results) {
    searchDropdown.innerHTML = '';
    if (!results.length) { searchDropdown.style.display = 'none'; return; }
    results.slice(0, 10).forEach(r => {
      const div = document.createElement('div');
      div.style.cssText = 'padding:8px 12px; cursor:pointer; border-bottom:1px solid #eee; font-size:0.9rem;';
      div.textContent = `${r.item.name}, ${r.item.county || ''}`;
      div.onmouseover = () => div.style.backgroundColor = '#f5f5f5';
      div.onmouseout = () => div.style.backgroundColor = '';
      div.onclick = () => selectPlace(r.item);
      searchDropdown.appendChild(div);
    });
    searchDropdown.style.display = 'block';
  }

  function selectPlace(place) {
    if (searchMarker) map.removeLayer(searchMarker);
    searchMarker = L.marker([place.lat, place.lon]).addTo(map).bindPopup(`<b>${place.name}</b><br>${place.county}`).openPopup();
    map.setView([place.lat, place.lon], 11);
    searchDropdown.style.display = 'none';
    searchInput.value = place.name;
    setTimeout(() => showCountyFromPoint(place.lat, place.lon), 500);
  }

  function showCountyFromPoint(lat, lon) {
    const point = turf.point([lon, lat]);
    let found = null;
    map.eachLayer(l => {
      if (l instanceof L.GeoJSON) {
        l.eachLayer(cl => {
          if (cl.getBounds && cl.getBounds().contains([lat, lon]) && turf.booleanPointInPolygon(point, cl.feature)) {
            found = cl;
          }
        });
      }
    });
    if (found) {
      const englishName = found.feature.properties.NAME;
      const centroid = turf.centroid(found.feature);
      window.updateCountyCard(englishName, found, centroid.geometry.coordinates[1], centroid.geometry.coordinates[0]);
      if (window.innerWidth <= 1024) sidebar.classList.add('visible');
    } else {
      infoDiv.innerHTML = '<em>County not found.</em>';
    }
  }

  fetch('places_clean.csv')
    .then(r => r.text())
    .then(text => {
      const lines = text.trim().split('\n'); lines.shift();
      lines.forEach(line => {
        const c = parseCSVLine(line);
        const name = c[0], desc = c[2], county = c[3], lat = parseFloat(c[6]), lon = parseFloat(c[7]);
        if ((desc === 'LOC' || desc === 'PAR') && name && !isNaN(lat) && !isNaN(lon)) {
          window.places.push({ name, county, lat, lon });
        }
      });
      initFuse();
    });

  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim();
    if (!q || !fuse) { searchDropdown.style.display = 'none'; return; }
    showDropdown(fuse.search(q));
  });

  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && fuse) {
      const res = fuse.search(searchInput.value.trim());
      if (res.length) selectPlace(res[0].item);
    }
  });

  document.addEventListener('click', e => {
    if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
      searchDropdown.style.display = 'none';
    }
  });
};
</script>
</body>
</html>
