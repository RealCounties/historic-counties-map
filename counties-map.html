<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Historic Counties Interactive Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
#container { display: flex; height: 100%; }
#sidebar { width: 340px; background: #f7f7f7; padding: 15px; overflow-y: auto; border-right: 1px solid #ccc; }
#map { flex: 1; }

.county-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.county-card h3 { margin-top: 0; color: #333; }
.county-card p { margin: 4px 0; }
.county-card a { color: #0066cc; text-decoration: none; }
.county-card a:hover { text-decoration: underline; }
</style>
</head>
<body>

<div id="container">
  <div id="sidebar">
    <h2>Historic Counties</h2>
    <p>Select a county to view details.</p>
    <div id="info"><em>No county selected.</em></div>
  </div>
  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
// Initialize map
console.log("Script is running");
var map = L.map('map', { center: [54.5, -3], zoom: 6, minZoom: 5 });
console.log('Map initialized');

// Base OSM map
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
  maxZoom: 19
}).addTo(map);
console.log('OSM tiles added');

// Restrict map to British Isles
var ukBounds = L.latLngBounds([49.5, -8.5], [60.9, 2.0]);
map.setMaxBounds(ukBounds);
map.fitBounds(ukBounds);

// Sidebar element
var infoDiv = document.getElementById('info');

// Predefined county colors (explicit + fallback palette)
var countyColours = {
  "Yorkshire": "#e6194b",
  "Lancashire": "#3cb44b",
  "Cheshire": "#ffe119",
  "Cornwall": "#4363d8",
  "Kent": "#f58231",
  "Middlesex": "#911eb4",
  "Cumberland": "#46f0f0",
  "Westmorland": "#f032e6"
};
var fallbackColours = [
  "#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
  "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
  "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"
];
var fallbackIndex = 0;

// County data placeholder
var countyData = {
  "Yorkshire": { area: "3,900 sq mi", population: "5.4 million", link: "https://realcounties.com/yorkshire" },
  "Lancashire": { area: "1,200 sq mi", population: "1.5 million", link: "https://realcounties.com/lancashire" },
  "Cheshire": { area: "900 sq mi", population: "1 million", link: "https://realcounties.com/cheshire" },
  "Cornwall": { area: "1,375 sq mi", population: "570,000", link: "https://realcounties.com/cornwall" },
  "Kent": { area: "1,442 sq mi", population: "1.8 million", link: "https://realcounties.com/kent" },
  "Middlesex": { area: "284 sq mi", population: "2.5 million", link: "https://realcounties.com/middlesex" },
  "Cumberland": { area: "1,530 sq mi", population: "490,000", link: "https://realcounties.com/cumberland" },
  "Westmorland": { area: "784 sq mi", population: "220,000", link: "https://realcounties.com/westmorland" }
};

// Load GeoJSON
fetch('./counties_simplified8.json')
  .then(res => {
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    return res.json();
  })
  .then(data => {
    console.log('GeoJSON loaded:', data.features.length);

    // Assign fallback colors to counties not explicitly listed
    data.features.forEach(feature => {
      var name = feature.properties.NAME;
      if (!countyColours[name]) {
        countyColours[name] = fallbackColours[fallbackIndex % fallbackColours.length];
        fallbackIndex++;
      }
    });

    var geoJsonLayer = L.geoJSON(data, { 
      filter: feature => feature.geometry && feature.geometry.coordinates && feature.geometry.coordinates.length > 0,
      style: feature => {
        var name = feature.properties.NAME;
        return { 
          color: "#333", 
          weight: 1, 
          fillColor: countyColours[name] || "#cccccc", 
          fillOpacity: 0.5,
          fillRule: 'evenodd'
        };
      },
      onEachFeature: function(feature, layer) {
        layer.on('click', function() {
          var name = feature.properties.NAME;
          var details = countyData[name];
          infoDiv.innerHTML = `<div class="county-card">
            <h3>${name}</h3>
            <p><strong>Area:</strong> ${details?.area || 'Unknown'}</p>
            <p><strong>Population:</strong> ${details?.population || 'Unknown'}</p>
            ${details?.link ? `<p><a href="${details.link}" target="_blank">More about ${name}</a></p>` : ''}
          </div>`;
          try { map.fitBounds(layer.getBounds()); } catch (e) { console.error(e); }
        });

        // Hover effects
        layer.on('mouseover', function(){
          layer.setStyle({ weight: 3, color: '#000', fillOpacity: 0.7 });
        });
        layer.on('mouseout', function(){
          layer.setStyle({ weight: 1, color: '#333', fillOpacity: 0.5 });
        });

        layer.bindPopup(feature.properties.NAME);
      }
    }).addTo(map);

    if (geoJsonLayer.getBounds().isValid()) map.fitBounds(geoJsonLayer.getBounds());
    setTimeout(() => map.invalidateSize(), 100);
    console.log('GeoJSON layer added');
  })
  .catch(err => console.error('GeoJSON error:', err));

// Add search control
L.Control.geocoder({
  defaultMarkGeocode: true,
  placeholder: 'Search town, village, postcodeâ€¦',
  geocoder: new L.Control.Geocoder.Nominatim(),
  inputId: 'geocoder-input'
}).addTo(map);
console.log('Geocoder added');
</script>
</body>
</html>
